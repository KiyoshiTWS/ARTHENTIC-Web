<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5, user-scalable=yes" />
    <title>ArtHub - Community Feed</title>
    <link rel="icon" type="image/png" href="smalllogo.png" />
    <link href="css/bootstrap.min.css" rel="stylesheet" />
    <link href="css/bootstrap-icons.css" rel="stylesheet" />
    <link href="css/tooplate-tween-agency.css" rel="stylesheet" />

    <!-- ReCAPTCHA v3 -->
    <script src="https://www.google.com/recaptcha/api.js?render=6LdvxdgrAAAAAIcCXPLCipQV819ARwiuwys2fiq2" async defer></script>
    <style>
      body {
        font-family: "Poppins", sans-serif;
        background: #f5f6f8;
      }
      body.dark-mode {
        background: #181a1b !important;
        color: #e0e0e0 !important;
      }
      body.dark-mode .text-muted {
        color: #b0b0b0 !important;
      }
      body.dark-mode .post-footer {
        color: #e0e0e0 !important;
      }
      body.dark-mode .icon-btn {
        color: white !important;
        border-radius: 20px !important;
        border: 1px solid rgba(255, 255, 255, 0.2) !important;
      }
      body.dark-mode .icon-btn:hover {
        background: rgba(255, 255, 255, 0.1) !important;
      }
      body.dark-mode .icon-btn.liked {
        background: #3498db !important;
        border-radius: 20px !important;
      }
      body.dark-mode #darkModeToggle {
        color: #5dade2 !important;
        border-color: #5dade2 !important;
        position: relative;
        opacity: 1 !important;
        background: rgba(93, 173, 226, 0.1) !important;
      }
      body.dark-mode #notificationsBtn {
        color: #5dade2 !important;
        border-color: #5dade2 !important;
        position: relative;
        opacity: 1 !important;
        background: rgba(93, 173, 226, 0.1) !important;
      }
      body.dark-mode #notificationsBtn i {
        color: #5dade2 !important;
        z-index: 2;
        position: relative;
        opacity: 1 !important;
      }
      body.dark-mode #darkModeToggle i {
        color: #5dade2 !important;
        z-index: 2;
        position: relative;
        opacity: 1 !important;
      }
      
      /* Dark mode hover colors to black */
      body.dark-mode #notificationsBtn:hover {
        background-color: rgba(0, 0, 0, 0.3) !important;
        border-color: #333 !important;
        color: #333 !important;
        opacity: 1 !important;
      }
      body.dark-mode #notificationsBtn:hover i {
        color: #333 !important;
        opacity: 1 !important;
      }
      body.dark-mode #darkModeToggle:hover {
        background-color: rgba(0, 0, 0, 0.3) !important;
        border-color: #333 !important;
        color: #333 !important;
        opacity: 1 !important;
      }
      body.dark-mode #darkModeToggle:hover i {
        color: #333 !important;
        opacity: 1 !important;
      }
      /* Preserve protect button original styling */
      .custom-btn {
        background: #dc3545 !important;
        border-color: #dc3545 !important;
        color: white !important;
      }
      
      .custom-btn:hover {
        background: #c82333 !important;
        border-color: #c82333 !important;
        color: white !important;
      }
      
      body.dark-mode .custom-btn {
        background: #dc3545 !important;
        border-color: #dc3545 !important;
        color: white !important;
      }
      
      body.dark-mode .custom-btn:hover {
        background: #c82333 !important;
        border-color: #c82333 !important;
        color: white !important;
      }
      
      /* Notification badge styling (Discord-like) */
      .notification-badge {
        position: absolute;
        top: -8px;
        right: -8px;
        background: #e74c3c;
        color: white;
        font-size: 11px;
        font-weight: 600;
        padding: 2px 6px;
        border-radius: 10px;
        min-width: 18px;
        height: 18px;
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 3;
        border: 2px solid #fff;
        box-shadow: 0 2px 4px rgba(0,0,0,0.2);
      }
      
      body.dark-mode .notification-badge {
        border-color: #23272b;
      }
      
      /* NSFW Toggle Styling */
      .nsfw-toggle {
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        margin-bottom: 1rem;
      }
      
      .nsfw-arrow {
        background: transparent;
        border: 1px solid #dee2e6;
        border-radius: 4px;
        padding: 0.25rem 0.4rem;
        cursor: pointer;
        font-size: 0.8rem;
        color: #6c757d;
        transition: all 0.2s ease;
      }
      
      .nsfw-arrow:hover {
        background: #f8f9fa;
        border-color: #adb5bd;
      }
      
      .nsfw-arrow.expanded {
        transform: rotate(90deg);
      }
      
      .nsfw-checkbox-container {
        display: none;
        align-items: center;
        gap: 0.5rem;
        opacity: 0;
        transition: opacity 0.3s ease;
      }
      
      .nsfw-checkbox-container.show {
        display: flex;
        opacity: 1;
      }
      
      body.dark-mode .nsfw-arrow {
        border-color: #6c757d;
        color: #adb5bd;
      }
      
      body.dark-mode .nsfw-arrow:hover {
        background: #343a40;
        border-color: #adb5bd;
      }
      
      /* Image Editor Modal Light Mode Support */
      .image-editor-modal {
        background-color: white !important;
        color: black !important;
      }

      .image-editor-modal .modal-header {
        background-color: white !important;
        border-bottom-color: #dee2e6 !important;
        color: black !important;
      }

      .image-editor-modal .modal-body {
        background-color: white !important;
        color: black !important;
      }

      .image-editor-modal .modal-footer {
        background-color: white !important;
        border-top-color: #dee2e6 !important;
      }

      .image-editor-modal .modal-title {
        color: black !important;
      }

      .image-editor-container {
        background: #f8f9fa !important;
        border-color: #dee2e6 !important;
      }

      .image-editor-controls {
        background-color: white !important;
        border-color: #dee2e6 !important;
      }

      .image-editor-controls .card-header {
        background-color: #e9ecef !important;
        border-bottom-color: #dee2e6 !important;
        color: black !important;
      }

      .image-editor-controls .card-body {
        background-color: white !important;
        color: black !important;
      }

      /* Dark mode specific styles for image editor */
      body.dark-mode .image-editor-modal {
        background-color: #23272b !important;
        color: #fff !important;
      }

      body.dark-mode .image-editor-modal .modal-header {
        background-color: #23272b !important;
        border-bottom-color: #495057 !important;
        color: #fff !important;
      }

      body.dark-mode .image-editor-modal .modal-body {
        background-color: #23272b !important;
        color: #fff !important;
      }

      body.dark-mode .image-editor-modal .modal-footer {
        background-color: #23272b !important;
        border-top-color: #495057 !important;
      }

      body.dark-mode .image-editor-modal .modal-title {
        color: #fff !important;
      }

      body.dark-mode .image-editor-container {
        background: #343a40 !important;
        border-color: #495057 !important;
      }

      body.dark-mode .image-editor-controls {
        background-color: #23272b !important;
        border-color: #495057 !important;
      }

      body.dark-mode .image-editor-controls .card-header {
        background-color: #343a40 !important;
        border-bottom-color: #495057 !important;
        color: #fff !important;
      }

      body.dark-mode .image-editor-controls .card-body {
        background-color: #23272b !important;
        color: #fff !important;
      }

      /* Image editor button styling - Light Mode */
      .image-editor-controls .btn-outline-secondary {
        border-color: #6c757d !important;
        color: #6c757d !important;
        background-color: transparent !important;
      }

      .image-editor-controls .btn-outline-secondary:hover {
        background-color: #6c757d !important;
        border-color: #6c757d !important;
        color: white !important;
      }

      .image-editor-controls .btn-outline-secondary:focus {
        background-color: #6c757d !important;
        border-color: #6c757d !important;
        color: white !important;
        box-shadow: 0 0 0 0.2rem rgba(108, 117, 125, 0.25) !important;
      }

      .image-editor-controls .text-muted {
        color: #6c757d !important;
      }

      .image-editor-controls .form-label {
        color: black !important;
        font-weight: 500;
      }

      /* Dark mode overrides */
      body.dark-mode .image-editor-controls .btn-outline-secondary {
        border-color: #adb5bd !important;
        color: #adb5bd !important;
        background-color: transparent !important;
      }

      body.dark-mode .image-editor-controls .btn-outline-secondary:hover {
        background-color: #495057 !important;
        border-color: #adb5bd !important;
        color: white !important;
      }

      body.dark-mode .image-editor-controls .btn-outline-secondary:focus {
        background-color: #495057 !important;
        border-color: #adb5bd !important;
        color: white !important;
        box-shadow: 0 0 0 0.2rem rgba(173, 181, 189, 0.25) !important;
      }

      body.dark-mode .image-editor-controls .text-muted {
        color: #adb5bd !important;
      }

      body.dark-mode .image-editor-controls .form-label {
        color: #fff !important;
      }
      
      /* Ensure header icons are always visible */
      #notificationsBtn {
        color: #3498db !important;
        border-color: #3498db !important;
        position: relative;
        opacity: 1 !important;
      }
      #notificationsBtn i {
        color: #3498db !important;
        z-index: 2;
        position: relative;
        opacity: 1 !important;
      }
      #darkModeToggle {
        color: #3498db !important;
        border-color: #3498db !important;
        position: relative;
        opacity: 1 !important;
      }
      #darkModeToggle i {
        color: #3498db !important;
        z-index: 2;
        position: relative;
        opacity: 1 !important;
      }
      
      /* Fix hover colors to black */
      #notificationsBtn:hover {
        background-color: rgba(0, 0, 0, 0.1) !important;
        border-color: #000 !important;
        color: #000 !important;
        opacity: 1 !important;
      }
      #notificationsBtn:hover i {
        color: #000 !important;
        opacity: 1 !important;
      }
      #darkModeToggle:hover {
        background-color: rgba(0, 0, 0, 0.1) !important;
        border-color: #000 !important;
        color: #000 !important;
        opacity: 1 !important;
      }
      #darkModeToggle:hover i {
        color: #000 !important;
        opacity: 1 !important;
      }

      /* Mobile Touch Interactions */
      @media (hover: none) and (pointer: coarse) {
        .icon-btn:active,
        .post-stats:active {
          background: rgba(0, 123, 255, 0.1) !important;
          transform: scale(0.98);
        }
        
        .like-btn:active {
          background: rgba(220, 53, 69, 0.1) !important;
        }
        
        .comment-btn:active {
          background: rgba(40, 167, 69, 0.1) !important;
        }
        
        /* Remove hover effects on touch devices */
        .icon-btn:hover,
        .post-stats:hover,
        .nav-link:hover {
          background: transparent !important;
        }
      }
      
      /* Post Stats Styling */
      .post-stats {
        transition: all 0.3s ease;
      }
      .post-stats:hover {
        background: rgba(0, 0, 0, 0.05) !important;
      }
      body.dark-mode .post-stats {
        background: rgba(255, 255, 255, 0.05) !important;
        color: #b0b0b0 !important;
      }
      body.dark-mode .post-stats:hover {
        background: rgba(255, 255, 255, 0.1) !important;
      }
      
      /* Mobile dark mode optimizations */
      @media (max-width: 768px) {
        body.dark-mode {
          background: #1a1a1a;
        }
        
        body.dark-mode .main-header {
          background: rgba(26, 26, 26, 0.95);
        }
        
        body.dark-mode .post-card {
          background: #2d2d2d;
          border: 1px solid #404040;
        }
        
        body.dark-mode .form-control,
        body.dark-mode .form-select {
          background: #2d2d2d;
          border-color: #404040;
          color: #ffffff;
        }
        
        body.dark-mode .modal-content {
          background: #2d2d2d;
          border: 1px solid #404040;
        }
      }
      .stats-item {
        display: inline-flex;
        align-items: center;
        white-space: nowrap;
      }
      .engagement-rate {
        font-style: italic;
      }

      /* Facebook-style count badges */
      .count-badge {
        background: #e4e6ea;
        color: #65676b;
        font-size: 0.75rem;
        font-weight: 600;
        padding: 2px 6px;
        border-radius: 12px;
        margin-left: 4px;
        display: inline-block;
        min-width: 20px;
        text-align: center;
      }

      body.dark-mode .count-badge {
        background: #3a3b3c;
        color: #b0b3b8;
      }

      .icon-btn.liked .count-badge {
        background: #3498db;
        color: white;
      }
      body.dark-mode .text-muted {
        color: #b0b0b0 !important;
      }
      body.dark-mode .post-footer {
        color: #e0e0e0 !important;
      }
      body.dark-mode .icon-btn {
        color: white !important;
        border-radius: 20px !important;
        border: 1px solid rgba(255, 255, 255, 0.2) !important;
      }
      body.dark-mode .icon-btn:hover {
        background: rgba(255, 255, 255, 0.1) !important;
      }
      body.dark-mode .icon-btn.liked {
        background: #3498db !important;
        border-radius: 20px !important;
      }
      .navbar {
        background: var(--white-color, #ffffff) !important;
        border-bottom: 1px solid rgba(0, 0, 0, 0.1);
        padding-top: 15px;
        padding-bottom: 15px;
        transition: background 0.3s ease-out;
        box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
      }
      .sticky-nav {
        background: var(--white-color, #ffffff) !important;
        box-shadow: 0 1rem 3rem rgba(0, 0, 0, 0.175) !important;
      }
      .sticky-nav .navbar-brand {
        color: var(--dark-color, #000000);
      }
      .sticky-nav .navbar-nav .nav-link {
        color: var(--p-color, #717275);
      }
      .navbar-brand {
        color: var(--dark-color, #000000);
      }
      .navbar-nav .nav-link {
        color: var(--p-color, #717275);
      }
      body.dark-mode .navbar {
        background: #23272b !important;
      }
      body.dark-mode .sticky-nav {
        background: #23272b !important;
        box-shadow: 0 1rem 3rem rgba(0, 0, 0, 0.4) !important;
      }
      /* Base cards */
      .create-card,
      .post-card {
        background: #fff;
        border-radius: 18px;
        box-shadow: 0 4px 24px rgba(0, 0, 0, 0.06);
        padding: 1.25rem 1.5rem;
        margin-bottom: 1.5rem;
        position: relative;
      }
      body.dark-mode .create-card,
      body.dark-mode .post-card {
        background: #23272b;
        box-shadow: 0 4px 28px rgba(0, 0, 0, 0.4);
      }
      
      /* Enhanced Loading Progress Bar */
      .loading-progress-container {
        max-width: 300px;
        margin: 0 auto;
      }
      
      .loading-progress-bar {
        width: 100%;
        height: 8px;
        background: #f0f0f0;
        border-radius: 4px;
        overflow: hidden;
        position: relative;
      }
      
      .loading-progress-fill {
        height: 100%;
        width: 0%;
        background: linear-gradient(90deg, #3498db 0%, #5dade2 50%, #85c1e9 100%);
        border-radius: 4px;
        transition: width 0.3s ease;
        position: relative;
      }
      
      .loading-progress-fill::after {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(255,255,255,0.5), transparent);
        animation: loading-shimmer 2s infinite;
      }
      
      @keyframes loading-shimmer {
        0% { left: -100%; }
        100% { left: 100%; }
      }
      
      .loading-percentage {
        font-weight: 500;
        color: #6c757d;
      }
      
      /* Heart pulse animation for comment likes */
      @keyframes heartPulse {
        0% { transform: scale(1); }
        50% { transform: scale(1.2); }
        100% { transform: scale(1); }
      }
      
      /* Enhanced comment interactions */
      .comment-like-btn {
        transition: all 0.2s ease;
        border-radius: 12px;
        padding: 2px 6px;
      }
      
      .comment-like-btn:hover {
        background: rgba(0,0,0,0.05);
        text-decoration: none;
      }
      
      .comment-like-btn.liked {
        color: #3498db !important;
      }
      
      .quick-comment-btn {
        transition: all 0.2s ease;
      }
      
      .quick-comment-btn:hover {
        transform: scale(1.05);
      }
      
      .add-comment-inline {
        background: rgba(248,249,250,0.5);
        border-radius: 12px;
        border: 1px solid rgba(0,123,255,0.1);
      }
      .create-card textarea {
        border-radius: 14px;
        resize: vertical;
      }
      .create-actions {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-top: 0.75rem;
      }
      .btn-brand {
        background: #3498db !important;
        color: #fff !important;
        border: none;
        border-radius: 30px;
        font-weight: 600;
        padding: 0.55rem 1.35rem;
      }
      .btn-brand-outline {
        background: transparent;
        border: 2px solid #3498db;
        color: #3498db;
        border-radius: 30px;
        font-weight: 600;
        padding: 0.45rem 1.15rem;
      }
      body.dark-mode .btn-brand-outline {
        color: #5dade2;
        border-color: #5dade2;
      }
      .post-header {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        margin-bottom: 0.75rem;
      }
      .avatar {
        width: 48px;
        height: 48px;
        border-radius: 50%;
        object-fit: cover;
        background: #ddd;
      }
      .post-meta small {
        display: block;
        line-height: 1.1;
      }
      .post-image-wrapper {
        position: relative;
        border-radius: 16px;
        overflow: hidden;
        background: #000;
        cursor: pointer;
      }
      .post-image {
        width: 100%;
        display: block;
        object-fit: cover;
        transition: transform 0.5s;
      }
      .post-image-wrapper:hover .post-image {
        transform: scale(1.04);
      }
      
      /* Mobile image optimizations */
      @media (max-width: 768px) {
        .post-image-wrapper {
          border-radius: 8px;
        }
        
        .post-image:active {
          transform: scale(0.98);
        }
        
        /* Mobile avatar sizes */
        .avatar {
          border-radius: 50%;
        }
        
        .user-avatar-comment {
          width: 24px !important;
          height: 24px !important;
        }
        
        /* Mobile image preview */
        #imagePreview {
          max-height: 200px;
          border-radius: 8px;
        }
        
        /* Optimize touch interaction on mobile */
        .post-image-wrapper:active .post-image {
          transform: scale(0.98);
        }
      }
      .context-panel {
        background: #f1f3f5;
        border-radius: 14px;
        padding: 0.75rem 1rem;
        font-size: 0.85rem;
        margin-top: 0.85rem;
        display: none;
        position: relative;
      }
      body.dark-mode .context-panel {
        background: #2e3338;
      }
      .context-panel h6 {
        font-size: 0.75rem;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        margin: 0 0 0.4rem;
        color: #3498db;
      }
      .toggle-context {
        font-size: 0.75rem;
        font-weight: 600;
        cursor: pointer;
        color: #3498db;
        user-select: none;
      }
      body.dark-mode .toggle-context {
        color: #5dade2;
      }
      .context-add-box {
        background: #f8f9fa;
        border: 1px solid #e1e5e8;
        border-radius: 12px;
        padding: 0.6rem 0.7rem;
        margin-top: 0.6rem;
      }
      body.dark-mode .context-add-box {
        background: #2e3338;
        border-color: #444;
      }
      .post-footer {
        display: flex;
        gap: 1rem;
        margin-top: 0.65rem;
      }
      .icon-btn {
        background: transparent;
        border: none;
        color: #666;
        display: flex;
        align-items: center;
        gap: 0.35rem;
        font-size: 0.9rem;
        font-weight: 500;
      }
      .icon-btn i {
        font-size: 1.05rem;
      }
      .icon-btn:hover {
        color: #3498db;
      }
      body.dark-mode .icon-btn {
        color: #aaa;
      }
      body.dark-mode .icon-btn:hover {
        color: #5dade2;
      }
      /* Modal (lightbox) */
      .lightbox-backdrop {
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.8);
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 1050;
      }
      .lightbox-backdrop.active {
        display: flex;
      }
      .lightbox-content {
        max-width: 90vw;
        max-height: 85vh;
        position: relative;
        animation: fadeIn 0.3s ease;
      }
      .lightbox-content img {
        max-width: 100%;
        max-height: 85vh;
        object-fit: contain;
        display: block;
        border-radius: 12px;
      }
      .lightbox-close {
        position: absolute;
        top: -40px;
        right: 0;
        background: #3498db;
        color: #fff;
        border: none;
        width: 38px;
        height: 38px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.2rem;
        cursor: pointer;
      }
      .lightbox-caption {
        color: #fff;
        font-size: 0.9rem;
        margin-top: 0.5rem;
        text-align: center;
      }
      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: scale(0.96);
        }
        to {
          opacity: 1;
          transform: scale(1);
        }
      }
      /* Reader context indicator */
      .context-indicator {
        color: #3498db;
        font-size: 0.65rem;
        font-weight: 700;
        letter-spacing: 0.5px;
        padding: 0.25rem 0.5rem;
        background: #e3f2fd;
        border-radius: 20px;
      }
      body.dark-mode .context-indicator {
        background: #1e3a5f;
        color: #85c1e9;
      }
      /* Enhanced Mobile Navigation */
      .fab-new {
        position: fixed;
        bottom: 80px;
        right: 20px;
        background: #3498db;
        color: #fff;
        width: 54px;
        height: 54px;
        border: none;
        box-shadow: 0 6px 18px rgba(0, 0, 0, 0.25);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.6rem;
        z-index: 1040;
        border-radius: 50%;
        transition: all 0.3s ease;
      }
      .fab-new:hover {
        background: #2980b9;
        transform: scale(1.05);
      }
      .fab-new:active {
        transform: scale(0.95);
      }
      @media (min-width: 992px) {
        .fab-new {
          display: none;
        }
      }
      
      /* Mobile Touch Interactions */
      @media (hover: none) and (pointer: coarse) {
        .icon-btn:active,
        .post-stats:active {
          background: rgba(0, 123, 255, 0.1) !important;
          transform: scale(0.98);
        }
        
        .like-btn:active {
          background: rgba(220, 53, 69, 0.1) !important;
        }
        
        .comment-btn:active {
          background: rgba(40, 167, 69, 0.1) !important;
        }
        
        /* Remove hover effects on touch devices */
        .icon-btn:hover,
        .post-stats:hover,
        .nav-link:hover {
          background: transparent !important;
        }
      }
      
      /* Mobile header improvements */
      @media (max-width: 768px) {
        .main-header {
          position: sticky;
          top: 0;
          z-index: 1000;
          background: rgba(255, 255, 255, 0.95);
          backdrop-filter: blur(10px);
          border-bottom: 1px solid rgba(0,0,0,0.1);
        }
        
        body.dark-mode .main-header {
          background: rgba(35, 39, 43, 0.95);
          border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        
        .navbar-brand {
          font-size: 1.1rem;
        }
      }
      body.dark-mode .create-card textarea,
      body.dark-mode .form-control {
        background: #2e3338;
        color: #e0e0e0;
        border-color: #444;
      }

      /* HUB LAYOUT */
      .hub-layout {
        max-width: 1500px;
        margin: 7rem auto 3rem;
        padding: 0 1.5rem;
        display: flex;
        gap: 2rem;
      }
      .sidebar-left,
      .sidebar-right {
        width: 250px;
        flex-shrink: 0;
        position: sticky;
        top: 90px;
        align-self: flex-start;
        max-height: calc(100vh - 120px);
        overflow-y: auto;
        overflow-x: hidden;
        padding-right: 5px; /* Add space for scrollbar */
      }
      .sidebar-right {
        width: 270px;
      }

      /* Custom scrollbar styling for sidebar */
      .sidebar-left::-webkit-scrollbar,
      .sidebar-right::-webkit-scrollbar {
        width: 6px;
      }

      .sidebar-left::-webkit-scrollbar-track,
      .sidebar-right::-webkit-scrollbar-track {
        background: rgba(0, 0, 0, 0.05);
        border-radius: 3px;
      }

      .sidebar-left::-webkit-scrollbar-thumb,
      .sidebar-right::-webkit-scrollbar-thumb {
        background: rgba(0, 0, 0, 0.2);
        border-radius: 3px;
      }

      .sidebar-left::-webkit-scrollbar-thumb:hover,
      .sidebar-right::-webkit-scrollbar-thumb:hover {
        background: rgba(0, 0, 0, 0.3);
      }

      /* Dark mode scrollbar */
      body.dark-mode .sidebar-left::-webkit-scrollbar-track,
      body.dark-mode .sidebar-right::-webkit-scrollbar-track {
        background: rgba(255, 255, 255, 0.1);
      }

      body.dark-mode .sidebar-left::-webkit-scrollbar-thumb,
      body.dark-mode .sidebar-right::-webkit-scrollbar-thumb {
        background: rgba(255, 255, 255, 0.3);
      }

      body.dark-mode .sidebar-left::-webkit-scrollbar-thumb:hover,
      body.dark-mode .sidebar-right::-webkit-scrollbar-thumb:hover {
        background: rgba(255, 255, 255, 0.4);
      }
      .feed-column {
        flex: 1;
        max-width: 780px;
      }
      /* Enhanced Mobile Responsiveness */
      @media (max-width: 1199.98px) {
        .sidebar-right {
          display: none !important;
        }
      }
      
      @media (max-width: 991.98px) {
        .sidebar-left {
          display: none !important;
        }
        .hub-layout {
          display: block;
          padding: 0.5rem;
        }
        .feed-column {
          max-width: 100%;
          padding: 0;
        }
        
        /* Mobile post cards */
        .post-card {
          margin-bottom: 1rem;
          border-radius: 12px;
        }
        
        /* Mobile create post area */
        .create-card {
          padding: 1rem;
          margin-bottom: 1rem;
        }
      }
      
      /* Phone-specific optimizations */
      @media (max-width: 768px) {
        .container-fluid {
          padding: 0;
        }
        
        .main-header {
          padding: 0.5rem 1rem;
        }
        
        .hub-layout {
          padding: 0.25rem;
        }
        
        /* Post cards mobile optimization */
        .post-card {
          border-radius: 8px;
          box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .post-header {
          padding: 0.75rem;
        }
        
        .post-footer {
          padding: 0.5rem 0.75rem;
        }
        
        /* Mobile comment input */
        .quick-comment-input {
          padding: 0.5rem 0.75rem;
        }
        
        .enhanced-comment-input {
          font-size: 14px;
          padding: 0.5rem;
        }
        
        /* Mobile buttons */
        .icon-btn {
          padding: 0.4rem 0.6rem;
          font-size: 0.85rem;
        }
        
        /* Mobile modals */
        .modal-dialog {
          margin: 0.5rem;
        }
        
        .modal-content {
          border-radius: 12px;
        }
      }
      
      /* Crop Modal Button Styling */
      .crop-preset,
      #rotateLeft,
      #rotateRight {
        background-color: #ffffff !important;
        border: 1px solid #dee2e6 !important;
        color: #212529 !important;
        font-weight: 500;
      }
      
      .crop-preset:hover,
      #rotateLeft:hover,
      #rotateRight:hover {
        background-color: #e9ecef !important;
        border-color: #adb5bd !important;
        color: #000 !important;
      }
      
      .crop-preset.active {
        background-color: #0d6efd !important;
        border-color: #0d6efd !important;
        color: #ffffff !important;
      }
      
      .crop-preset:focus,
      #rotateLeft:focus,
      #rotateRight:focus {
        box-shadow: 0 0 0 0.2rem rgba(13, 110, 253, 0.25) !important;
      }
      
      /* Dark mode crop button styling */
      body.dark-mode .crop-preset,
      body.dark-mode #rotateLeft,
      body.dark-mode #rotateRight {
        background-color: #495057 !important;
        border-color: #6c757d !important;
        color: #ffffff !important;
      }
      
      body.dark-mode .crop-preset:hover,
      body.dark-mode #rotateLeft:hover,
      body.dark-mode #rotateRight:hover {
        background-color: #5a6268 !important;
        border-color: #7c848a !important;
        color: #ffffff !important;
      }
      
      body.dark-mode .crop-preset.active {
        background-color: #0d6efd !important;
        border-color: #0d6efd !important;
        color: #ffffff !important;
      }
      
      /* Crop modal dark mode support */
      body.dark-mode .crop-container {
        background: #2d2d2d !important;
        border-color: #404040 !important;
      }
      
      body.dark-mode #imageCropModal .modal-content,
      body.dark-mode #profileCropModal .modal-content,
      body.dark-mode #cropModal .modal-content {
        background: #23272b !important;
        border: 1px solid #404040 !important;
        color: #e0e0e0 !important;
      }
      
      body.dark-mode #imageCropModal .modal-header,
      body.dark-mode #profileCropModal .modal-header,
      body.dark-mode #cropModal .modal-header {
        border-bottom: 1px solid #404040 !important;
        color: #e0e0e0 !important;
      }
      
      body.dark-mode #imageCropModal .modal-footer,
      body.dark-mode #profileCropModal .modal-footer,
      body.dark-mode #cropModal .modal-footer {
        border-top: 1px solid #404040 !important;
      }
      
      /* Small phone optimizations */
      @media (max-width: 576px) {
        .main-header h1 {
          font-size: 1.25rem;
        }
        
        .hub-layout {
          padding: 0.125rem;
        }
        
        .post-card {
          margin-bottom: 0.75rem;
        }
        
        .create-card {
          padding: 0.75rem;
          margin-bottom: 0.75rem;
        }
        
        /* Compress post content on very small screens */
        .post-header .avatar {
          width: 36px;
          height: 36px;
        }
        
        .post-meta strong {
          font-size: 0.9rem;
        }
        
        .post-meta small {
          font-size: 0.75rem;
        }
        
        /* Mobile floating action button */
        .fab-new {
          bottom: 20px;
          right: 20px;
          width: 56px;
          height: 56px;
        }
        
        /* Touch-friendly comment buttons */
        .comment-actions .btn {
          min-width: 44px;
          min-height: 44px;
        }
      }

      .sidebar-card {
        background: #fff;
        border-radius: 18px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.05);
        padding: 1rem 1.1rem 1.05rem;
        margin-bottom: 1.4rem;
      }
      body.dark-mode .sidebar-card {
        background: #23272b;
        box-shadow: 0 4px 24px rgba(0, 0, 0, 0.4);
      }
      .sidebar-title {
        font-size: 0.7rem;
        font-weight: 700;
        letter-spacing: 0.8px;
        text-transform: uppercase;
        margin-bottom: 0.75rem;
        opacity: 0.8;
      }
      .hub-nav .nav-link {
        font-size: 0.85rem;
        font-weight: 500;
        padding: 0.45rem 0.25rem;
        border-radius: 10px;
        color: #444;
      }
      .hub-nav .nav-link i {
        font-size: 1rem;
      }
      .hub-nav .nav-link.active,
      .hub-nav .nav-link:hover {
        background: #e3f2fd;
        color: #3498db;
      }
      body.dark-mode .hub-nav .nav-link {
        color: #ccc;
      }
      body.dark-mode .hub-nav .nav-link.active,
      body.dark-mode .hub-nav .nav-link:hover {
        background: #1e3a5f;
        color: #85c1e9;
      }
      .stats span {
        font-size: 0.6rem;
      }
      .tag-chip {
        background: #f1f3f5;
        border: 1px solid transparent;
        padding: 0.35rem 0.75rem;
        border-radius: 30px;
        font-size: 0.65rem;
        font-weight: 600;
        margin: 0 0.35rem 0.45rem 0;
        cursor: pointer;
        transition: all 0.3s ease;
        opacity: 0.7;
      }
      
      .tag-chip:hover {
        background: #3498db;
        color: #fff;
        opacity: 1;
        transform: translateY(-1px);
        box-shadow: 0 2px 4px rgba(52, 152, 219, 0.3);
      }
      
      body.dark-mode .tag-chip {
        background: #2e3338;
        color: #bbb;
        border-color: rgba(255, 255, 255, 0.1);
      }
      
      body.dark-mode .tag-chip:hover {
        background: #3498db;
        color: #fff;
      }
      
      .tag-chip.selected {
        background: linear-gradient(135deg, #3498db, #5dade2) !important;
        color: white !important;
        border: 1px solid #3498db;
        opacity: 1 !important;
        font-weight: 700;
        box-shadow: 0 3px 8px rgba(220, 53, 69, 0.4);
      }
      
      .trending-tag {
        position: relative;
        margin-bottom: 0.5rem;
      }
      
      .trending-tag .tag-count {
        opacity: 0.8;
        font-size: 0.6rem;
        margin-left: 0.25rem;
        font-weight: 400;
      }
      
      .trending-tag.selected {
        background: linear-gradient(135deg, #28a745, #20c997) !important;
        border-color: #28a745;
        box-shadow: 0 3px 8px rgba(40, 167, 69, 0.4);
      }
      
      /* Enhanced tag visual hierarchy */
      .tag-chip {
        transition: all 0.2s ease;
        position: relative;
      }
      
      .tag-chip.selected {
        background: linear-gradient(135deg, #007bff, #0056b3) !important;
        border-color: #007bff !important;
        color: white !important;
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(0, 123, 255, 0.3);
        font-weight: 600;
        z-index: 10;
      }
      
      .tag-chip:not(.selected) {
        opacity: 0.75;
        background: #f8f9fa;
        border-color: rgba(0, 0, 0, 0.15);
        color: #495057;
      }
      
      .tag-chip:not(.selected):hover {
        opacity: 1;
        background: #e9ecef;
        border-color: rgba(0, 0, 0, 0.25);
        transform: translateY(-1px);
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
      }
      
      /* Dark mode improvements */
      body.dark-mode .tag-chip:not(.selected) {
        background: #495057;
        color: #adb5bd;
        border-color: rgba(255, 255, 255, 0.1);
      }
      
      body.dark-mode .tag-chip:not(.selected):hover {
        background: #6c757d;
        color: #e9ecef;
        border-color: rgba(255, 255, 255, 0.2);
      }
      
      body.dark-mode .tag-chip.selected {
        background: linear-gradient(135deg, #0d6efd, #0b5ed7) !important;
        border-color: #0d6efd !important;
        box-shadow: 0 4px 12px rgba(13, 110, 253, 0.4);
      }
      
      .comment-preview {
        border-top: 1px solid rgba(0,0,0,0.1);
      }
      
      body.dark-mode .comment-preview {
        border-top-color: rgba(255,255,255,0.1);
      }
      
      .comment-preview-item {
        padding: 0.25rem 0;
        border-radius: 0.25rem;
        transition: background-color 0.2s;
      }
      
      /* Comment Preview Panel Styling */
      .comment-preview-panel {
        background: rgba(248, 249, 250, 0.5);
        border-radius: 0 0 16px 16px;
        margin: 0 -1rem -1rem -1rem;
        padding: 1rem;
      }
      
      body.dark-mode .comment-preview-panel {
        background: rgba(255, 255, 255, 0.02);
        border-top-color: rgba(255, 255, 255, 0.1);
      }
      
      .comment-preview-panel .comment-preview-item {
        border: none;
        background: transparent;
        padding: 0;
      }
      
      .comment-preview-panel .comment-text {
        line-height: 1.4;
        color: var(--bs-body-color);
      }
      
      .comment-preview-panel .comment-actions .btn-link {
        color: var(--bs-secondary);
        text-decoration: underline;
        font-weight: 500;
        border: none;
        background: none;
        padding: 0;
      }
      
      .comment-preview-panel .comment-actions .btn-link:hover {
        color: var(--bs-primary);
        text-decoration: underline;
      }
      
      .comment-preview-panel .comment-actions .liked {
        color: #3498db;
      }
      
      /* Quick Comment Input Styling */
      .quick-comment-input {
        margin: 0 -1rem -1rem -1rem;
        padding: 0.75rem 1rem 1rem 1rem;
        background: rgba(248, 249, 250, 0.3);
        border-radius: 0 0 16px 16px;
      }
      
      body.dark-mode .quick-comment-input {
        background: rgba(255, 255, 255, 0.01);
        border-top-color: rgba(255, 255, 255, 0.05);
      }
      
      .quick-comment-input .form-control {
        border-radius: 20px;
        border: 1px solid rgba(0,0,0,0.1);
        background: rgba(255,255,255,0.9);
        transition: all 0.2s ease;
      }
      
      .quick-comment-input .form-control:focus {
        border-color: var(--bs-primary);
        box-shadow: 0 0 0 0.2rem rgba(13, 110, 253, 0.15);
        background: white;
      }
      
      /* Mobile form improvements */
      @media (max-width: 768px) {
        .form-control,
        .form-select,
        textarea {
          font-size: 16px; /* Prevent zoom on iOS */
          border-radius: 8px;
        }
        
        .modal-body .form-control {
          font-size: 14px; /* Smaller in modals */
        }
        
        /* Mobile comment input */
        .enhanced-comment-input,
        .comment-input {
          font-size: 14px;
          padding: 0.5rem 0.75rem;
          border-radius: 20px;
        }
        
        /* Mobile textarea */
        #postText {
          min-height: 80px;
          font-size: 14px;
        }
        
        /* Larger touch targets */
        .icon-btn,
        .btn-sm {
          min-width: 44px;
          min-height: 44px;
          display: inline-flex;
          align-items: center;
          justify-content: center;
        }
        
        /* Mobile-friendly dropdowns */
        .dropdown-menu {
          border-radius: 12px;
          box-shadow: 0 8px 32px rgba(0,0,0,0.15);
          border: none;
          margin-top: 0.5rem;
        }
        
        .dropdown-item {
          padding: 0.75rem 1rem;
          font-size: 0.9rem;
        }
        
        /* Mobile modal improvements */
        .modal-header {
          padding: 1rem;
          border-bottom: 1px solid rgba(0,0,0,0.1);
        }
        
        .modal-body {
          padding: 1rem;
        }
        
        .modal-footer {
          padding: 1rem;
          border-top: 1px solid rgba(0,0,0,0.1);
        }
      }
      
      body.dark-mode .quick-comment-input .form-control {
        background: rgba(255,255,255,0.1);
        border-color: rgba(255,255,255,0.2);
        color: white;
      }
      
      body.dark-mode .quick-comment-input .form-control::placeholder {
        color: rgba(255,255,255,0.6);
      }
      
      /* Comment action buttons - link style */
      .like-comment-btn,
      .reply-comment-btn,
      .admin-delete-comment-btn,
      .report-comment-btn,
      .view-more-comments-btn {
        border: none !important;
        background: none !important;
        padding: 0 !important;
        text-decoration: underline;
        font-weight: normal;
      }
      
      .like-comment-btn:hover {
        color: #3498db !important;
        text-decoration: underline;
      }
      
      .reply-comment-btn:hover {
        color: var(--bs-primary) !important;
        text-decoration: underline;
      }
      
      .admin-delete-comment-btn {
        color: #3498db !important;
      }
      
      .admin-delete-comment-btn:hover {
        color: #b02a37 !important;
        text-decoration: underline;
      }
      
      .report-comment-btn:hover {
        color: #fd7e14 !important;
        text-decoration: underline;
      }
      
      .view-more-comments-btn:hover {
        color: var(--bs-primary) !important;
        text-decoration: underline;
      }
      
      .comment-actions {
        display: flex;
        gap: 0.5rem;
        align-items: center;
        margin-top: 0.25rem;
      }
      
      .comment-actions button {
        background: none;
        border: none;
        padding: 0.125rem 0.25rem;
        border-radius: 0.25rem;
        font-size: 0.75rem;
        color: #6c757d;
        transition: all 0.2s;
        cursor: pointer;
      }
      
      .comment-actions button:hover {
        background: rgba(220, 53, 69, 0.1);
        color: #3498db;
      }
      
      .comment-actions .liked {
        color: #3498db;
      }
      
      /* Dark mode icon fixes */
      .notification-icon {
        color: #3498db;
      }
      
      body.dark-mode .notification-icon {
        color: white;
      }
      
      .dark-mode-icon {
        color: #3498db;
      }
      
      body.dark-mode .dark-mode-icon {
        color: white;
      }
      
      /* Community context panel */
      .community-context-panel {
        background: rgba(220,53,69,0.05);
        border-left: 3px solid #3498db;
        border-radius: 0.5rem;
      }
      
      body.dark-mode .community-context-panel {
        background: rgba(220,53,69,0.1);
        border-left-color: #3498db;
      }
      
      /* NSFW blur effect */
      .nsfw-blur {
        filter: blur(20px);
        transition: filter 0.3s ease;
        cursor: pointer;
        position: relative;
      }
      
      .nsfw-blur.revealed {
        filter: none;
      }
      
      .nsfw-overlay {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0,0,0,0.8);
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        color: white;
        z-index: 10;
        border-radius: 0.5rem;
      }
      
      .nsfw-warning {
        background: rgba(220,53,69,0.1);
        border: 1px solid #3498db;
        border-radius: 0.5rem;
        padding: 0.75rem;
        margin-top: 0.5rem;
        text-align: center;
      }
      
      .age-verification-modal .modal-content {
        background: linear-gradient(135deg, #3498db 0%, #85c1e9 100%);
        color: white;
        border: none;
      }
      
      .age-verification-modal .btn-outline-light {
        border-color: rgba(255,255,255,0.5);
        color: white;
      }
      
      .age-verification-modal .btn-outline-light:hover {
        background: rgba(255,255,255,0.1);
        border-color: white;
      }
      
      /* Dark mode icon fixes */
      .notification-icon {
        color: #3498db;
      }
      
      body.dark-mode .notification-icon {
        color: white;
      }
      
      .dark-mode-icon {
        color: #3498db;
      }
      
      body.dark-mode .dark-mode-icon {
        color: white;
      }
      
      /* Community context panel */
      .community-context-panel {
        background: rgba(220,53,69,0.05);
        border-left: 3px solid #3498db;
        border-radius: 0.5rem;
      }
      
      body.dark-mode .community-context-panel {
        background: rgba(220,53,69,0.1);
        border-left-color: #3498db;
      }
      
      /* NSFW blur effect */
      .nsfw-blur {
        filter: blur(20px);
        transition: filter 0.3s ease;
        cursor: pointer;
        position: relative;
      }
      
      .nsfw-blur.revealed {
        filter: none;
      }
      
      .nsfw-overlay {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0,0,0,0.8);
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        color: white;
        z-index: 10;
        border-radius: 0.5rem;
      }
      
      .nsfw-warning {
        background: rgba(220,53,69,0.1);
        border: 1px solid #3498db;
        border-radius: 0.5rem;
        padding: 0.75rem;
        margin-top: 0.5rem;
        text-align: center;
      }
      
      .age-verification-modal .modal-content {
        background: linear-gradient(135deg, #3498db 0%, #85c1e9 100%);
        color: white;
        border: none;
      }
      
      .age-verification-modal .btn-outline-light {
        border-color: rgba(255,255,255,0.5);
        color: white;
      }
      
      .age-verification-modal .btn-outline-light:hover {
        background: rgba(255,255,255,0.1);
        border-color: white;
      }
      
      /* Dark mode icon fixes */
      .notification-icon {
        color: #3498db;
      }
      
      body.dark-mode .notification-icon {
        color: white;
      }
      
      .dark-mode-icon {
        color: #3498db;
      }
      
      body.dark-mode .dark-mode-icon {
        color: white;
      }
      
      /* Community context panel */
      .community-context-panel {
        background: rgba(220,53,69,0.05);
        border-left: 3px solid #3498db;
        border-radius: 0.5rem;
      }
      
      body.dark-mode .community-context-panel {
        background: rgba(220,53,69,0.1);
        border-left-color: #3498db;
      }
      
      /* NSFW blur effect */
      .nsfw-blur {
        filter: blur(20px);
        transition: filter 0.3s ease;
        cursor: pointer;
        position: relative;
      }
      
      .nsfw-blur.revealed {
        filter: none;
      }
      
      .nsfw-overlay {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0,0,0,0.8);
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        color: white;
        z-index: 10;
        border-radius: 0.5rem;
      }
      
      .nsfw-warning {
        background: rgba(220,53,69,0.1);
        border: 1px solid #3498db;
        border-radius: 0.5rem;
        padding: 0.75rem;
        margin-top: 0.5rem;
        text-align: center;
      }
      
      .age-verification-modal .modal-content {
        background: linear-gradient(135deg, #3498db 0%, #85c1e9 100%);
        color: white;
        border: none;
      }
      
      .age-verification-modal .btn-outline-light {
        border-color: rgba(255,255,255,0.5);
        color: white;
      }
      
      .age-verification-modal .btn-outline-light:hover {
        background: rgba(255,255,255,0.1);
        border-color: white;
      }
      .follow-btn {
        padding: 0.25rem 0.65rem !important;
        font-size: 0.6rem !important;
        border-radius: 30px;
      }
      .suggestion-item:last-child {
        margin-bottom: 0 !important;
      }
      .info-card.small {
        font-size: 0.65rem;
      }
      body.dark-mode .sidebar-title {
        color: #85c1e9;
      }

      /* Brand button consistency */
      .hub-layout .btn,
      .hub-layout .btn-brand {
        background: #3498db !important;
        border-color: #3498db !important;
      }
      body.dark-mode .hub-layout .btn,
      body.dark-mode .hub-layout .btn-brand {
        background: #3498db !important;
        border-color: #3498db !important;
      }

      /* Toast (for post publish + context) */
      .toast-container {
        z-index: 20000;
      }
      .toast-brand {
        background: #3498db;
        color: #fff;
      }
      body.dark-mode .toast-brand {
        background: #23272b;
        color: #fff;
        border: 1px solid #444;
      }

      /* Align navbar actions in one line like index */
      .navbar .nav-actions {
        display: flex;
        align-items: center;
        gap: 0.75rem;
      }
      .navbar .custom-btn {
        padding: 0.55rem 1.1rem;
        font-size: 0.85rem;
        border-radius: 30px;
        font-weight: 600;
      }
      .navbar-brand img {
        height: 50px;
      }

      /* Enhanced interaction styles */
      .icon-btn.text-danger {
        color: #3498db !important;
      }
      .icon-btn.text-warning {
        color: #ffc107 !important;
      }
      .save-btn.text-warning i {
        color: #ffc107 !important;
      }
      .notification-item {
        cursor: pointer;
        transition: background-color 0.2s;
      }
      .notification-item:hover {
        background-color: #f8f9fa !important;
      }
      body.dark-mode .notification-item:hover {
        background-color: #2e3338 !important;
      }
      .post-card {
        transition: transform 0.2s, box-shadow 0.2s;
      }
      .post-card:hover {
        transform: translateY(-1px);
        box-shadow: 0 6px 28px rgba(0, 0, 0, 0.08);
      }
      body.dark-mode .post-card:hover {
        box-shadow: 0 6px 32px rgba(0, 0, 0, 0.5);
      }

      /* Auth mini bar (desktop) */
      #authMini span {
        font-size: 0.65rem;
        letter-spacing: 0.5px;
      }
      #authMini button {
        font-size: 0.6rem;
        padding: 0.25rem 0.7rem;
        border-radius: 30px;
      }

      /* Dark mode ensures buttons stay red */
      body.dark-mode .btn,
      body.dark-mode .custom-btn,
      body.dark-mode button {
        background: #3498db !important;
        border-color: #3498db !important;
        color: #fff !important;
      }

      /* Auth modal */
      .modal-backdrop.show {
        opacity: 0.55;
      }
      .form-floating > label {
        color: #666;
      }
      body.dark-mode .form-floating > label {
        color: #aaa;
      }
      body.dark-mode .form-control {
        background: #2e3338;
        border-color: #444;
        color: #e0e0e0;
      }
      .pointer {
        cursor: pointer;
      }
      .mini-link {
        font-size: 0.75rem;
      }
      .suggestion-skel,
      .post-skel {
        animation: pulse 1.3s ease-in-out infinite;
        background: linear-gradient(
          90deg,
          #e9ecef 0%,
          #f8f9fa 50%,
          #e9ecef 100%
        );
        background-size: 200% 100%;
        border-radius: 8px;
      }
      body.dark-mode .suggestion-skel,
      body.dark-mode .post-skel {
        background: linear-gradient(
          90deg,
          #353a40 0%,
          #3f454c 50%,
          #353a40 100%
        );
      }
      .post-skel {
        height: 160px;
        margin-bottom: 1rem;
      }
      .suggestion-skel {
        height: 48px;
        margin-bottom: 0.6rem;
      }
      @keyframes pulse {
        0% {
          background-position: 0 0;
        }
        100% {
          background-position: -200% 0;
        }
      }
      .follow-btn.loading {
        position: relative;
        pointer-events: none;
      }
      .follow-btn.loading:after {
        content: "";
        position: absolute;
        inset: 0;
        border-radius: inherit;
        background: rgba(255, 255, 255, 0.2);
      }

      /* Notifications dropdown styles */
      .notifications-dropdown {
        border: none;
        box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
        border-radius: 12px;
      }
      .notifications-dropdown .dropdown-header {
        background: #f8f9fa;
        border-radius: 12px 12px 0 0;
        font-weight: 600;
        padding: 0.75rem 1rem;
      }
      body.dark-mode .notifications-dropdown {
        background: #23272b;
        border: 1px solid #444;
      }
      body.dark-mode .notifications-dropdown .dropdown-header {
        background: #2e3338;
        color: #e0e0e0;
      }
      .notification-dropdown-item {
        padding: 0.75rem 1rem;
        border-bottom: 1px solid #f1f3f5;
        cursor: pointer;
        transition: background-color 0.2s;
      }

      /* Image Upload and Cropping Styles */
      .image-preview-item {
        position: relative;
        border: 2px solid #e9ecef;
        border-radius: 8px;
        overflow: hidden;
        transition: all 0.3s ease;
      }

      .image-preview-item:hover {
        border-color: #007bff;
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
      }

      .image-preview-item img {
        width: 100%;
        height: 100px;
        object-fit: cover;
      }

      .image-preview-overlay {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.5);
        display: flex;
        align-items: center;
        justify-content: center;
        opacity: 0;
        transition: opacity 0.3s ease;
      }

      .image-preview-item:hover .image-preview-overlay {
        opacity: 1;
      }

      .crop-container {
        position: relative;
        background: #f8f9fa;
        border-radius: 8px;
        padding: 20px;
      }

      body.dark-mode .crop-container {
        background: #343a40;
      }

      body.dark-mode .image-preview-item {
        border-color: #495057;
      }

      body.dark-mode .image-preview-item:hover {
        border-color: #007bff;
      }

      /* Create Post Image Upload Styles */
      .create-card {
        transition: all 0.3s ease;
      }

      .create-card.drag-over {
        background-color: #f0f8ff !important;
        border-color: #007bff !important;
        transform: scale(1.02);
      }

      body.dark-mode .create-card.drag-over {
        background-color: #1a2332 !important;
        border-color: #007bff !important;
      }

      #imagePreviewArea {
        border: 1px solid #e9ecef;
        border-radius: 12px;
        padding: 1rem;
        background: #f8f9fa;
      }

      body.dark-mode #imagePreviewArea {
        border-color: #495057;
        background: #2e3338;
      }

      #imagePreview {
        cursor: pointer;
        transition: transform 0.2s ease;
      }

      #imagePreview:hover {
        transform: scale(1.02);
      }

      #addImageBtn {
        transition: all 0.2s ease;
      }

      #addImageBtn:hover {
        transform: translateY(-1px);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
      }

      .notification-dropdown-item:hover {
        background-color: #f8f9fa;
      }
      .notification-dropdown-item:last-child {
        border-bottom: none;
      }
      body.dark-mode .notification-dropdown-item {
        border-bottom-color: #444;
      }
      body.dark-mode .notification-dropdown-item:hover {
        background-color: #2e3338;
      }
      .notification-dropdown-item.unread {
        background-color: #fff3cd;
      }
      body.dark-mode .notification-dropdown-item.unread {
        background-color: #3d3416;
      }

      /* Search and Filter Styles */
      .sidebar-subtitle {
        font-size: 0.9rem;
        font-weight: 600;
        margin-bottom: 0.5rem;
        color: #666;
      }

      body.dark-mode .sidebar-subtitle {
        color: #ccc;
      }

      .search-results {
        background: #fff;
        border: 1px solid #e9ecef;
        border-radius: 0.375rem;
        max-height: 300px;
        overflow-y: auto;
        margin-top: 0.5rem;
      }

      body.dark-mode .search-results {
        background: #2d3338;
        border-color: #444;
      }

      .search-result-item:last-child {
        border-bottom: none !important;
      }

      .tag-buttons .btn {
        font-size: 0.75rem;
        padding: 0.25rem 0.5rem;
        border-radius: 1rem;
        transition: all 0.2s ease;
        color: white !important;
        text-decoration: none !important;
      }

      .tag-buttons .btn:hover {
        transform: translateY(-1px);
        color: white !important;
        text-decoration: none !important;
      }

      .tag-buttons .btn:focus,
      .tag-buttons .btn:active {
        color: white !important;
        text-decoration: none !important;
        box-shadow: none !important;
      }

      .tags-filter .form-control {
        font-size: 0.875rem;
      }

      .search-section .form-control {
        font-size: 0.875rem;
      }

      /* Enhanced suggestion items */
      .suggestion-item .btn {
        transition: all 0.2s ease;
      }

      .suggestion-item .btn:hover {
        transform: translateY(-1px);
      }

      .suggestion-item img {
        border: 2px solid transparent;
        transition: border-color 0.2s ease;
      }

      .suggestion-item:hover img {
        border-color: #007bff;
      }

      /* Loading spinner in search */
      .spinner-border-sm {
        width: 1rem;
        height: 1rem;
      }

      /* Upload progress styling */
      #uploadProgress {
        background: rgba(0, 123, 255, 0.1);
        border-radius: 0.375rem;
        padding: 0.5rem;
        border: 1px solid rgba(0, 123, 255, 0.2);
      }

      /* Steam-like Profile Styles */
      .profile-header {
        background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
        color: white;
        border-radius: 12px;
        padding: 20px;
        margin-bottom: 20px;
      }

      .profile-portfolio {
        background: #f8f9fa;
        border: 1px solid #e9ecef;
        border-radius: 8px;
        padding: 15px;
        margin-bottom: 15px;
      }

      body.dark-mode .profile-portfolio {
        background: #2e3338;
        border-color: #444;
        color: #e0e0e0;
      }

      .alias-history {
        display: inline-flex;
        align-items: center;
        gap: 5px;
        margin-left: 10px;
      }

      .alias-dropdown {
        position: relative;
        display: inline-block;
      }

      .alias-list {
        position: absolute;
        top: 100%;
        left: 0;
        background: white;
        border: 1px solid #ddd;
        border-radius: 4px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        min-width: 200px;
        z-index: 1000;
        display: none;
      }

      body.dark-mode .alias-list {
        background: #2e3338;
        border-color: #444;
        color: #e0e0e0;
      }

      .alias-item {
        padding: 8px 12px;
        border-bottom: 1px solid #eee;
        font-size: 0.875rem;
        color: #666;
      }

      body.dark-mode .alias-item {
        border-bottom-color: #444;
        color: #ccc;
      }

      .username-cooldown {
        font-size: 0.75rem;
        color: #3498db;
        margin-top: 5px;
      }

      .settings-in-view .create-card {
        display: none !important;
      }

      /* Navigation active state */
      .sidebar-card.nav-card [data-hub-nav].active {
        background-color: rgba(102, 126, 234, 0.1);
        color: #667eea;
        font-weight: 600;
        border-radius: 8px;
        padding: 8px 12px;
        margin: 2px 0;
      }

      body.dark-mode .sidebar-card.nav-card [data-hub-nav].active {
        background-color: rgba(102, 126, 234, 0.2);
        color: #8fa4ff;
      }

      /* Email verification styling */
      #emailVerificationStep {
        animation: slideDown 0.3s ease-out;
      }

      @keyframes slideDown {
        from {
          opacity: 0;
          transform: translateY(-10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      #verificationCode {
        font-family: "Courier New", monospace;
        font-size: 1.1rem;
        text-align: center;
        letter-spacing: 0.2em;
      }

      /* Context review card styling */
      .context-review-card {
        background: #f8f9fa;
        border: 1px solid #e9ecef;
        border-radius: 8px;
        padding: 15px;
        margin-bottom: 15px;
      }

      body.dark-mode .context-review-card {
        background: #2e3338;
        border-color: #444;
        color: #e0e0e0;
      }

      .context-stats {
        display: flex;
        gap: 15px;
        margin: 10px 0;
      }

      .context-stat {
        text-align: center;
        flex: 1;
      }

      .context-stat .stat-number {
        font-size: 1.25rem;
        font-weight: bold;
        display: block;
      }

      .context-stat .stat-label {
        font-size: 0.75rem;
        color: #6c757d;
      }

      body.dark-mode .context-stat .stat-label {
        color: #adb5bd;
      }

      /* Edit indicator styling */
      .edit-indicator {
        color: #6c757d !important;
        font-size: 0.75rem;
      }

      .edit-indicator:hover {
        color: #495057 !important;
        text-decoration: underline !important;
      }

      /* Original content styling */
      .original-content {
        background: #f8f9fa;
        border-left: 3px solid #dee2e6;
        padding: 0.75rem;
        margin-top: 0.5rem;
        border-radius: 0.375rem;
      }

      body.dark-mode .original-content {
        background: #2d3338;
        border-left-color: #495057;
      }

      /* Comment preview styling */
      .comment-preview {
        background: rgba(0, 0, 0, 0.02);
        border-radius: 0.375rem;
        padding: 0.5rem;
      }

      body.dark-mode .comment-preview {
        background: rgba(255, 255, 255, 0.05);
      }

      .comment-preview-item {
        font-size: 0.85rem;
        line-height: 1.3;
      }

      /* Image zoom cursor */
      .post-image {
        transition: transform 0.2s ease;
      }

      .post-image:hover {
        transform: scale(1.02);
      }

      /* Force all icons to be white */
      .btn i,
      .input-group .btn i,
      #searchUsersBtn i,
      #filterByTagBtn i,
      #clearFiltersBtn i,
      .dropdown-toggle i {
        color: white !important;
      }

      /* White icons for filter/search buttons */
      .input-group .btn-outline-secondary {
        color: white !important;
        border-color: rgba(255, 255, 255, 0.3) !important;
      }

      .input-group .btn-outline-secondary:hover {
        background-color: rgba(255, 255, 255, 0.1) !important;
        border-color: rgba(255, 255, 255, 0.5) !important;
        color: white !important;
      }

      /* Clear filters button styling */
      .btn-outline-secondary {
        color: white !important;
        border-color: rgba(255, 255, 255, 0.3) !important;
      }

      .btn-outline-secondary:hover {
        background-color: rgba(255, 255, 255, 0.1) !important;
        border-color: rgba(255, 255, 255, 0.5) !important;
        color: white !important;
      }

      /* Post dropdown button styling */
      .post-card .dropdown-toggle {
        background: transparent !important;
        border-color: rgba(255, 255, 255, 0.3) !important;
        color: white !important;
      }

      .post-card .dropdown-toggle:hover,
      .post-card .dropdown-toggle:focus,
      .post-card .dropdown-toggle.show {
        background-color: rgba(255, 255, 255, 0.1) !important;
        border-color: rgba(255, 255, 255, 0.5) !important;
        color: white !important;
        box-shadow: none !important;
      }

      /* Mobile Utility Classes */
      @media (max-width: 768px) {
        .mobile-hide {
          display: none !important;
        }
        
        .mobile-show {
          display: block !important;
        }
        
        .mobile-p-1 {
          padding: 0.25rem !important;
        }
        
        .mobile-m-1 {
          margin: 0.25rem !important;
        }
        
        .mobile-text-sm {
          font-size: 0.875rem !important;
        }
        
        .mobile-text-xs {
          font-size: 0.75rem !important;
        }
        
        /* Mobile performance optimizations */
        /* Reduce animations on mobile for better performance */
        * {
          animation-duration: 0.2s !important;
          transition-duration: 0.2s !important;
        }
        
        /* Optimize scrolling */
        .feed-column {
          -webkit-overflow-scrolling: touch;
        }
        
        /* Mobile loading states */
        .loading-placeholder {
          background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
          background-size: 200% 100%;
          animation: loading 1.5s infinite;
        }
        
        @keyframes loading {
          0% { background-position: 200% 0; }
          100% { background-position: -200% 0; }
        }
        
        /* Mobile toast positioning */
        .toast-container {
          position: fixed;
          top: auto;
          bottom: 2rem;
          left: 1rem;
          right: 1rem;
          z-index: 9999;
        }
      }
      
      /* Ensure dropdown menu appears above other content */
      .dropdown-menu {
        z-index: 1050;
      }

      /* Dark mode dropdown styling */
      body.dark-mode .dropdown-menu {
        background-color: #23272b !important;
        border-color: #444 !important;
      }

      body.dark-mode .dropdown-item {
        color: #e0e0e0 !important;
      }

      body.dark-mode .dropdown-item:hover {
        background-color: #2e3338 !important;
        color: #fff !important;
      }
      
      /* Mobile dark mode optimizations */
      @media (max-width: 768px) {
        body.dark-mode {
          background: #1a1a1a;
        }
        
        body.dark-mode .main-header {
          background: rgba(26, 26, 26, 0.95);
        }
        
        body.dark-mode .post-card {
          background: #2d2d2d;
          border: 1px solid #404040;
        }
        
        body.dark-mode .form-control,
        body.dark-mode .form-select {
          background: #2d2d2d;
          border-color: #404040;
          color: #ffffff;
        }
        
        body.dark-mode .modal-content {
          background: #2d2d2d;
          border: 1px solid #404040;
        }
        
        body.dark-mode .dropdown-menu {
          background: #2d2d2d;
          border-color: #404040;
        }
      }

      /* Force specific button icons to be white, but not sidebar nav */
      .btn i,
      .input-group-text i {
        color: white !important;
      }

      /* Ensure tag buttons maintain white text */
      .tag-buttons .btn,
      .tag-buttons .btn:hover,
      .tag-buttons .btn:focus,
      .tag-buttons .btn:active {
        color: white !important;
      }

      /* Admin badge styling */
      .admin-badge {
        background: linear-gradient(135deg, #3498db, #5dade2);
        color: white;
        font-size: 0.6rem;
        font-weight: 700;
        letter-spacing: 0.5px;
        padding: 0.2rem 0.5rem;
        border-radius: 12px;
        text-transform: uppercase;
        box-shadow: 0 2px 4px rgba(220, 53, 69, 0.3);
      }

      /* Report modal styling */
      .report-item {
        border-left: 3px solid #3498db;
        background: rgba(52, 152, 219, 0.05);
        padding: 1rem;
        margin-bottom: 1rem;
        border-radius: 0.375rem;
      }

      body.dark-mode .report-item {
        background: rgba(52, 152, 219, 0.1);
        border-left-color: #85c1e9;
      }

    /* Mobile container improvements */
    @media (max-width: 576px) {
      .container,
      .container-fluid {
        padding-left: 0.5rem;
        padding-right: 0.5rem;
      }
      
      /* Ultra-compact mobile layout */
      .post-card {
        margin-bottom: 0.5rem;
        border-radius: 6px;
      }
      
      .post-header,
      .post-footer {
        padding: 0.5rem;
      }
      
      .post-meta strong {
        font-size: 0.85rem;
      }
      
      .post-meta small {
        font-size: 0.7rem;
      }
      
      .icon-btn {
        font-size: 0.8rem;
        padding: 0.3rem 0.5rem;
      }
      
      /* Mobile-specific animations */
      .post-card {
        transition: transform 0.1s ease;
      }
      
      .mobile-device .post-card:active {
        transform: scale(0.99);
      }
    }
    
    /* Landscape phone optimizations */
    @media (max-width: 768px) and (orientation: landscape) {
      .hub-layout {
        margin-top: 5rem;
      }
      
      .fab-new {
        bottom: 15px;
        right: 15px;
      }
    }

    /* Admin panel styling */
    .admin-action-btn {
      font-size: 0.75rem;
      padding: 0.25rem 0.5rem;
    }
    
    /* Admin post controls */
    .admin-post-controls {
      border-left: 2px solid #3498db;
      padding-left: 0.5rem;
      margin-left: 0.5rem;
    }
    
    .admin-btn {
      font-size: 0.75rem;
      padding: 0.25rem 0.5rem;
      border: 1px solid rgba(255,255,255,0.3);
      background: rgba(52, 152, 219, 0.1);
      color: #3498db;
    }
    
    .admin-btn:hover {
      background: rgba(52, 152, 219, 0.2);
      color: #3498db;
      border-color: #3498db;
    }
    
    .admin-btn.danger {
      background: rgba(52, 152, 219, 0.2);
    }
    
    .admin-btn.danger:hover {
      background: #3498db;
      color: white;
    }      .context-review-item {
        border: 1px solid var(--bs-border-color);
        border-radius: 8px;
        padding: 1rem;
        margin-bottom: 1rem;
      }

      .context-review-item .context-text {
        background-color: var(--bs-light);
        padding: 0.75rem;
        border-radius: 4px;
        margin: 0.5rem 0;
        font-family: monospace;
        font-size: 0.875rem;
      }

      .verification-step {
        max-width: 400px;
        margin: 0 auto;
      }

      .user-item {
        padding: 0.75rem;
        border-bottom: 1px solid #e9ecef;
        display: flex;
        align-items: center;
        justify-content: space-between;
      }

      body.dark-mode .user-item {
        border-bottom-color: #444;
      }

      .user-item:last-child {
        border-bottom: none;
      }
    </style>
  </head>
  <body>
    <nav class="navbar fixed-top navbar-expand-lg">
      <div class="container">
        <a href="index.html" class="navbar-brand">
          <img id="siteLogo" src="logo.png" alt="ARTHENTIC Logo" />
        </a>
        <button
          class="navbar-toggler"
          type="button"
          data-bs-toggle="collapse"
          data-bs-target="#hubNav"
          aria-controls="hubNav"
          aria-expanded="false"
          aria-label="Toggle navigation"
        >
          <span class="navbar-toggler-icon"></span>
        </button>
        <div id="hubNav" class="collapse navbar-collapse">
          <ul class="navbar-nav ms-lg-4">
            <li class="nav-item">
              <a class="nav-link active" href="arthub.html">Feed</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="index.html#section_3">Services</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="artwork-registration.html"
                >Register Art</a
              >
            </li>
          </ul>
          <div class="ms-auto nav-actions">
            <div id="authMini"></div>

            <!-- Notifications Dropdown -->
            <div class="dropdown" id="notificationsDropdown">
              <button
                class="btn btn-outline-primary position-relative"
                type="button"
                data-bs-toggle="dropdown"
                aria-expanded="false"
                id="notificationsBtn"
                style="color: #3498db; border-color: #3498db"
              >
                <i class="bi bi-bell notification-icon"></i>
                <span
                  class="notification-badge"
                  id="notificationsBadge"
                  style="display: none"
                  >0</span
                >
              </button>
              <div
                class="dropdown-menu dropdown-menu-end notifications-dropdown"
                style="width: 350px; max-height: 400px; overflow-y: auto"
              >
                <div
                  class="dropdown-header d-flex justify-content-between align-items-center"
                >
                  <span>Notifications</span>
                  <button
                    class="btn btn-sm btn-link p-0"
                    id="markAllReadBtn"
                    style="font-size: 0.8rem"
                  >
                    Mark all read
                  </button>
                </div>
                <div id="notificationsDropdownContent">
                  <div class="dropdown-item-text text-muted text-center py-3">
                    <i class="bi bi-bell me-2"></i>No notifications yet
                  </div>
                </div>
              </div>
            </div>

            <a href="artwork-registration.html" class="custom-btn btn btn-sm"
              >Protect my Art <i class="bi-shield-lock ms-1"></i
            ></a>
            <button
              id="darkModeToggle"
              class="btn btn-outline-primary"
              style="
                border-radius: 50px;
                padding: 0.5rem 0.9rem;
                color: #3498db;
                border-color: #3498db;
              "
            >
              <i class="bi bi-moon dark-mode-icon"></i>
            </button>
          </div>
        </div>
      </div>
    </nav>

    <main class="hub-layout">
      <!-- Left Sidebar -->
      <aside class="sidebar-left d-none d-lg-flex flex-column">
        <div class="sidebar-card profile-card">
          <div class="d-flex align-items-center gap-3 mb-3">
            <img
              id="profileAvatar"
              src="https://placehold.co/80x80"
              class="avatar flex-shrink-0"
              alt="Your profile"
            />
            <div>
              <strong class="d-block" id="profileUsername">Guest</strong>
              <small
                class="text-muted d-block"
                style="font-size: 0.7rem; letter-spacing: 0.5px"
                >ARTIST PROFILE</small
              >
            </div>
          </div>
          <button
            class="btn-brand w-100 mb-2"
            id="quickCreateBtn"
            type="button"
          >
            <i class="bi bi-pencil-square me-1"></i> Create
          </button>
          <div class="d-flex justify-content-between mt-2 small stats">
            <span><strong id="statPosts">0</strong> Posts</span>
            <span><strong id="statFollowing">0</strong> Following</span>
            <span><strong id="statFollowers">0</strong> Followers</span>
          </div>
        </div>

        <!-- Search Section -->
        <div class="sidebar-card">
          <h6 class="sidebar-title">Search & Discover</h6>
          <div class="search-section">
            <div class="input-group input-group-sm mb-3">
              <input
                type="text"
                class="form-control"
                placeholder="Search users..."
                id="userSearchInput"
              />
              <button
                class="btn btn-outline-secondary"
                type="button"
                id="searchUsersBtn"
                style="color: white; border-color: rgba(255, 255, 255, 0.3)"
              >
                <i class="bi bi-search" style="color: white"></i>
              </button>
            </div>
            <div
              id="searchResults"
              class="search-results"
              style="display: none"
            >
              <!-- Search results will be populated here -->
            </div>
          </div>

          <!-- Tags Filter -->
          <div class="tags-filter mt-3">
            <h6 class="sidebar-subtitle">Filter by Tags</h6>
            <div class="input-group input-group-sm mb-2">
              <input
                type="text"
                class="form-control"
                placeholder="Enter tag (e.g., art, digital)"
                id="tagFilterInput"
              />
              <button
                class="btn btn-outline-secondary"
                type="button"
                id="filterByTagBtn"
                style="color: white; border-color: rgba(255, 255, 255, 0.3)"
              >
                <i class="bi bi-funnel" style="color: white"></i>
              </button>
            </div>
            <div class="small text-muted mb-2">Popular tags:</div>
            <div class="tag-buttons" id="popularTags">
              <p class="text-muted small">Loading popular tags...</p>
            </div>
            <button
              class="btn btn-sm btn-outline-secondary mt-2"
              id="clearFiltersBtn"
              style="color: white; border-color: rgba(255, 255, 255, 0.3)"
              onclick="clearTagFilters()"
            >
              <i class="bi bi-x-circle me-1" style="color: white"></i>Clear
              Filters
            </button>
          </div>
        </div>

        <div class="sidebar-card nav-card">
          <ul class="nav flex-column hub-nav">
            <li class="nav-item">
              <a class="nav-link active" href="#" data-hub-nav="feed"
                ><i class="bi bi-house-door me-2"></i> Feed</a
              >
            </li>
            <li class="nav-item">
              <a class="nav-link" href="#" data-hub-nav="explore"
                ><i class="bi bi-compass me-2"></i> Explore</a
              >
            </li>

            <li class="nav-item">
              <a class="nav-link" href="#" data-hub-nav="messages"
                ><i class="bi bi-envelope me-2"></i> Messages</a
              >
            </li>
            <li class="nav-item">
              <a class="nav-link" href="#" data-hub-nav="saved"
                ><i class="bi bi-bookmark me-2"></i> Saved</a
              >
            </li>
            <li class="nav-item admin-only" style="display: none">
              <a class="nav-link" href="#" data-hub-nav="admin"
                ><i class="bi bi-shield-lock me-2"></i> Admin</a
              >
            </li>
            <li class="nav-item">
              <a class="nav-link" href="#" data-hub-nav="settings"
                ><i class="bi bi-gear me-2"></i> Settings</a
              >
            </li>
          </ul>
        </div>
      </aside>

      <!-- Feed Column -->
      <div class="feed-column">
        <div class="create-card" id="uploadUI">
          <div class="d-flex align-items-start gap-3">
            <img
              id="createPostAvatar"
              src="https://placehold.co/80x80"
              class="avatar"
              alt="You"
            />
            <div class="flex-grow-1">
              <textarea
                id="postText"
                rows="3"
                class="form-control"
                placeholder="Share what you are cooking..."
              ></textarea>
              <!-- Image Preview Area -->
              <div id="imagePreviewArea" class="mt-3" style="display: none">
                <div class="position-relative d-inline-block">
                  <img
                    id="imagePreview"
                    src=""
                    alt="Selected image"
                    class="img-fluid rounded"
                    style="max-height: 200px; max-width: 100%"
                  />
                  <button
                    type="button"
                    class="btn btn-sm btn-danger position-absolute top-0 end-0 m-1 rounded-circle"
                    id="removeImageBtn"
                    style="width: 30px; height: 30px; padding: 0"
                  >
                    <i class="bi bi-x"></i>
                  </button>
                </div>
                <div class="small text-muted mt-2">
                  <i class="bi bi-info-circle me-1"></i>Click image to replace
                  or use remove button
                </div>
              </div>

              <!-- Tags Input -->
              <div class="mt-3">
                <input
                  type="text"
                  id="tagsInput"
                  class="form-control form-control-sm mb-2"
                  placeholder="Add tags (e.g., #art #digital #painting)"
                  style="border: 1px solid #e9ecef"
                />
                <div class="nsfw-toggle">
                  <button type="button" class="nsfw-arrow" id="nsfwToggleArrow">
                    <i class="bi bi-chevron-right"></i>
                  </button>
                  <span class="small text-muted">Adult Content</span>
                </div>
                <div class="nsfw-checkbox-container" id="nsfwContainer">
                  <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="nsfwCheck">
                    <label class="form-check-label text-warning" for="nsfwCheck">
                      <i class="bi bi-exclamation-triangle"></i> This content is NSFW (18+)
                    </label>
                  </div>
                </div>
                <div class="small text-muted mt-1">
                  <i class="bi bi-hash me-1"></i>Separate tags with spaces. Tags
                  help others discover your work! Check NSFW for adult content.
                </div>
              </div>

              <div class="create-actions">
                <div class="d-flex gap-2 align-items-center">
                  <button
                    type="button"
                    class="btn-brand-outline"
                    id="addImageBtn"
                  >
                    <i class="bi bi-image me-1"></i>
                    <span id="imageButtonText">Add Image</span>
                  </button>
                  <input
                    type="file"
                    id="imageInput"
                    accept="image/*"
                    style="display: none"
                  />
                  <small class="text-muted" id="imageHint"
                    >PNG, JPG up to 5MB</small
                  >
                  <!-- Image Upload Progress -->
                  <div id="uploadProgress" class="mt-2" style="display: none">
                    <div class="progress" style="height: 4px">
                      <div
                        id="uploadProgressBar"
                        class="progress-bar progress-bar-striped progress-bar-animated"
                        role="progressbar"
                        style="width: 0%"
                      ></div>
                    </div>
                    <small class="text-muted"
                      ><span id="uploadPercentage">0</span>% -
                      <span id="uploadStatus">Processing...</span></small
                    >
                  </div>
                </div>
                <button id="publishBtn" class="btn-brand" type="button">
                  <i class="bi bi-send me-1"></i> Publish
                </button>
              </div>
            </div>
          </div>
        </div>
        <div id="feed"></div>

        <!-- Explore Section -->
        <div id="explore" style="display: none">
          <div class="create-card mb-4">
            <h4> Explore Popular Posts</h4>
            <p class="text-muted mb-0">
              Discover trending artwork and popular posts from the community
            </p>
          </div>
          <div id="exploreContent"></div>
        </div>

        <!-- Notifications now handled by dropdown in navbar -->

        <!-- Messages Section -->
        <div id="messages" style="display: none">
          <div class="create-card mb-4">
            <h4> Messages</h4>
            <p class="text-muted mb-0">
              Connect with other artists and art enthusiasts
            </p>
          </div>
          <div id="messagesContent"></div>
        </div>

        <!-- Saved Section -->
        <div id="saved" style="display: none">
          <div class="create-card mb-4">
            <h4> Saved Posts</h4>
            <p class="text-muted mb-0">
              Your bookmarked posts for later viewing
            </p>
          </div>
          <div id="savedContent"></div>
        </div>

        <!-- Admin Panel Section -->
        <div id="admin" style="display: none">
          <div class="create-card mb-4">
            <h4> Admin Panel</h4>
            <p class="text-muted mb-0">Manage users and content</p>
          </div>
          <div class="row">
            <div class="col-md-6">
              <div class="post-card">
                <h5> Reports</h5>
                <div id="reportsList">
                  <div class="text-muted text-center py-3">No reports yet</div>
                </div>
              </div>
            </div>
            <div class="col-md-6">
              <div class="post-card">
                <h5> User Management</h5>
                <div class="mb-3">
                  <input
                    type="text"
                    class="form-control"
                    id="searchUserInput"
                    placeholder="Search users..."
                  />
                </div>
                <div id="usersList">
                  <div class="text-muted text-center py-3">
                    Search for users to manage
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Context Reviews Section -->
          <div class="row mt-4">
            <div class="col-12">
              <div class="post-card">
                <h5> Context Reviews</h5>
                <p class="text-muted">
                  Review and approve reader context submissions
                </p>
                <div id="contextReviewsContainer">
                  <div class="text-muted text-center py-3">
                    Loading context reviews...
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Settings Section -->
        <div id="settings" style="display: none">
          <div class="create-card mb-4">
            <h4> Settings</h4>
            <p class="text-muted mb-0">Customize your ArtHub experience</p>
          </div>
          <div class="post-card">
            <form id="settingsForm">
              <div class="mb-3">
                <label class="form-label">Profile Picture</label>
                <div class="d-flex align-items-center gap-3 mb-2">
                  <img
                    id="currentAvatar"
                    src="https://placehold.co/80x80"
                    class="rounded-circle"
                    style="width: 80px; height: 80px; object-fit: cover"
                    alt="Current Avatar"
                  />
                  <div>
                    <input
                      type="file"
                      class="form-control"
                      id="avatarUpload"
                      accept="image/*"
                      style="display: none"
                    />
                    <button
                      type="button"
                      class="btn btn-primary btn-sm text-white"
                      onclick="document.getElementById('avatarUpload').click()"
                    >
                      Choose Image
                    </button>
                    <div class="small text-muted mt-1">
                      JPG, PNG, GIF up to 1MB (auto-compressed with cropping)
                    </div>
                  </div>
                </div>
              </div>
              <div class="mb-3">
                <label class="form-label">Privacy</label>
                <select class="form-select" id="settingPrivacy">
                  <option value="public">Public Profile</option>
                  <option value="friends">Friends Only</option>
                  <option value="private">Private</option>
                </select>
              </div>

              <!-- Username Change Section -->
              <div class="mb-3">
                <label class="form-label">Username</label>
                <div class="input-group">
                  <input
                    type="text"
                    class="form-control"
                    id="settingUsername"
                    placeholder="Current username"
                  />
                  <button
                    class="btn btn-primary"
                    type="button"
                    id="changeUsernameBtn"
                  >
                    Change
                  </button>
                </div>
                <div class="form-text text-muted" id="usernameChangeInfo">
                  Username changes have a 7-day cooldown
                </div>
                <div id="aliasesSection" class="mt-2" style="display: none">
                  <small class="text-muted">Previous aliases:</small>
                  <div
                    id="aliasesList"
                    class="d-flex flex-wrap gap-1 mt-1"
                  ></div>
                  <button
                    class="btn btn-sm btn-outline-secondary mt-1"
                    id="clearAliasesBtn"
                    style="display: none"
                  >
                    Clear Aliases
                  </button>
                </div>
              </div>

              <!-- Password Change Section -->
              <div class="mb-3">
                <label class="form-label">Password</label>
                <div class="mb-2">
                  <input
                    type="password"
                    class="form-control"
                    id="currentPassword"
                    placeholder="Current password"
                  />
                </div>
                <div class="mb-2">
                  <input
                    type="password"
                    class="form-control"
                    id="newPassword"
                    placeholder="New password"
                    minlength="8"
                  />
                </div>
                <div class="mb-2">
                  <input
                    type="password"
                    class="form-control"
                    id="confirmNewPassword"
                    placeholder="Confirm new password"
                  />
                </div>
                <button
                  class="btn btn-primary text-white"
                  type="button"
                  id="changePasswordBtn"
                >
                  Change Password
                </button>
                <div class="form-text text-muted">
                  Password must be at least 8 characters and contain at least
                  one number
                </div>
              </div>
              <div class="mb-3">
                <div class="form-check">
                  <input
                    class="form-check-input"
                    type="checkbox"
                    id="settingNotifications"
                  />
                  <label class="form-check-label" for="settingNotifications">
                    Enable Notifications
                  </label>
                </div>
              </div>
              <div class="mb-3">
                <div class="form-check">
                  <input
                    class="form-check-input"
                    type="checkbox"
                    id="settingAutoplay"
                  />
                  <label class="form-check-label" for="settingAutoplay">
                    Autoplay Videos
                  </label>
                </div>
              </div>
              <button type="submit" class="btn btn-brand">Save Settings</button>
            </form>
          </div>
        </div>
      </div>

      <!-- Right Sidebar -->
      <aside class="sidebar-right d-none d-xl-flex flex-column">
        <div class="sidebar-card suggestions-card">
          <h6 class="sidebar-title">Suggested Artists</h6>
          <ul class="list-unstyled mb-0" id="suggestedList"></ul>
        </div>
        <div class="sidebar-card trends-card">
          <h6 class="sidebar-title">Trending Tags</h6>
          <div class="trending-tags" id="trendingTags">
            <p class="text-muted small">Loading trending tags...</p>
          </div>
        </div>
        <div class="sidebar-card info-card small">
          <h6 class="sidebar-title">Community Tips</h6>
          <p class="mb-2 small" style="font-size: 0.7rem">
            Add readers context to disclose tools or AI usage for better trust.
            Respect others' rights. Report misuse responsibly.
          </p>
          <p class="mb-0 small" style="font-size: 0.7rem">
            This website is under development, you may encounter "weirdness".
          </p>
        </div>
      </aside>
    </main>

    <!-- Floating new post button (mobile) -->
    <button class="fab-new" id="fabNew" title="New Post">
      <i class="bi bi-plus"></i>
    </button>

    <!-- Lightbox Modal -->
    <div class="lightbox-backdrop" id="lightbox">
      <div class="lightbox-content">
        <button class="lightbox-close" id="lightboxClose" aria-label="Close">
          <i class="bi bi-x"></i>
        </button>
        <img src="" alt="Artwork" id="lightboxImg" />
        <div class="lightbox-caption" id="lightboxCaption"></div>
      </div>
    </div>

    <!-- Toasts -->
    <div class="toast-container position-fixed bottom-0 end-0 p-3">
      <div
        id="toastGeneric"
        class="toast toast-brand align-items-center border-0"
        role="alert"
        aria-live="assertive"
        aria-atomic="true"
      >
        <div class="d-flex">
          <div class="toast-body" id="toastMessage">Action complete.</div>
          <button
            type="button"
            class="btn-close btn-close-white me-2 m-auto"
            data-bs-dismiss="toast"
            aria-label="Close"
          ></button>
        </div>
      </div>
    </div>

    <!-- Auth Modals -->
    <div class="modal fade" id="authModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content" id="authModalContent">
          <div class="modal-header">
            <h5 class="modal-title" id="authModalTitle">Login</h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
              aria-label="Close"
            ></button>
          </div>
          <div class="modal-body">
            <form id="authForm" novalidate>
              <div
                id="authError"
                class="alert alert-danger py-2 px-3 d-none"
                style="font-size: 0.8rem"
              ></div>

              <!-- Login Fields -->
              <div id="loginFields">
                <div class="form-floating mb-3">
                  <input
                    type="text"
                    class="form-control"
                    id="loginIdentifier"
                    placeholder="username or email"
                    required
                  />
                  <label for="loginIdentifier">Username or Email</label>
                </div>
                <div class="form-floating mb-3">
                  <input
                    type="password"
                    class="form-control"
                    id="loginPassword"
                    placeholder="password"
                    required
                  />
                  <label for="loginPassword">Password</label>
                </div>
                <div class="text-center mb-3">
                  <button
                    type="button"
                    class="btn btn-link btn-sm"
                    id="forgotPasswordBtn"
                  >
                    Forgot Password?
                  </button>
                </div>
              </div>

              <!-- Register Fields -->
              <div id="registerExtra" style="display: none">
                <div class="form-floating mb-3">
                  <input
                    type="text"
                    class="form-control"
                    id="regUsername"
                    placeholder="username"
                    maxlength="50"
                    pattern="[a-zA-Z0-9_\-\.\s]+"
                    title="Username can only contain letters, numbers, spaces, underscores, hyphens, and periods"
                    required
                  />
                  <label for="regUsername">Username</label>
                  <div class="invalid-feedback" id="usernameError" style="display: none;">
                    Username contains invalid characters. Only letters, numbers, spaces, and basic symbols are allowed.
                  </div>
                </div>
                <div class="form-floating mb-3">
                  <input
                    type="email"
                    class="form-control"
                    id="regEmail"
                    placeholder="email"
                    maxlength="100"
                    pattern="[a-zA-Z0-9._%+\-]+@[a-zA-Z0-9.\-]+\.[a-zA-Z]{2,}"
                    title="Please enter a valid email address"
                    required
                  />
                  <label for="regEmail">Email</label>
                  <div class="invalid-feedback" id="emailError" style="display: none;">
                    Please enter a valid email address (e.g., user@example.com)
                  </div>
                </div>
                <div class="form-floating mb-3">
                  <input
                    type="password"
                    class="form-control"
                    id="regPassword"
                    placeholder="password"
                    required
                    minlength="8"
                    pattern="^(?=.*[0-9])(?=.*[a-zA-Z]).{8,}$"
                  />
                  <label for="regPassword">Password</label>
                  <div class="form-text text-muted">
                    Password must be at least 8 characters and contain at least
                    one number
                  </div>
                </div>

                <!-- reCAPTCHA -->
                <div class="mb-3">
                  <div id="recaptcha-container"></div>
                </div>
              </div>

              <!-- Email Verification Step -->
              <div id="emailVerificationStep" style="display: none">
                <div class="text-center mb-3">
                  <i
                    class="bi bi-envelope-check"
                    style="font-size: 3rem; color: var(--bs-primary)"
                  ></i>
                  <h5 class="mt-2">Verify Your Email</h5>
                  <p class="text-muted">
                    We've sent a 6-digit code to your email address
                  </p>
                </div>
                <div class="form-floating mb-3">
                  <input
                    type="text"
                    class="form-control text-center"
                    id="verificationCode"
                    placeholder="000000"
                    maxlength="6"
                    pattern="[0-9]{6}"
                    required
                  />
                  <label for="verificationCode">Verification Code</label>
                </div>
                <div class="d-grid gap-2">
                  <button
                    type="button"
                    class="btn btn-outline-secondary"
                    id="resendVerificationBtn"
                    onclick="resendVerificationCode()"
                  >
                    <i class="bi bi-arrow-repeat me-1"></i>
                    <span id="resendText">Resend Code</span>
                    <span id="resendCountdown" style="display: none;">Resend in <span id="countdownTimer">60</span>s</span>
                  </button>
                </div>
              </div>

              <!-- Remember Me - Only for Login -->
              <div class="form-check mb-3" id="rememberMeSection">
                <input
                  class="form-check-input"
                  type="checkbox"
                  id="rememberMe"
                />
                <label class="form-check-label" for="rememberMe">
                  Remember me
                </label>
              </div>

              <button
                type="submit"
                class="w-100 btn btn-brand"
                id="authSubmitBtn"
              >
                Login
              </button>
              <div class="text-center mt-3 mini-link">
                <span
                  id="toggleAuthMode"
                  class="pointer text-decoration-underline"
                  >Need an account? Register</span
                >
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>

    <!-- Settings Modal -->
    <div class="modal fade" id="settingsModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Profile Settings</h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
              aria-label="Close"
            ></button>
          </div>
          <div class="modal-body">
            <!-- Profile Picture Section -->
            <div class="row mb-4">
              <div class="col-md-4 text-center">
                <h6 class="mb-3">Profile Picture</h6>
                <div class="position-relative d-inline-block">
                  <img
                    id="settingsProfilePic"
                    src="https://placehold.co/120x120"
                    class="rounded-circle mb-3"
                    style="
                      width: 120px;
                      height: 120px;
                      object-fit: cover;
                      border: 3px solid #e9ecef;
                    "
                    alt="Profile Picture"
                  />
                  <button
                    type="button"
                    class="btn btn-sm btn-primary rounded-circle position-absolute"
                    style="bottom: 10px; right: 0px; width: 35px; height: 35px"
                    onclick="document.getElementById('profilePicInput').click()"
                  >
                    <i class="bi bi-camera"></i>
                  </button>
                </div>
                <input
                  type="file"
                  id="profilePicInput"
                  accept="image/*"
                  style="display: none"
                  multiple
                />
                <div class="small text-muted mt-2">
                  Click camera to upload<br />Max: 5MB per image
                </div>
              </div>
              <div class="col-md-8">
                <h6 class="mb-3">Account Information</h6>
                <form id="settingsForm">
                  <div class="mb-3">
                    <label for="settingsUsername" class="form-label">
                      Username
                      <div class="alias-history">
                        <button
                          type="button"
                          class="btn btn-sm btn-outline-secondary alias-dropdown-toggle"
                          id="aliasDropdownBtn"
                          title="Previous usernames"
                        >
                          <i class="bi bi-arrow-down-circle"></i>
                        </button>
                        <div class="alias-list" id="aliasList">
                          <!-- Previous aliases will be populated here -->
                        </div>
                        <button
                          type="button"
                          class="btn btn-sm btn-outline-danger"
                          id="clearAliasBtn"
                          title="Clear alias history"
                        >
                          <i class="bi bi-trash"></i>
                        </button>
                      </div>
                    </label>
                    <input
                      type="text"
                      class="form-control"
                      id="settingsUsername"
                      placeholder="Enter your username"
                    />
                    <div
                      id="usernameCooldown"
                      class="username-cooldown"
                      style="display: none"
                    ></div>
                    <div class="form-text">
                      You can change your username once per week
                    </div>
                  </div>
                  <div class="mb-3">
                    <label for="settingsEmail" class="form-label">Email</label>
                    <input
                      type="email"
                      class="form-control"
                      id="settingsEmail"
                      placeholder="Enter your email"
                    />
                  </div>
                  <div class="mb-3">
                    <label for="aboutMe" class="form-label">About Me</label>
                    <textarea
                      class="form-control"
                      id="aboutMe"
                      rows="4"
                      placeholder="Tell us about yourself, your art style, inspirations..."
                    ></textarea>
                    <div class="form-text">
                      Share your artistic journey and what inspires you (max 500
                      characters)
                    </div>
                  </div>
                  <div class="mb-3">
                    <label for="settingPrivacy" class="form-label"
                      >Privacy</label
                    >
                    <select class="form-select" id="settingPrivacy">
                      <option value="public">Public Profile</option>
                      <option value="private">Private Profile</option>
                    </select>
                  </div>
                  <div class="mb-3">
                    <div class="form-check">
                      <input
                        class="form-check-input"
                        type="checkbox"
                        id="settingNotifications"
                        checked
                      />
                      <label
                        class="form-check-label"
                        for="settingNotifications"
                      >
                        Enable notifications
                      </label>
                    </div>
                  </div>
                  <div class="mb-3">
                    <div class="form-check">
                      <input
                        class="form-check-input"
                        type="checkbox"
                        id="settingAutoplay"
                      />
                      <label class="form-check-label" for="settingAutoplay">
                        Auto-play videos
                      </label>
                    </div>
                  </div>
                </form>
              </div>
            </div>

            <!-- Profile Portfolio Section -->
            <div class="profile-header mb-4">
              <h6 class="mb-3">
                <i class="bi bi-person-workspace me-2"></i>Artist Portfolio
              </h6>
              <div class="row">
                <div class="col-md-6">
                  <div class="profile-portfolio">
                    <h6 class="mb-2">
                      <i class="bi bi-palette me-1"></i>Art Stats
                    </h6>
                    <div class="row text-center">
                      <div class="col-4">
                        <div class="fw-bold" id="userPostCount">0</div>
                        <small class="text-muted">Posts</small>
                      </div>
                      <div class="col-4">
                        <div class="fw-bold" id="userLikesReceived">0</div>
                        <small class="text-muted">Likes</small>
                      </div>
                      <div class="col-4">
                        <div class="fw-bold" id="userFollowers">0</div>
                        <small class="text-muted">Followers</small>
                      </div>
                    </div>
                  </div>
                </div>
                <div class="col-md-6">
                  <div class="profile-portfolio">
                    <h6 class="mb-2">
                      <i class="bi bi-trophy me-1"></i>Achievements
                    </h6>
                    <div id="userAchievements">
                      <div class="d-flex align-items-center mb-2">
                        <i class="bi bi-star-fill text-warning me-2"></i>
                        <span class="small"
                          >Member since <span id="memberSince">-</span></span
                        >
                      </div>
                      <div class="d-flex align-items-center mb-2">
                        <i class="bi bi-heart-fill text-danger me-2"></i>
                        <span class="small">Art Enthusiast</span>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Multiple Images Preview Section -->
            <div id="imagePreviewSection" style="display: none">
              <h6 class="mb-3">Selected Images</h6>
              <div id="imagePreviewContainer" class="row g-2 mb-3">
                <!-- Image previews will be inserted here -->
              </div>
              <div class="d-flex gap-2 mb-3">
                <button
                  type="button"
                  class="btn btn-outline-primary btn-sm"
                  onclick="document.getElementById('profilePicInput').click()"
                >
                  <i class="bi bi-plus-circle me-1"></i> Add More Images
                </button>
                <button
                  type="button"
                  class="btn btn-outline-secondary btn-sm"
                  id="clearAllImages"
                >
                  <i class="bi bi-trash me-1"></i> Clear All
                </button>
              </div>
            </div>
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              data-bs-dismiss="modal"
            >
              Cancel
            </button>
            <button type="button" class="btn btn-brand" id="saveSettings">
              <i class="bi bi-check-circle me-1"></i> Save Changes
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Image Cropping Modal -->
    <div
      class="modal fade"
      id="imageCropModal"
      tabindex="-1"
      aria-hidden="true"
    >
      <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Crop Image</h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
              aria-label="Close"
            ></button>
          </div>
          <div class="modal-body text-center">
            <div
              class="crop-container"
              style="max-height: 400px; overflow: hidden"
            >
              <img id="cropImage" style="max-width: 100%; max-height: 400px" />
            </div>
            <div class="mt-3">
              <div class="btn-group" role="group">
                <button
                  type="button"
                  class="btn btn-outline-secondary btn-sm"
                  id="cropReset"
                >
                  <i class="bi bi-arrow-clockwise"></i> Reset
                </button>
                <button
                  type="button"
                  class="btn btn-outline-secondary btn-sm"
                  id="cropRotateLeft"
                >
                  <i class="bi bi-arrow-counterclockwise"></i> Rotate Left
                </button>
                <button
                  type="button"
                  class="btn btn-outline-secondary btn-sm"
                  id="cropRotateRight"
                >
                  <i class="bi bi-arrow-clockwise"></i> Rotate Right
                </button>
              </div>
            </div>
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              data-bs-dismiss="modal"
            >
              Cancel
            </button>
            <button type="button" class="btn btn-primary" id="cropSave">
              <i class="bi bi-check-circle me-1"></i> Apply Crop
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Notifications Panel -->
    <div
      class="offcanvas offcanvas-end"
      tabindex="-1"
      id="notificationsPanel"
      aria-labelledby="notificationsPanelLabel"
    >
      <div class="offcanvas-header">
        <h5 class="offcanvas-title" id="notificationsPanelLabel">
          Notifications
        </h5>
        <button
          type="button"
          class="btn-close"
          data-bs-dismiss="offcanvas"
          aria-label="Close"
        ></button>
      </div>
      <div class="offcanvas-body">
        <div class="d-flex justify-content-between align-items-center mb-3">
          <span class="small text-muted">Recent Activity</span>
          <button class="btn btn-sm btn-outline-secondary" id="markAllReadBtn">
            Mark All Read
          </button>
        </div>
        <div id="notificationsList">
          <div class="text-center text-muted py-3">
            <i class="bi bi-bell-slash display-6"></i>
            <p class="mt-2">No notifications yet</p>
          </div>
        </div>
      </div>
    </div>

    <!-- Comments Modal -->
    <div class="modal fade" id="commentsModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Comments</h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
              aria-label="Close"
            ></button>
          </div>
          <div class="modal-body" style="max-height: 400px; overflow-y: auto">
            <div id="commentsList"></div>
          </div>
          <div class="modal-footer">
            <div class="input-group">
              <input
                type="text"
                class="form-control"
                id="commentText"
                placeholder="Write a comment..."
              />
              <button class="btn btn-brand" type="button" id="postCommentBtn">
                <i class="bi bi-send me-1"></i> Post
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Report Modal -->
    <div class="modal fade" id="reportModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Report Post</h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
              aria-label="Close"
            ></button>
          </div>
          <div class="modal-body">
            <p>Why are you reporting this post?</p>
            <div class="mb-3">
              <select class="form-select" id="reportReason">
                <option value="">Select a reason...</option>
                <option value="ai_use">Undisclosed AI use</option>
                <option value="spam">Spam</option>
                <option value="harassment">Harassment</option>
                <option value="inappropriate">Inappropriate content</option>
                <option value="copyright">Copyright violation</option>
                <option value="fake">Fake or misleading</option>
                <option value="other">Other</option>
              </select>
            </div>
            <div class="mb-3">
              <textarea
                class="form-control"
                id="reportDetails"
                rows="3"
                placeholder="Additional details (optional)..."
              ></textarea>
            </div>
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              data-bs-dismiss="modal"
            >
              Cancel
            </button>
            <button type="button" class="btn btn-danger" id="submitReport">
              Submit Report
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Email Input Modal -->
    <div class="modal fade" id="emailInputModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Reset Password</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <p>Enter your email address to receive a password reset code:</p>
            <div class="mb-3">
              <label for="resetEmailInput" class="form-label">Email Address</label>
              <input type="email" class="form-control" id="resetEmailInput" placeholder="Enter your email address">
              <div class="form-text">We'll send you a 6-digit reset code via email.</div>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
            <button type="button" class="btn btn-primary" onclick="requestPasswordReset()">
              <i class="bi bi-envelope me-1"></i>Send Reset Code
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Age Verification Modal -->
    <div class="modal fade age-verification-modal" id="ageVerificationModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Age Verification Required</h5>
          </div>
          <div class="modal-body text-center">
            <i class="bi bi-exclamation-triangle" style="font-size: 3rem; margin-bottom: 1rem;"></i>
            <h6>Content Warning</h6>
            <p>This content is marked as NSFW (Not Safe For Work) and may contain mature themes.</p>
            <p><strong>You must be 18 years or older to view this content.</strong></p>
            <div class="form-check d-flex justify-content-center mb-3">
              <input class="form-check-input me-2" type="checkbox" id="ageConfirm">
              <label class="form-check-label" for="ageConfirm">
                I confirm that I am 18 years of age or older
              </label>
            </div>
          </div>
          <div class="modal-footer justify-content-center">
            <button type="button" class="btn btn-outline-light" data-bs-dismiss="modal">Cancel</button>
            <button type="button" class="btn btn-light" onclick="revealNSFWContent(this)" disabled id="confirmBtn">
              View Content
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Forgot Password Modal -->
    <div class="modal fade" id="forgotPasswordModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Reset Password</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <p>Enter the reset code that was sent to your email:</p>
            <div class="mb-3">
              <label for="backupCodeInput" class="form-label">Reset Code</label>
              <input type="text" class="form-control" id="backupCodeInput" placeholder="Enter 6-digit reset code">
              <div class="form-text">Check your email for the 6-digit password reset code.</div>
            </div>
            <div class="mb-3">
              <label for="newPasswordInput" class="form-label">New Password</label>
              <input type="password" class="form-control" id="newPasswordInput" placeholder="Enter new password">
            </div>
            <div class="mb-3">
              <label for="confirmPasswordInput" class="form-label">Confirm New Password</label>
              <input type="password" class="form-control" id="confirmPasswordInput" placeholder="Confirm new password">
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
            <button type="button" class="btn btn-primary" onclick="resetPasswordWithBackup()">
              <i class="bi bi-key me-1"></i>Reset Password
            </button>
          </div>
        </div>
      </div>
    </div>

    <script src="js/bootstrap.min.js"></script>
    <!-- Load Firebase configuration -->
    <script type="text/javascript" src="firebase-config-local.js"></script>
    <script type="module" src="firebase-config.js"></script>
    <script src="js/arthub-client.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>
    <script>
      // Username sanitization function for email compatibility (Global scope)
      function sanitizeUsernameForEmail(username) {
        if (!username || typeof username !== 'string') return '';
        
        return username
          .toLowerCase()
          .replace(/[^a-z0-9._-]/g, '') // Remove invalid characters
          .replace(/^[._-]+|[._-]+$/g, '') // Remove leading/trailing special chars
          .replace(/[._-]{2,}/g, '.') // Replace multiple special chars with single dot
          .substring(0, 30); // Limit length for email compatibility
      }
      
      // Email sanitization function for EmailJS compatibility (Global scope)
      function sanitizeEmailForEmailJS(email) {
        if (!email || typeof email !== 'string') return '';
        
        // Basic email validation and cleanup
        return email
          .toLowerCase()
          .trim()
          .replace(/[^a-z0-9@._-]/g, '') // Keep only valid email characters
          .substring(0, 254); // RFC 5321 email length limit
      }
      
      // --- Dark Mode and Navbar Scroll Behavior (synced with index.html) ---
      (function () {
        const darkModeBtn = document.getElementById("darkModeToggle");
        const siteLogo = document.getElementById("siteLogo");
        const icon = darkModeBtn.querySelector("i");
        const navbar = document.querySelector(".navbar");

        // Logo paths
        const logoLight = "logo.png"; // Dark logo for light mode when scrolled
        const logoWhite = "whitelogo.png"; // White logo for top of page & dark mode

        // Function to update logo based on scroll and dark mode
        function updateLogo() {
          const isScrolled = window.scrollY >= 50;
          if (document.body.classList.contains("dark-mode")) {
            siteLogo.src = logoWhite; // Always white in dark mode
          } else {
            siteLogo.src = logoLight; // Always dark logo in light mode
          }
        }

        // Navbar scroll behavior
        function handleScroll() {
          // Keep navbar styling consistent
          navbar.classList.add("sticky-nav");
          updateLogo();
        }

        function applyMode(saved) {
          if (saved === "enabled") {
            document.body.classList.add("dark-mode");
            icon.classList.replace("bi-moon", "bi-brightness-high");
          } else {
            document.body.classList.remove("dark-mode");
            icon.classList.replace("bi-brightness-high", "bi-moon");
          }
          updateLogo();
        }

        // Initialize
        applyMode(localStorage.getItem("darkMode"));
        handleScroll(); // Initial check

        // Event listeners
        window.addEventListener("scroll", handleScroll);
        darkModeBtn.addEventListener("click", () => {
          const enable = !document.body.classList.contains("dark-mode");
          localStorage.setItem("darkMode", enable ? "enabled" : "disabled");
          applyMode(localStorage.getItem("darkMode"));
        });
      })();

      // --- Auth & Client-side Integration ---
      let auth = { token: null, user: null };

      // Global reference for consistency (wait for Firebase to be ready)
      let artHubClient = null;
      
      // EmailJS test function for debugging
      async function testEmailJS(email) {
        try {
          console.log('Testing EmailJS with email:', email);
          
          // Test with minimal parameters first
          const testParams = {
            to: email,
            email: email,
            message: 'Test message'
          };
          
          const result = await emailjs.send("service_7apbhjx", "template_plk5vid", testParams);
          console.log('EmailJS test successful:', result);
          return true;
        } catch (error) {
          console.error('EmailJS test failed:', error);
          return false;
        }
      }
      
      // Link extraction utilities
      function extractLinksFromText(text) {
        if (!text) return { cleanText: '', links: [] };
        const urlRegex = /(https?:\/\/[^\s]+)/g;
        const links = [];
        let match;
        
        while ((match = urlRegex.exec(text)) !== null) {
          links.push(match[1]);
        }
        
        return {
          cleanText: text.replace(urlRegex, '').trim(),
          links: links
        };
      }
      
      function renderReferences(links) {
        if (!links || links.length === 0) return '';
        
        return `
          <div class="references-section mt-3 pt-3" style="border-top: 1px solid rgba(220, 53, 69, 0.2);">
            <h6 class="mb-2" style="color: #3498db; font-size: 0.8rem; font-weight: 600;">
              <i class="bi bi-link-45deg me-1"></i>References
            </h6>
            <div class="references-list">
              ${links.map((link, index) => `
                <div class="reference-item mb-1">
                  <small class="text-muted">[${index + 1}]</small>
                  <a href="${link}" target="_blank" rel="noopener noreferrer" class="text-decoration-none ms-1" style="font-size: 0.8rem;">
                    ${link.length > 50 ? link.substring(0, 47) + '...' : link}
                    <i class="bi bi-box-arrow-up-right ms-1" style="font-size: 0.7rem;"></i>
                  </a>
                </div>
              `).join('')}
            </div>
          </div>
        `;
      }

      // Initialize Firebase client reference when ready
      function initializeClient() {
        if (
          window.firebaseArtHubClient &&
          typeof window.firebaseArtHubClient.getSavedPosts === "function"
        ) {
          artHubClient = window.firebaseArtHubClient;
          console.log(" Firebase client initialized successfully");
          console.log(" Client has getTrendingTags method:", typeof window.firebaseArtHubClient.getTrendingTags === "function");
          return true;
        }
        console.log(" Firebase client not ready yet...");
        return false;
      }

      function loadAuth() {
        const user = window.firebaseArtHubClient.getCurrentUser();
        if (user) {
          auth.token = localStorage.getItem("arthub_token");
          auth.user = user;
        }
      }
      function saveAuth() {
        if (auth.token && auth.user) {
          localStorage.setItem("arthub_token", auth.token);
          localStorage.setItem("arthub_user", JSON.stringify(auth.user));
        } else {
          localStorage.removeItem("arthub_token");
          localStorage.removeItem("arthub_user");
          artHubClient.logout();
        }
      }

      async function postEnhancedReply(commentId, input) {
        const user = getCurrentUser();
        if (!user) {
          showAuthModal();
          return;
        }
        
        const text = input.value.trim();
        if (!text) return;
        
        const btn = input.parentElement.querySelector('.enhanced-reply-post');
        const originalContent = btn.innerHTML;
        
        btn.innerHTML = '<span class="spinner-border spinner-border-sm" style="width: 12px; height: 12px;"></span>';
        btn.disabled = true;
        input.disabled = true;
        
        try {
          // This would need to be implemented in the backend
          // await window.firebaseArtHubClient.addReply(commentId, text);
          
          // For now, show success feedback
          input.style.borderColor = 'rgba(40, 167, 69, 0.5)';
          toast('Reply posted! ', 'success');
          
          // Remove reply input after success
          setTimeout(() => {
            const replyDiv = input.closest('.reply-input');
            replyDiv.style.opacity = '0';
            replyDiv.style.transform = 'translateY(-10px)';
            setTimeout(() => replyDiv.remove(), 300);
          }, 1000);
          
        } catch (error) {
          input.style.borderColor = 'rgba(220, 53, 69, 0.5)';
          toast('Failed to post reply: ' + error.message, 'error');
        } finally {
          btn.innerHTML = originalContent;
          btn.disabled = false;
          input.disabled = false;
        }
      }
      
      function updateAllCommentInputs() {
        const commentInputs = document.querySelectorAll('.enhanced-comment-input');
        commentInputs.forEach(input => {
          const container = input.closest('.quick-comment-input');
          if (container) {
            const avatar = container.querySelector('.user-avatar-comment');
            const authPrompt = container.querySelector('.auth-prompt');
            const actions = container.querySelector('.comment-actions');
            updateCommentInputAuth(container, input, avatar, authPrompt, actions);
          }
        });
      }
      
      function authUI() {
        const box = document.getElementById("authMini");
        if (!box) return;

        // Refresh user data from Firebase client
        auth.user = window.firebaseArtHubClient.getCurrentUser();
        
        // Debug admin status if user is potentially admin
        if (auth.user && (auth.user.username === 'Kiyoshi' || auth.user.username === 'kiyoshi')) {
          console.log('Admin user loaded:', {
            username: auth.user.username,
            is_admin: auth.user.is_admin,
            isAdminFunction: isAdmin()
          });
        }

        if (auth.user) {
          // Debug: Log admin status
          if (auth.user.username === 'Kiyoshi' || auth.user.username === 'kiyoshi') {
            console.log('Admin user detected:', auth.user.username, 'isAdmin:', isAdmin());
          }
          
          box.innerHTML =
            '<span class="text-success me-2">@' +
            auth.user.username +
            (isAdmin() ? ' <span class="badge bg-danger ms-1">ADMIN</span>' : '') +
            '</span><button class="btn btn-sm btn-brand-outline" id="logoutBtn">Logout</button>';

          const profileUsernameEl = document.getElementById("profileUsername");
          if (profileUsernameEl)
            profileUsernameEl.textContent = auth.user.username;

          // Update profile avatars if available
          const profileAvatar = document.getElementById("profileAvatar");
          const createPostAvatar = document.getElementById("createPostAvatar");
          const commentAvatars = document.querySelectorAll(".user-avatar-comment");

          if (auth.user.profile_picture) {
            if (profileAvatar) profileAvatar.src = auth.user.profile_picture;
            if (createPostAvatar)
              createPostAvatar.src = auth.user.profile_picture;
            commentAvatars.forEach(avatar => avatar.src = auth.user.profile_picture);
          }

          // Show admin navigation if user is admin
          const adminNav = document.querySelector(".admin-only");
          if (adminNav) {
            adminNav.style.display = isAdmin() ? "block" : "none";
          }
        } else {
          box.innerHTML =
            '<button class="btn btn-sm btn-brand me-1" id="loginBtn">Login</button><button class="btn btn-sm btn-brand-outline" id="registerBtn">Register</button>';
          document.getElementById("profileUsername").textContent = "Guest";

          // Reset profile avatars to placeholder
          const profileAvatar = document.getElementById("profileAvatar");
          const createPostAvatar = document.getElementById("createPostAvatar");
          if (profileAvatar) profileAvatar.src = getDefaultAvatar();
          if (createPostAvatar)
            createPostAvatar.src = getDefaultAvatar();
        }
      }

      // Auth Modal Logic
      let authMode = "login";
      let authModalRef; // bootstrap modal instance
      function openAuth(mode = "login") {
        authMode = mode;
        const title = document.getElementById("authModalTitle");
        const loginFields = document.getElementById("loginFields");
        const registerExtra = document.getElementById("registerExtra");
        const emailVerificationStep = document.getElementById(
          "emailVerificationStep"
        );
        const rememberMeSection = document.getElementById("rememberMeSection");
        const submit = document.getElementById("authSubmitBtn");
        const toggle = document.getElementById("toggleAuthMode");
        const errBox = document.getElementById("authError");
        errBox.classList.add("d-none");

        // Reset all steps
        emailVerificationStep.style.display = "none";

        if (mode === "login") {
          title.textContent = "Login";
          loginFields.style.display = "block";
          registerExtra.style.display = "none";
          rememberMeSection.style.display = "block";
          submit.textContent = "Login";
          toggle.textContent = "Need an account? Register";
        } else {
          title.textContent = "Register";
          loginFields.style.display = "none";
          registerExtra.style.display = "block";
          rememberMeSection.style.display = "none";
          submit.textContent = "Create Account";
          toggle.textContent = "Have an account? Login";

          // Reset reCAPTCHA if switching to register
          if (typeof grecaptcha !== "undefined") {
            try {
              const hostname = window.location.hostname;
              // Only reset for v2 (development), v3 doesn't need reset
              if (hostname !== 'arthub-c46b2.web.app' && hostname !== 'arthub-c46b2.firebaseapp.com') {
                grecaptcha.reset();
              }
            } catch (error) {
              console.warn("reCAPTCHA reset failed:", error);
            }
          }
        }

        // Clear temporary registration data when switching modes
        if (window.tempRegistrationData) {
          delete window.tempRegistrationData;
          delete window.tempVerificationCode;
        }

        if (!authModalRef)
          authModalRef = new bootstrap.Modal(
            document.getElementById("authModal")
          );
        authModalRef.show();
      }

      document.addEventListener("click", (e) => {
        if (e.target.id === "loginBtn") {
          openAuth("login");
        }
        if (e.target.id === "registerBtn") {
          openAuth("register");
        }
        if (e.target.id === "logoutBtn") {
          window.firebaseArtHubClient.logout();
          auth = { token: null, user: null };
          saveAuth();
          authUI();
          updateStats();
          loadFeed(true);
          toast("Logged out");
        }
        if (e.target.id === "toggleAuthMode") {
          openAuth(authMode === "login" ? "register" : "login");
        }

        // Forgot password functionality
        if (e.target.id === "forgotPasswordBtn") {
          showForgotPasswordModal();
        }
      });

      document
        .getElementById("authForm")
        .addEventListener("submit", async (e) => {
          e.preventDefault();
          const errBox = document.getElementById("authError");
          errBox.classList.add("d-none");
          errBox.textContent = "";
          try {
            if (authMode === "login") {
              const usernameOrEmail = document
                .getElementById("loginIdentifier")
                .value.trim();
              const password = document
                .getElementById("loginPassword")
                .value.trim();
              if (!usernameOrEmail || !password)
                throw new Error("Enter credentials");
              const data = await window.firebaseArtHubClient.loginUser(
                usernameOrEmail,
                password
              );
              auth.token = localStorage.getItem("arthub_token");
              auth.user = data.user;
              saveAuth();
              authUI();
              updateStats();
              loadFeed(true);
              loadSuggestions();
              toast("Welcome back @" + auth.user.username);
              authModalRef.hide();
              
              // Automatically refresh the page after successful login
              console.log(" Refreshing page after successful login...");
              
              // Show refresh indicator
              setTimeout(() => {
                toast("Refreshing page...", "info");
              }, 1000);
              
              setTimeout(() => {
                window.location.reload();
              }, 1500); // Wait 1.5 seconds to show welcome message
            } else {
              // Check if we're in email verification step
              const emailVerificationStep = document.getElementById(
                "emailVerificationStep"
              );
              const registerExtra = document.getElementById("registerExtra");

              if (emailVerificationStep.style.display !== "none") {
                // Handle email verification
                const verificationCode = document
                  .getElementById("verificationCode")
                  .value.trim();
                if (!verificationCode || verificationCode.length !== 6) {
                  throw new Error("Please enter the 6-digit verification code");
                }

                // Verify the code (demo implementation)
                if (verificationCode === window.tempVerificationCode) {
                  // Complete registration
                  const data = await window.firebaseArtHubClient.registerUser(
                    window.tempRegistrationData.username,
                    window.tempRegistrationData.email,
                    window.tempRegistrationData.password,
                    false // Skip email verification since we just verified
                  );

                  auth.token = localStorage.getItem("arthub_token");
                  auth.user = data.user;
                  saveAuth();
                  authUI();
                  updateStats();
                  loadFeed(true);
                  loadSuggestions();
                  toast(
                    "Account created and verified @" + auth.user.username,
                    "success"
                  );
                  authModalRef.hide();

                  // Clean up temp data
                  delete window.tempVerificationCode;
                  delete window.tempRegistrationData;
                  
                  // Show refresh indicator
                  setTimeout(() => {
                    toast("Refreshing page to complete setup...", "info");
                  }, 1000);
                  
                  // Automatically refresh the page after successful registration
                  console.log(" Refreshing page after successful registration...");
                  setTimeout(() => {
                    window.location.reload();
                  }, 1500); // Wait 1.5 seconds to show success message
                } else {
                  throw new Error(
                    "Invalid verification code. Please try again."
                  );
                }
              } else {
                // Initial registration step
                const username = document
                  .getElementById("regUsername")
                  .value.trim();
                const email = document.getElementById("regEmail").value.trim();
                const password = document
                  .getElementById("regPassword")
                  .value.trim();
                if (!username || !email || !password)
                  throw new Error("Fill all fields");

                // Validate password
                if (password.length < 8)
                  throw new Error(
                    "Password must be at least 8 characters long"
                  );
                if (!/\d/.test(password))
                  throw new Error("Password must contain at least one number");

                // Verify reCAPTCHA (v3 for production, v2 for development)
                let recaptchaResponse;
                const hostname = window.location.hostname;
                
                if (hostname === 'arthub-c46b2.web.app' || hostname === 'arthub-c46b2.firebaseapp.com') {
                  // reCAPTCHA v3 - execute with action
                  try {
                    recaptchaResponse = await grecaptcha.execute('6LdvxdgrAAAAAIcCXPLCipQV819ARwiuwys2fiq2', {action: 'register'});
                    console.log(' reCAPTCHA v3 token obtained:', recaptchaResponse.substring(0, 20) + '...');
                  } catch (error) {
                    console.error(' reCAPTCHA v3 execution failed:', error);
                    throw new Error("reCAPTCHA verification failed. Please try again.");
                  }
                } else {
                  // reCAPTCHA v2 for development
                  recaptchaResponse = grecaptcha.getResponse();
                  if (!recaptchaResponse) {
                    throw new Error("Please complete the reCAPTCHA verification");
                  }
                }

                // Store registration data temporarily and send verification code
                window.tempRegistrationData = { username, email, password };
                window.tempVerificationCode = Math.floor(
                  100000 + Math.random() * 900000
                ).toString();

                // Send actual email if EmailJS is available
                if (typeof emailjs !== "undefined") {
                  try {
                    console.log(" Attempting to send verification email...");
                    
                    // Sanitize both email and username for EmailJS compatibility
                    const sanitizedEmail = sanitizeEmailForEmailJS(email);
                    const sanitizedUsername = sanitizeUsernameForEmail(username);
                    
                    console.log("Email parameters:", {
                      service: "service_7apbhjx",
                      template: "template_nv9s6ro",
                      originalEmail: email,
                      sanitizedEmail: sanitizedEmail,
                      originalUsername: username,
                      sanitizedUsername: sanitizedUsername,
                      code: window.tempVerificationCode
                    });
                    
                    const result = await emailjs.send("service_7apbhjx", "template_nv9s6ro", {
                      email: sanitizedEmail,
                      user_name: sanitizedUsername,
                      verification_code: window.tempVerificationCode,
                      app_name: "ArtHub",
                      to_email: sanitizedEmail, // Alternative parameter name
                      to_name: sanitizedUsername, // Alternative parameter name
                      recipient_email: sanitizedEmail, // Additional parameter
                      user_email: sanitizedEmail, // Additional parameter
                    });
                    
                    console.log(" EmailJS Success:", result);
                    toast(`Verification code sent to ${email}!`, "success");
                    
                  } catch (error) {
                    console.error(" EmailJS send failed:", error);
                    console.error("Error details:", {
                      message: error.message,
                      text: error.text,
                      status: error.status,
                      name: error.name,
                      stack: error.stack
                    });
                    
                    // Try to provide more specific error messages
                    let errorMessage = "Unknown error";
                    if (error.text) {
                      errorMessage = error.text;
                    } else if (error.message) {
                      errorMessage = error.message;
                    } else if (error.status) {
                      errorMessage = `Service error (${error.status})`;
                    }
                    
                    // For development - show the verification code in console as fallback
                    console.log(" DEV MODE - Verification code:", window.tempVerificationCode);
                    toast(`Email service temporarily unavailable. Check console for verification code.`, "warning");
                    
                    // Don't throw error - allow user to proceed manually
                    // throw new Error(`Failed to send verification email: ${errorMessage}`);
                  }
                } else {
                  console.error(" EmailJS not loaded");
                  toast("Email service not available. Please refresh the page and try again.", "error");
                  throw new Error("Email service not available. Please refresh the page and try again.");
                }

                // Switch to email verification step
                registerExtra.style.display = "none";
                emailVerificationStep.style.display = "block";
                
                // Start resend countdown
                startResendCountdown();

                // Update form button text
                document.querySelector(
                  '#authForm button[type="submit"]'
                ).textContent = "Verify & Create Account";

                // Start resend countdown
                startResendCountdown();
              }
            }
          } catch (err) {
            errBox.textContent = err.message;
            errBox.classList.remove("d-none");
          }
        });

      // Email verification helper functions
      let resendCountdown = 0;
      let resendTimer = null;
      
      function startResendCountdown() {
        resendCountdown = 60;
        const resendBtn = document.getElementById('resendVerificationBtn');
        const resendText = document.getElementById('resendText');
        const countdownDisplay = document.getElementById('resendCountdown');
        const timerDisplay = document.getElementById('countdownTimer');
        
        if (resendBtn && resendText && countdownDisplay && timerDisplay) {
          resendBtn.disabled = true;
          resendText.style.display = 'none';
          countdownDisplay.style.display = 'inline';
          timerDisplay.textContent = resendCountdown;
        }
        
        resendTimer = setInterval(() => {
          resendCountdown--;
          if (timerDisplay) {
            timerDisplay.textContent = resendCountdown;
          }
          
          if (resendCountdown <= 0) {
            clearInterval(resendTimer);
            if (resendBtn && resendText && countdownDisplay) {
              resendBtn.disabled = false;
              resendText.style.display = 'inline';
              countdownDisplay.style.display = 'none';
            }
          }
        }, 1000);
      }
      
      function resendVerificationCode() {
        if (resendCountdown > 0) {
          toast(`Please wait ${resendCountdown} seconds before resending`, 'warning');
          return;
        }
        
        if (!window.tempRegistrationData) {
          toast('Registration data not found. Please start over.', 'error');
          return;
        }
        
        // Generate new verification code
        window.tempVerificationCode = Math.floor(100000 + Math.random() * 900000).toString();
        
        // Send new code via EmailJS
        if (typeof emailjs !== "undefined") {
          console.log(" Resending verification code...");
          // Sanitize both email and username for EmailJS compatibility
          const sanitizedEmail = sanitizeEmailForEmailJS(window.tempRegistrationData.email);
          const sanitizedUsername = sanitizeUsernameForEmail(window.tempRegistrationData.username);
          
          console.log("Resend parameters:", {
            originalEmail: window.tempRegistrationData.email,
            sanitizedEmail: sanitizedEmail,
            originalUsername: window.tempRegistrationData.username,
            sanitizedUsername: sanitizedUsername,
            code: window.tempVerificationCode
          });
          
          emailjs.send("service_7apbhjx", "template_nv9s6ro", {
            email: sanitizedEmail,
            user_name: sanitizedUsername,
            verification_code: window.tempVerificationCode,
            app_name: "ArtHub",
            to_email: sanitizedEmail, // Alternative parameter
            to_name: sanitizedUsername, // Alternative parameter
            recipient_email: sanitizedEmail, // Additional parameter
            user_email: sanitizedEmail, // Additional parameter
          }).then((result) => {
            console.log(" Resend successful:", result);
            toast('New verification code sent!', 'success');
            startResendCountdown();
          }).catch((error) => {
            console.error(" EmailJS resend failed:", error);
            console.error("Resend error details:", {
              message: error.message,
              text: error.text,
              status: error.status
            });
            
            // For development - show the verification code in console as fallback
            console.log(" DEV MODE - New verification code:", window.tempVerificationCode);
            toast(`Email service issue. Check console for new verification code.`, 'warning');
            startResendCountdown(); // Still start countdown to prevent spam
          });
        } else {
          console.error(" EmailJS not available for resend");
          toast('Email service not available. Please refresh the page and try again.', 'error');
        }
      }
      
      function generateBackupCodes() {
        const codes = [];
        for (let i = 0; i < 3; i++) {
          codes.push(Math.random().toString(36).substring(2, 10).toUpperCase());
        }
        return codes;
      }
      
      function hashCode(str) {
        let hash = 0;
        for (let i = 0; i < str.length; i++) {
          const char = str.charCodeAt(i);
          hash = ((hash << 5) - hash) + char;
          hash = hash & hash; // Convert to 32bit integer
        }
        return hash.toString();
      }
      
      // Forgot password functions
      function showForgotPasswordModal() {
        const modal = new bootstrap.Modal(document.getElementById('emailInputModal'));
        modal.show();
      }
      
      function requestPasswordReset() {
        const emailInput = document.getElementById('resetEmailInput');
        if (!emailInput) {
          toast('Email input field not found', 'error');
          return;
        }
        
        const email = emailInput.value.trim();
        
        if (!email) {
          toast('Please enter your email address', 'error');
          return;
        }
        if (!email.includes('@') || !email.includes('.')) {
          toast('Please enter a valid email address', 'error');
          return;
        }
        
        // Validate email format more thoroughly
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        if (!emailRegex.test(email)) {
          toast('Please enter a valid email address format', 'error');
          return;
        }
        
        sendPasswordResetCode(email);
        
        // Close email input modal
        const emailModal = bootstrap.Modal.getInstance(document.getElementById('emailInputModal'));
        emailModal.hide();
      }
      
      async function sendPasswordResetCode(email) {
        const resetCode = Math.floor(100000 + Math.random() * 900000).toString();
        localStorage.setItem('password_reset_code', resetCode);
        localStorage.setItem('password_reset_email', email);
        
        try {
          if (typeof emailjs !== "undefined") {
            // Sanitize email for EmailJS compatibility
            const sanitizedEmail = sanitizeEmailForEmailJS(email);
            
            console.log('Sending reset code:', {
              originalEmail: email,
              sanitizedEmail: sanitizedEmail,
              resetCode: resetCode
            });
            
            const templateParams = {
              to: sanitizedEmail,  // Most common EmailJS recipient parameter
              email: sanitizedEmail,  // Alternative email parameter  
              name: sanitizedEmail.split('@')[0],  // User name from sanitized email
              backup_code: resetCode,  // This matches the EmailJS template variable
              app_name: "ArtHub",
              website_url: window.location.origin,
              recipient_email: sanitizedEmail,  // Additional parameter
              user_email: sanitizedEmail  // Additional parameter
            };            console.log('EmailJS template params:', templateParams);
            
            const result = await emailjs.send("service_7apbhjx", "template_plk5vid", templateParams);
            console.log('EmailJS send result:', result);
            
            toast('Password reset code sent to ' + email, 'success');
          } else {
            throw new Error("EmailJS service not available. Please refresh the page and try again.");
          }
          
          // Show the forgot password modal
          const modal = new bootstrap.Modal(document.getElementById('forgotPasswordModal'));
          modal.show();
        } catch (error) {
          console.error('Failed to send reset code:', error);
          console.error('Error details:', error);
          
          let errorMessage = 'Failed to send password reset code';
          if (error.text && error.text.includes('recipients address is empty')) {
            errorMessage = 'Email address validation failed. Please check your email and try again.';
          } else if (error.message) {
            errorMessage = error.message;
          } else if (error.text) {
            errorMessage = error.text;
          }
          
          toast(errorMessage, 'error');
        }
      }
      
      async function resetPasswordWithBackup() {
        const resetCode = document.getElementById('backupCodeInput').value.trim();
        const newPassword = document.getElementById('newPasswordInput').value;
        const confirmPassword = document.getElementById('confirmPasswordInput').value;
        
        try {
          if (!resetCode || !newPassword || !confirmPassword) {
            throw new Error('Please fill in all fields');
          }
          
          if (newPassword !== confirmPassword) {
            throw new Error('Passwords do not match');
          }
          
          if (newPassword.length < 8) {
            throw new Error('Password must be at least 8 characters');
          }
          
          if (!/\d/.test(newPassword)) {
            throw new Error('Password must contain at least one number');
          }
          
          // Check reset code
          const storedCode = localStorage.getItem('password_reset_code');
          const storedEmail = localStorage.getItem('password_reset_email');
          
          if (resetCode !== storedCode) {
            throw new Error('Invalid reset code');
          }
          
          if (!storedEmail) {
            throw new Error('Reset session expired. Please request a new reset code.');
          }
          
          // Update password in local storage (demo mode)
          const users = JSON.parse(localStorage.getItem('demo_users') || '[]');
          const userIndex = users.findIndex(u => u.email === storedEmail);
          
          if (userIndex === -1) {
            throw new Error('User not found. Please check your email address.');
          }
          
          // Update the user's password
          users[userIndex].password = newPassword;
          localStorage.setItem('demo_users', JSON.stringify(users));
          
          // Also update current user if logged in
          const currentUser = JSON.parse(localStorage.getItem('arthub_user') || 'null');
          if (currentUser && currentUser.email === storedEmail) {
            currentUser.password = newPassword;
            localStorage.setItem('arthub_user', JSON.stringify(currentUser));
          }
          
          // Clear the reset code so it can't be reused
          localStorage.removeItem('password_reset_code');
          localStorage.removeItem('password_reset_email');
          
          toast('Password reset successfully! Please log in with your new password.', 'success');
          
          // Close modal and clear form
          const modal = bootstrap.Modal.getInstance(document.getElementById('forgotPasswordModal'));
          modal.hide();
          document.getElementById('backupCodeInput').value = '';
          document.getElementById('newPasswordInput').value = '';
          document.getElementById('confirmPasswordInput').value = '';
          
          // Show login modal after a brief delay
          setTimeout(() => {
            const authModal = new bootstrap.Modal(document.getElementById('authModal'));
            authModal.show();
          }, 1500);
          
        } catch (error) {
          toast(error.message, 'error');
        }
      }
      
      // Quick approve context function
      async function quickApproveContext(contextId) {
        if (!isAdmin()) {
          toast('Admin access required', 'error');
          return;
        }
        
        try {
          await window.firebaseArtHubClient.adminApproveContext(contextId);
          toast('Context approved', 'success');
          
          // Refresh feed to show updated approval status
          loadFeed(true);
        } catch (error) {
          toast('Failed to approve context: ' + error.message, 'error');
        }
      }

      // Context voting function
      async function voteContext(contextId, vote) {
        if (!auth.token) {
          toast("Please login to vote on context", "warning");
          return;
        }

        try {
          const result = await window.firebaseArtHubClient.voteOnContext(
            contextId,
            vote
          );
          toast(
            `Vote recorded! Context ${
              result.approved ? "approved" : "pending"
            } (${Math.round(result.approvalRate)}% approval)`,
            "success"
          );
          loadFeed(true); // Refresh to show updated votes
        } catch (error) {
          toast("Failed to vote: " + error.message, "error");
        }
      }

      // Enhanced tag filtering
      let selectedTags = new Set();
      
      function toggleTagFilter(tag, element) {
        const tagName = (tag.startsWith('#') ? tag.substring(1) : tag).toLowerCase();
        
        // Clear trending tag selection when using search tags
        currentTrendingTag = null;
        document.querySelectorAll('.trending-tag').forEach(btn => {
          btn.classList.remove('selected');
        });
        
        if (selectedTags.has(tagName)) {
          selectedTags.delete(tagName);
          element.classList.remove('selected');
        } else {
          selectedTags.add(tagName);
          element.classList.add('selected');
        }
        
        console.log(' Currently selected tags:', Array.from(selectedTags));
        
        if (selectedTags.size === 0) {
          console.log(' No tags selected - reverting to default home page');
          loadFeed(true); // Fresh load to show all posts from database
        } else {
          filterPostsByTags();
          updateTagVisualState();
        }
      }
      
      function filterPostsByTags() {
        const posts = document.querySelectorAll('.post-card');
        
        if (selectedTags.size === 0) {
          // Show all posts when no tags are selected
          posts.forEach(post => {
            post.style.display = 'block';
          });
          return;
        }
        
        posts.forEach(post => {
          const postTags = post.querySelectorAll('.tag-chip');
          const postTagNames = Array.from(postTags).map(tag => {
            const tagAttr = tag.getAttribute('data-tag');
            const cleanTag = tagAttr?.startsWith('#') ? tagAttr.substring(1) : tagAttr;
            return cleanTag?.toLowerCase(); // Normalize to lowercase for comparison
          }).filter(Boolean);
          
          // Convert selected tags to lowercase for case-insensitive matching
          const selectedTagsLower = [...selectedTags].map(tag => tag.toLowerCase());
          
          const hasSelectedTag = selectedTagsLower.some(selectedTag => 
            postTagNames.includes(selectedTag)
          );
          
          post.style.display = hasSelectedTag ? 'block' : 'none';
        });
      }
      
      function updateTagVisualState() {
        const allTagChips = document.querySelectorAll('.tag-chip');
        allTagChips.forEach(chip => {
          const tag = chip.getAttribute('data-tag');
          const tagName = tag?.startsWith('#') ? tag.substring(1) : tag;
          const tagNameLower = tagName?.toLowerCase();
          
          // Check if any selected tag matches (case-insensitive)
          const isSelected = [...selectedTags].some(selectedTag => 
            selectedTag.toLowerCase() === tagNameLower
          );
          
          if (isSelected) {
            chip.classList.add('selected');
          } else {
            chip.classList.remove('selected');
          }
        });
      }
      
      function clearTagFilters() {
        console.log(' Clearing all tag filters and reverting to home page...');
        selectedTags.clear();
        currentTrendingTag = null;
        
        // Clear all tag selections across the app
        document.querySelectorAll('.tag-chip').forEach(btn => {
          btn.classList.remove('selected');
        });
        
        // Clear trending tag selection
        document.querySelectorAll('.trending-tag').forEach(btn => {
          btn.classList.remove('selected');
        });
        
        // Clear search input
        const tagFilterInput = document.getElementById('tagFilterInput');
        if (tagFilterInput) {
          tagFilterInput.value = '';
        }
        
        // Revert to default home page by refreshing the feed
        loadFeed(true); // Fresh load to show all posts from database
        console.log(' All filters cleared - showing default home page');
      }
      
      // Comment interaction functions
      async function toggleEnhancedCommentLike(commentId, button) {
        const user = getCurrentUser();
        if (!user) {
          showAuthModal();
          return;
        }
        
        // Prevent multiple rapid clicks with enhanced feedback
        if (button.dataset.processing === 'true') {
          button.style.transform = 'scale(0.9) rotate(5deg)';
          setTimeout(() => button.style.transform = 'scale(1) rotate(0deg)', 200);
          return;
        }
        button.dataset.processing = 'true';
        
        const icon = button.querySelector('i');
        const countEl = button.querySelector('.like-count');
        const wasLiked = button.classList.contains('liked');
        const currentCount = parseInt(countEl?.textContent || '0');
        
        // Enhanced visual feedback with spring animation
        button.style.transition = 'transform 0.2s cubic-bezier(0.68, -0.55, 0.265, 1.55)';
        button.style.transform = 'scale(1.2)';
        setTimeout(() => button.style.transform = 'scale(1)', 200);
        
        // Optimistic UI update with enhanced animations
        if (wasLiked) {
          button.classList.remove('liked', 'text-danger');
          icon.classList.remove('bi-heart-fill');
          icon.classList.add('bi-heart');
          if (countEl) {
            countEl.textContent = Math.max(0, currentCount - 1);
            countEl.style.color = '#6c757d';
            countEl.style.transform = 'scale(0.8)';
            setTimeout(() => countEl.style.transform = 'scale(1)', 150);
          }
        } else {
          button.classList.add('liked', 'text-danger');
          icon.classList.remove('bi-heart');
          icon.classList.add('bi-heart-fill');
          if (countEl) {
            countEl.textContent = currentCount + 1;
            countEl.style.color = '#3498db';
            countEl.style.transform = 'scale(1.3)';
            setTimeout(() => countEl.style.transform = 'scale(1)', 150);
          }
          
          // Enhanced heart animation with particles effect
          icon.style.animation = 'heartBeat 0.6s ease-in-out';
          setTimeout(() => icon.style.animation = '', 600);
          
          // Create floating heart animation
          createFloatingHeart(button);
        }
        
        try {
          const result = await window.firebaseArtHubClient.toggleCommentLike(commentId);
          
          // Update all instances with enhanced sync
          const allCommentLikeBtns = document.querySelectorAll(`[data-comment-id="${commentId}"]`);
          allCommentLikeBtns.forEach(btn => {
            if (btn === button) return; // Skip the clicked button
            
            const btnIcon = btn.querySelector('i');
            const btnCountEl = btn.querySelector('.like-count');
            
            if (result && typeof result.liked !== 'undefined') {
              if (result.liked) {
                btn.classList.add('liked', 'text-danger');
                if (btnIcon) {
                  btnIcon.classList.remove('bi-heart');
                  btnIcon.classList.add('bi-heart-fill');
                }
                if (btnCountEl) {
                  btnCountEl.style.color = '#3498db';
                  btnCountEl.style.transform = 'scale(1.1)';
                  setTimeout(() => btnCountEl.style.transform = 'scale(1)', 200);
                }
              } else {
                btn.classList.remove('liked', 'text-danger');
                if (btnIcon) {
                  btnIcon.classList.remove('bi-heart-fill');
                  btnIcon.classList.add('bi-heart');
                }
                if (btnCountEl) btnCountEl.style.color = '#6c757d';
              }
              if (btnCountEl && result.count !== undefined) {
                btnCountEl.textContent = result.count;
              }
            }
          });
          
        } catch (error) {
          // Enhanced error recovery with visual feedback
          button.style.borderColor = 'rgba(220, 53, 69, 0.5)';
          setTimeout(() => button.style.borderColor = '', 2000);
          
          // Revert optimistic update
          if (wasLiked) {
            button.classList.add('liked', 'text-danger');
            icon.classList.remove('bi-heart');
            icon.classList.add('bi-heart-fill');
            if (countEl) countEl.style.color = '#3498db';
          } else {
            button.classList.remove('liked', 'text-danger');
            icon.classList.remove('bi-heart-fill');
            icon.classList.add('bi-heart');
            if (countEl) countEl.style.color = '#6c757d';
          }
          if (countEl) countEl.textContent = currentCount;
          toast('Failed to update like: ' + error.message, 'error');
        } finally {
          button.dataset.processing = 'false';
        }
      }
      
      function createFloatingHeart(button) {
        const heart = document.createElement('div');
        heart.innerHTML = '';
        heart.style.position = 'absolute';
        heart.style.pointerEvents = 'none';
        heart.style.fontSize = '14px';
        heart.style.zIndex = '9999';
        heart.style.transition = 'all 1s ease-out';
        
        const rect = button.getBoundingClientRect();
        heart.style.left = rect.left + rect.width / 2 + 'px';
        heart.style.top = rect.top + 'px';
        
        document.body.appendChild(heart);
        
        setTimeout(() => {
          heart.style.transform = 'translateY(-30px) scale(0)';
          heart.style.opacity = '0';
        }, 100);
        
        setTimeout(() => heart.remove(), 1100);
      }
      
      // Keep the original function for backwards compatibility
      async function toggleCommentLike(commentId, button) {
        return toggleEnhancedCommentLike(commentId, button);
      }
      
      function showEnhancedReplyInput(commentId, username, button) {
        const user = getCurrentUser();
        if (!user) {
          showAuthModal();
          return;
        }
        
        const commentItem = button.closest('.comment-preview-item');
        let replyInput = commentItem.querySelector('.reply-input');
        
        if (replyInput) {
          replyInput.style.animation = 'slideUp 0.3s ease';
          setTimeout(() => replyInput.remove(), 300);
          return;
        }
        
        replyInput = document.createElement('div');
        replyInput.className = 'reply-input mt-2';
        replyInput.style.opacity = '0';
        replyInput.style.transform = 'translateY(-10px)';
        replyInput.innerHTML = `
          <div class="input-group input-group-sm">
            <img src="${user.profile_picture || getDefaultAvatar()}" class="rounded-circle me-2" width="24" height="24" alt="${escapeHtml(user.username)}">
            <input type="text" class="form-control reply-text-input enhanced-reply-input" placeholder="Reply to ${username}..." data-comment-id="${commentId}" data-username="${username}" style="border: 1px solid rgba(0,123,255,0.3); transition: all 0.3s ease;">
            <button class="btn btn-primary post-reply-btn enhanced-reply-post" type="button" data-comment-id="${commentId}" style="border-radius: 0 15px 15px 0;">
              <i class="bi bi-send"></i>
            </button>
          </div>
        `;
        
        commentItem.appendChild(replyInput);
        
        // Animate in
        setTimeout(() => {
          replyInput.style.transition = 'all 0.3s ease';
          replyInput.style.opacity = '1';
          replyInput.style.transform = 'translateY(0)';
          
          const input = replyInput.querySelector('.reply-text-input');
          input.focus();
          
          // Enhanced input interactions
          input.addEventListener('focus', () => {
            input.style.borderColor = 'rgba(0,123,255,0.6)';
            input.style.boxShadow = '0 0 0 0.2rem rgba(0,123,255,0.1)';
          });
          
          input.addEventListener('blur', (e) => {
            if (!e.relatedTarget || !e.relatedTarget.classList.contains('enhanced-reply-post')) {
              input.style.borderColor = 'rgba(0,123,255,0.3)';
              input.style.boxShadow = 'none';
            }
          });
          
          input.addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && input.value.trim()) {
              postEnhancedReply(commentId, input);
            }
          });
        }, 50);
      }
      
      // Keep original function for backwards compatibility
      function showReplyInput(commentId, username, button) {
        return showEnhancedReplyInput(commentId, username, button);
      }
      
      async function postReply(commentId, button) {
        if (!auth.user) {
          toast('Please login to reply', 'warning');
          return;
        }
        
        const replyInput = button.closest('.reply-input');
        const input = replyInput.querySelector('.reply-text-input');
        const text = input.value.trim();
        const username = input.dataset.username;
        
        if (!text) return;
        
        // Prevent multiple submissions
        if (button.dataset.processing === 'true') return;
        button.dataset.processing = 'true';
        button.disabled = true;
        
        try {
          // For now, we'll treat replies as regular comments with mention
          const postCard = button.closest('.post-card');
          const postId = postCard.querySelector('.like-btn').dataset.postId;
          const replyText = `@${username} ${text}`;
          
          const newComment = await window.firebaseArtHubClient.addComment(postId, replyText);
          
          // Update comment count
          const commentBtn = postCard.querySelector('.comment-btn');
          const commentCountEl = commentBtn?.querySelector('.comment-count');
          if (commentCountEl) {
            const currentCount = parseInt(commentCountEl.textContent || '0');
            commentCountEl.textContent = currentCount + 1;
          }
          
          // Add reply to comments preview
          const commentsPreview = postCard.querySelector('.comments-preview');
          if (commentsPreview) {
            const replyHtml = `
              <div class="comment-preview-item d-flex align-items-start mb-2 ms-3">
                <img src="${auth.user.profile_picture || getDefaultAvatar()}" class="rounded-circle me-2 flex-shrink-0" width="28" height="28" alt="${escapeHtml(auth.user.username)}">
                <div class="flex-grow-1">
                  <div class="d-flex align-items-center">
                    <strong class="me-2">${escapeHtml(auth.user.username)}</strong>
                    <small class="text-muted">just now</small>
                  </div>
                  <p class="mb-1">
                    <span class="text-primary">@${escapeHtml(username)}</span> ${escapeHtml(text)}
                  </p>
                  <div class="comment-actions">
                    <button class="btn btn-sm btn-link p-0 me-2 comment-like-btn" onclick="toggleCommentLike('${newComment.id}', this)">
                      <i class="bi bi-heart"></i> <span class="like-count">0</span>
                    </button>
                  </div>
                </div>
              </div>
            `;
            commentsPreview.insertAdjacentHTML('beforeend', replyHtml);
          }
          
          // Remove reply input
          replyInput.remove();
          
          toast('Reply posted!', 'success');
          updateNotificationBadge();
          
        } catch (error) {
          toast('Failed to post reply: ' + error.message, 'error');
        } finally {
          button.dataset.processing = 'false';
          button.disabled = false;
        }
      }
      
      function toggleQuickComment(postId, button) {
        if (!auth.user) {
          toast('Please login to comment', 'warning');
          return;
        }
        
        const postCard = button.closest('.post-card');
        let quickCommentDiv = postCard.querySelector('.add-comment-inline');
        
        // Create quick comment input if it doesn't exist
        if (!quickCommentDiv) {
          quickCommentDiv = document.createElement('div');
          quickCommentDiv.className = 'add-comment-inline mt-2 p-2';
          quickCommentDiv.style.display = 'none';
          quickCommentDiv.innerHTML = `
            <div class="d-flex align-items-center gap-2">
              <img src="${auth.user.profile_picture || getDefaultAvatar()}" class="rounded-circle flex-shrink-0" width="32" height="32" alt="${escapeHtml(auth.user.username)}">
              <div class="flex-grow-1">
                <div class="input-group input-group-sm">
                  <input type="text" class="form-control comment-input" placeholder="Write a comment..." data-post-id="${postId}" style="border-radius: 20px 0 0 20px; border: 1px solid rgba(0,123,255,0.3); background: rgba(248,249,250,0.9);">
                  <button class="btn btn-primary btn-sm" type="button" onclick="postQuickComment('${postId}', this.parentElement.querySelector('.comment-input'))" style="border-radius: 0 20px 20px 0;">
                    <i class="bi bi-send-fill"></i>
                  </button>
                </div>
              </div>
            </div>
          `;
          
          // Insert after the quick comment input section
          const quickCommentInput = postCard.querySelector('.quick-comment-input');
          if (quickCommentInput) {
            quickCommentInput.insertAdjacentElement('afterend', quickCommentDiv);
          } else {
            // Fallback: insert at the end of post card
            postCard.appendChild(quickCommentDiv);
          }
        }
        
        // Enhanced toggle with smooth animation
        const isVisible = quickCommentDiv.style.display !== 'none';
        const icon = button.querySelector('i');
        
        // Add click feedback
        button.style.transform = 'scale(0.9)';
        setTimeout(() => button.style.transform = 'scale(1)', 100);
        
        if (isVisible) {
          // Hide with slide up animation
          quickCommentDiv.style.transition = 'all 0.3s ease-out';
          quickCommentDiv.style.transform = 'translateY(-10px)';
          quickCommentDiv.style.opacity = '0';
          
          setTimeout(() => {
            quickCommentDiv.style.display = 'none';
            quickCommentDiv.style.transform = 'translateY(0)';
            quickCommentDiv.style.opacity = '1';
          }, 300);
          
          // Update button
          icon.className = 'bi bi-plus-circle';
          button.classList.remove('text-primary');
          button.title = 'Add a comment';
          
        } else {
          // Show with slide down animation
          quickCommentDiv.style.display = 'block';
          quickCommentDiv.style.transition = 'all 0.3s ease-in';
          quickCommentDiv.style.transform = 'translateY(-10px)';
          quickCommentDiv.style.opacity = '0';
          
          setTimeout(() => {
            quickCommentDiv.style.transform = 'translateY(0)';
            quickCommentDiv.style.opacity = '1';
            
            // Focus the input
            const input = quickCommentDiv.querySelector('.comment-input');
            if (input) {
              input.focus();
              
              // Add Enter key handler if not already added
              if (!input.dataset.enterHandler) {
                input.addEventListener('keypress', (e) => {
                  if (e.key === 'Enter') {
                    e.preventDefault();
                    postQuickComment(postId, input);
                  }
                });
                input.dataset.enterHandler = 'true';
              }
            }
          }, 50);
          
          // Update button
          icon.className = 'bi bi-x-circle';
          button.classList.add('text-primary');
          button.title = 'Close comment box';
        }
      }
      
      async function postEnhancedComment(postId, input) {
        const user = getCurrentUser();
        if (!user) {
          showAuthModal();
          return;
        }

        const text = input.value.trim();
        if (!text) return;

        // Prevent multiple submissions with visual feedback
        if (input.dataset.processing === 'true') return;
        input.dataset.processing = 'true';
        
        const container = input.closest('.quick-comment-input');
        const postBtn = container.querySelector('.post-comment-btn');
        const originalBtnContent = postBtn.innerHTML;
        
        // Enhanced loading state
        postBtn.innerHTML = '<span class="spinner-border spinner-border-sm" style="width: 12px; height: 12px;"></span>';
        postBtn.disabled = true;
        input.disabled = true;
        input.style.opacity = '0.7';
        
        try {
          const newComment = await window.firebaseArtHubClient.addComment(postId, text);
          
          // Clear and reset input with smooth animation
          input.value = '';
          input.style.borderColor = 'rgba(40, 167, 69, 0.5)';
          input.style.boxShadow = '0 0 0 0.2rem rgba(40, 167, 69, 0.1)';
          
          setTimeout(() => {
            input.style.borderColor = 'rgba(0,123,255,0.2)';
            input.style.boxShadow = 'none';
            container.querySelector('.comment-actions').classList.add('d-none');
          }, 2000);
          
          // Update comment count across all instances with animation
          const allCommentBtns = document.querySelectorAll(`[data-post-id="${postId}"].comment-btn`);
          allCommentBtns.forEach(commentBtn => {
            const countEl = commentBtn.querySelector('.comment-count');
            if (countEl) {
              const currentCount = parseInt(countEl.textContent || '0');
              countEl.style.transform = 'scale(1.2)';
              countEl.style.color = '#28a745';
              countEl.textContent = currentCount + 1;
              
              setTimeout(() => {
                countEl.style.transform = 'scale(1)';
                countEl.style.color = '';
              }, 300);
            }
          });
          
          // Update "View all X comments" text with animation
          const allViewCommentsBtns = document.querySelectorAll(`[data-post-id="${postId}"].view-all-comments-btn, [data-post-id="${postId}"].view-more-comments-btn`);
          allViewCommentsBtns.forEach(viewBtn => {
            const currentText = viewBtn.textContent;
            const match = currentText.match(/(\d+)/);
            if (match) {
              const count = parseInt(match[1]) + 1;
              viewBtn.textContent = currentText.replace(match[1], count);
              viewBtn.style.color = '#28a745';
              setTimeout(() => viewBtn.style.color = '', 1500);
            }
          });
          
          // Add comment to preview with smooth insertion
          const postCard = container.closest('.post-card');
          const commentsPreview = postCard.querySelector('.comments-preview');
          if (commentsPreview) {
            const commentHtml = `
              <div class="comment-preview-item d-flex align-items-start mb-2 new-comment" style="opacity: 0; transform: translateY(-10px);">
                <img src="${user.profile_picture || getDefaultAvatar()}" class="rounded-circle me-2 flex-shrink-0" width="32" height="32" alt="${escapeHtml(user.username)}">
                <div class="flex-grow-1">
                  <div class="d-flex align-items-center">
                    <strong class="me-2">${escapeHtml(user.username)}</strong>
                    <small class="text-muted">just now</small>
                  </div>
                  <p class="mb-1">${escapeHtml(text)}</p>
                  <div class="comment-actions">
                    <button class="btn btn-sm btn-link p-0 me-2 comment-like-btn enhanced-like-btn" data-comment-id="${newComment.id}">
                      <i class="bi bi-heart"></i> <span class="like-count">0</span>
                    </button>
                    <button class="btn btn-sm btn-link p-0 reply-btn enhanced-reply-btn" data-comment-id="${newComment.id}" data-username="${escapeHtml(user.username)}">
                      <i class="bi bi-reply"></i> Reply
                    </button>
                  </div>
                </div>
              </div>
            `;
            commentsPreview.insertAdjacentHTML('beforeend', commentHtml);
            
            // Animate new comment in
            const newCommentEl = commentsPreview.querySelector('.new-comment');
            setTimeout(() => {
              newCommentEl.style.transition = 'all 0.4s ease';
              newCommentEl.style.opacity = '1';
              newCommentEl.style.transform = 'translateY(0)';
              newCommentEl.classList.remove('new-comment');
            }, 100);
          }
          
          // Success feedback
          toast('Comment posted! ', 'success');
          updateNotificationBadge();
          
        } catch (error) {
          // Error feedback with helpful message
          input.style.borderColor = 'rgba(220, 53, 69, 0.5)';
          input.style.boxShadow = '0 0 0 0.2rem rgba(220, 53, 69, 0.1)';
          toast('Failed to post comment: ' + error.message, 'error');
          
          setTimeout(() => {
            input.style.borderColor = 'rgba(0,123,255,0.2)';
            input.style.boxShadow = 'none';
          }, 3000);
        } finally {
          // Reset UI state
          postBtn.innerHTML = originalBtnContent;
          postBtn.disabled = false;
          input.disabled = false;
          input.style.opacity = '1';
          input.dataset.processing = 'false';
        }
      }      // Helper functions for enhanced comment system
      function getCurrentUser() {
        return window.firebaseArtHubClient?.getCurrentUser() || auth?.user || null;
      }
      
      function isUserLoggedIn() {
        return getCurrentUser() !== null;
      }
      
      function initializeCommentInputs() {
        // Initialize enhanced comment inputs with real-time auth detection
        const commentInputs = document.querySelectorAll('.enhanced-comment-input, .comment-input');
        
        commentInputs.forEach(input => {
          const container = input.closest('.quick-comment-input, .add-comment-inline');
          if (!container) return;
          
          // Set up auth-based UI updates
          updateCommentInputAuth(container, input);
          
          // Enhanced focus interactions
          input.addEventListener('focus', () => {
            input.style.transform = 'scale(1.02)';
            input.style.borderColor = 'rgba(0,123,255,0.6)';
            input.style.boxShadow = '0 0 0 0.2rem rgba(0,123,255,0.1)';
          });
          
          input.addEventListener('blur', () => {
            input.style.transform = 'scale(1)';
            input.style.borderColor = 'rgba(0,123,255,0.3)';
            input.style.boxShadow = 'none';
          });
          
          // Enhanced Enter key handling
          if (!input.dataset.enhancedEnter) {
            input.addEventListener('keypress', (e) => {
              if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                const postId = input.dataset.postId || input.getAttribute('data-post-id');
                if (postId) {
                  if (input.classList.contains('enhanced-comment-input')) {
                    postEnhancedComment(postId, input);
                  } else {
                    postQuickComment(postId, input);
                  }
                }
              }
            });
            input.dataset.enhancedEnter = 'true';
          }
        });
        
        // Update all comment inputs when auth state changes
        updateAllCommentInputs();
      }
      
      function updateCommentInputAuth(container, input, avatar, authPrompt, actions) {
        const user = getCurrentUser();
        
        if (!container) return;
        
        // Find elements if not provided
        avatar = avatar || container.querySelector('.user-avatar-comment');
        authPrompt = authPrompt || container.querySelector('.auth-prompt');
        actions = actions || container.querySelector('.comment-actions');
        
        if (user) {
          // User is logged in - show interactive comment input
          if (avatar) {
            avatar.src = user.profile_picture || getDefaultAvatar();
            avatar.alt = user.username;
            avatar.style.display = 'block';
          }
          
          if (authPrompt) {
            authPrompt.style.display = 'none';
          }
          
          if (input) {
            input.placeholder = 'Write a comment...';
            input.disabled = false;
            input.style.opacity = '1';
          }
          
          if (actions) {
            actions.style.display = 'flex';
          }
        } else {
          // User not logged in - show auth prompt
          if (avatar) {
            avatar.style.display = 'none';
          }
          
          if (authPrompt) {
            authPrompt.style.display = 'block';
            authPrompt.innerHTML = '<span class="text-muted">Please <a href="#" class="login-link text-primary">login</a> to comment</span>';
          }
          
          if (input) {
            input.placeholder = 'Login to comment...';
            input.disabled = true;
            input.style.opacity = '0.7';
          }
          
          if (actions) {
            actions.style.display = 'none';
          }
        }
      }
      
      function showAuthModal() {
        const authModal = document.getElementById('authModal');
        if (authModal) {
          const modal = new bootstrap.Modal(authModal);
          modal.show();
        }
      }
      
      // Enhanced event delegation for comment system
      document.addEventListener('click', (e) => {
        // Post comment button clicks
        if (e.target.classList.contains('post-comment-btn')) {
          const postId = e.target.dataset.postId;
          const input = e.target.closest('.quick-comment-input').querySelector('.enhanced-comment-input');
          postEnhancedComment(postId, input);
        }
        
        // Enhanced comment like button clicks
        if (e.target.classList.contains('enhanced-like-btn') || e.target.closest('.enhanced-like-btn')) {
          const btn = e.target.classList.contains('enhanced-like-btn') ? e.target : e.target.closest('.enhanced-like-btn');
          const commentId = btn.dataset.commentId;
          toggleEnhancedCommentLike(commentId, btn);
        }
        
        // Enhanced reply button clicks
        if (e.target.classList.contains('enhanced-reply-btn') || e.target.closest('.enhanced-reply-btn')) {
          const btn = e.target.classList.contains('enhanced-reply-btn') ? e.target : e.target.closest('.enhanced-reply-btn');
          const commentId = btn.dataset.commentId;
          const username = btn.dataset.username;
          showEnhancedReplyInput(commentId, username, btn);
        }
        
        // Login link clicks
        if (e.target.classList.contains('login-link')) {
          e.preventDefault();
          showAuthModal();
        }
      });
      
      // Open comments modal
      function openCommentsModal(postId) {
        // Set the current post ID for the comments modal
        document.getElementById('commentText').setAttribute('data-post-id', postId);
        
        // Show the modal
        const modal = new bootstrap.Modal(document.getElementById('commentsModal'));
        modal.show();
        
        // Load comments for this post
        loadCommentsForModal(postId);
      }
      
      // Load comments for modal
      async function loadCommentsForModal(postId) {
        const commentsList = document.getElementById('commentsList');
        commentsList.innerHTML = '<div class=\"text-center py-3\">Loading comments...</div>';
        
        try {
          const comments = await window.firebaseArtHubClient.getComments(postId);
          
          if (comments.length === 0) {
            commentsList.innerHTML = '<div class=\"text-center py-3 text-muted\">No comments yet. Be the first to comment!</div>';
            return;
          }
          
          commentsList.innerHTML = comments.map(comment => `
            <div class=\"comment-item mb-3 p-3\" style=\"background: rgba(0,0,0,0.02); border-radius: 0.5rem;\">
              <div class=\"d-flex align-items-start gap-2\">
                <img src=\"${comment.profile_picture || getDefaultAvatar()}\" class=\"rounded-circle\" width=\"32\" height=\"32\" alt=\"${escapeHtml(comment.username)}\">
                <div class=\"flex-grow-1\">
                  <div class=\"d-flex align-items-center gap-2\">
                    <strong class=\"small\">${escapeHtml(comment.username)}</strong>
                    <small class=\"text-muted\">${formatTimeAgo(comment.created_at)}</small>
                  </div>
                  <div class=\"mt-1\">${escapeHtml(comment.text)}</div>
                  <div class=\"comment-actions mt-2\">
                    <button class=\"like-comment-btn ${comment.user_liked ? 'liked' : ''}\" data-comment-id=\"${comment.id}\">
                      <i class=\"bi bi-heart${comment.user_liked ? '-fill' : ''}\"></i> ${comment.likes_count || 0}
                    </button>
                    <button class=\"reply-comment-btn\" data-comment-id=\"${comment.id}\" data-username=\"${escapeHtml(comment.username)}\">
                      <i class=\"bi bi-reply\"></i> Reply
                    </button>
                  </div>
                </div>
              </div>
            </div>
          `).join('');
        } catch (error) {
          commentsList.innerHTML = '<div class=\"text-center py-3 text-danger\">Failed to load comments</div>';
          console.error('Error loading comments:', error);
        }
      }
      
      // External link confirmation
      function confirmExternalLink(event, url) {
        event.preventDefault();
        
        if (confirm(`You are about to visit an external website:\n\n${url}\n\nThis link will take you away from ArtHub. Do you want to continue?`)) {
          window.open(url, '_blank', 'noopener,noreferrer');
        }
      }
      
      // NSFW blur functions
      function initializeNSFWBlur() {
        const nsfwImages = document.querySelectorAll('.nsfw-blur');
        nsfwImages.forEach(img => {
          const overlay = document.createElement('div');
          overlay.className = 'nsfw-overlay';
          overlay.innerHTML = `
            <div class="text-center">
              <i class="bi bi-exclamation-triangle" style="font-size: 2rem; margin-bottom: 0.5rem;"></i>
              <div><strong>NSFW Content</strong></div>
              <div class="small mb-3">This content may not be suitable for work</div>
              <button class="btn btn-outline-light btn-sm" onclick="verifyAge(this)">
                I am 18+ years old
              </button>
            </div>
          `;
          
          const wrapper = img.parentElement;
          wrapper.style.position = 'relative';
          wrapper.appendChild(overlay);
        });
      }
      
      function verifyAge(button) {
        const modal = document.createElement('div');
        modal.className = 'modal fade age-verification-modal';
        modal.innerHTML = `
          <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
              <div class="modal-header">
                <h5 class="modal-title">Age Verification Required</h5>
              </div>
              <div class="modal-body text-center">
                <i class="bi bi-exclamation-triangle" style="font-size: 3rem; margin-bottom: 1rem;"></i>
                <h6>Content Warning</h6>
                <p>This content is marked as NSFW (Not Safe For Work) and may contain mature themes.</p>
                <p><strong>You must be 18 years or older to view this content.</strong></p>
                <div class="form-check d-flex justify-content-center mb-3">
                  <input class="form-check-input me-2" type="checkbox" id="ageConfirm">
                  <label class="form-check-label" for="ageConfirm">
                    I confirm that I am 18 years of age or older
                  </label>
                </div>
              </div>
              <div class="modal-footer justify-content-center">
                <button type="button" class="btn btn-outline-light" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-light" onclick="revealNSFWContent(this)" disabled id="confirmBtn">
                  View Content
                </button>
              </div>
            </div>
          </div>
        `;
        
        document.body.appendChild(modal);
        const bsModal = new bootstrap.Modal(modal);
        bsModal.show();
        
        // Enable confirm button when checkbox is checked
        const checkbox = modal.querySelector('#ageConfirm');
        const confirmBtn = modal.querySelector('#confirmBtn');
        
        checkbox.addEventListener('change', () => {
          confirmBtn.disabled = !checkbox.checked;
        });
        
        // Store reference to the button for later use
        modal.querySelector('#confirmBtn').setAttribute('data-original-button', button.getAttribute('data-original-button') || button.closest('.nsfw-overlay').previousElementSibling.className);
        
        // Clean up modal after it's hidden
        modal.addEventListener('hidden.bs.modal', () => {
          modal.remove();
        });
      }
      
      function revealNSFWContent(confirmBtn) {
        const modal = confirmBtn.closest('.modal');
        
        // Remove blur from all NSFW images
        const nsfwImages = document.querySelectorAll('.nsfw-blur');
        const nsfwOverlays = document.querySelectorAll('.nsfw-overlay');
        
        nsfwImages.forEach(img => {
          img.classList.add('revealed');
        });
        
        nsfwOverlays.forEach(overlay => {
          overlay.remove();
        });
        
        // Remember user's choice for this session
        sessionStorage.setItem('nsfw_verified', 'true');
        
        // Close modal
        const bsModal = bootstrap.Modal.getInstance(modal);
        bsModal.hide();
      }
      
      // Check if user has already verified age in this session
      function checkNSFWVerification() {
        return sessionStorage.getItem('nsfw_verified') === 'true';
      }
      
      // Admin delete comment function
      async function deleteComment(commentId) {
        if (!commentId) {
          toast('Invalid comment ID', 'error');
          return;
        }
        
        if (!isAdmin()) {
          toast('Requires admin permission/account', 'error');
          return;
        }
        
        // Show loading state
        const deleteBtn = document.querySelector(`[data-comment-id="${commentId}"]`);
        if (deleteBtn) {
          deleteBtn.disabled = true;
          deleteBtn.innerHTML = '<i class="bi bi-hourglass-split me-1"></i><span class="small">Deleting...</span>';
        }
        
        try {
          await window.firebaseArtHubClient.deleteComment(commentId);
          toast('Comment deleted successfully', 'success');
          loadFeed(true); // Refresh feed to update comments
        } catch (error) {
          console.error('Delete comment error:', error);
          toast('Failed to delete comment: ' + (error.message || 'Unknown error'), 'error');
          
          // Restore button state on error
          if (deleteBtn) {
            deleteBtn.disabled = false;
            deleteBtn.innerHTML = '<i class="bi bi-trash me-1"></i><span class="small">Delete</span>';
          }
        }
      }
      
      // Show report comment modal
      function showReportCommentModal(commentId) {
        if (!auth.user) {
          toast('Please login to report comments', 'warning');
          return;
        }
        
        const modal = document.createElement('div');
        modal.className = 'modal fade';
        modal.innerHTML = `
          <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
              <div class="modal-header">
                <h5 class="modal-title">Report Comment</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
              </div>
              <div class="modal-body">
                <p>Why are you reporting this comment?</p>
                <select class="form-select mb-3" id="reportCommentReason">
                  <option value="">Select a reason...</option>
                  <option value="spam">Spam</option>
                  <option value="harassment">Harassment or bullying</option>
                  <option value="hate_speech">Hate speech</option>
                  <option value="inappropriate">Inappropriate content</option>
                  <option value="misinformation">False information</option>
                  <option value="other">Other</option>
                </select>
                <textarea class="form-control" id="reportCommentDetails" rows="3" placeholder="Additional details (optional)..."></textarea>
              </div>
              <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" onclick="submitCommentReport('${commentId}', this)">Submit Report</button>
              </div>
            </div>
          </div>
        `;
        
        document.body.appendChild(modal);
        const bsModal = new bootstrap.Modal(modal);
        bsModal.show();
        
        modal.addEventListener('hidden.bs.modal', () => {
          modal.remove();
        });
      }
      
      // Submit comment report
      async function submitCommentReport(commentId, button) {
        const modal = button.closest('.modal');
        const reason = modal.querySelector('#reportCommentReason').value;
        const details = modal.querySelector('#reportCommentDetails').value;
        
        if (!reason) {
          toast('Please select a reason for reporting', 'error');
          return;
        }
        
        try {
          await window.firebaseArtHubClient.reportComment(commentId, reason, details);
          toast('Comment reported successfully. Thank you for helping keep our community safe.', 'success');
          
          const bsModal = bootstrap.Modal.getInstance(modal);
          bsModal.hide();
        } catch (error) {
          toast('Failed to submit report: ' + error.message, 'error');
        }
      }
      
      // Load trending tags dynamically
      let currentTrendingTag = null;
      let trendingTagsCache = null;
      let trendingTagsCacheTime = 0;
      const TRENDING_TAGS_CACHE_DURATION = 5 * 60 * 1000; // 5 minutes
      
      async function loadTrendingTags(forceRefresh = false) {
        console.log(' Starting loadTrendingTags...');
        try {
          const trendingTagsElement = document.getElementById('trendingTags');
          if (!trendingTagsElement) {
            console.error(' trendingTags element not found');
            return;
          }

          console.log(' Checking cache...');
          // Use cache if available and not expired
          const now = Date.now();
          if (!forceRefresh && trendingTagsCache && (now - trendingTagsCacheTime) < TRENDING_TAGS_CACHE_DURATION) {
            console.log(' Using cached trending tags');
            displayTrendingTags(trendingTagsCache);
            return;
          }

          console.log(' Getting trending tags from client...');
          console.log(' Client available:', !!window.firebaseArtHubClient);
          console.log(' Client type:', window.firebaseArtHubClient?.constructor?.name);
          
          // Use the optimized getTrendingTags method from the client
          const trendingTags = await window.firebaseArtHubClient.getTrendingTags(15);
          console.log(' Raw trending tags result:', trendingTags);
          
          if (trendingTags && trendingTags.length > 0) {
            console.log(' Found', trendingTags.length, 'trending tags');
            const sortedTags = trendingTags.map(tagData => [tagData.tag, tagData.count]);
            
            // Cache the results
            trendingTagsCache = sortedTags;
            trendingTagsCacheTime = now;
            
            displayTrendingTags(sortedTags);
          } else {
            console.log(' No trending tags found');
            trendingTagsElement.innerHTML = '<p class="text-muted small">No trending tags yet. Start using hashtags in your posts!</p>';
          }
        } catch (error) {
          console.error(' Error loading trending tags:', error);
          const trendingTagsContainer = document.getElementById('trendingTags');
          if (trendingTagsContainer) {
            trendingTagsContainer.innerHTML = '<p class="text-muted small">Unable to load trending tags</p>';
          }
        }
      }
      
      function displayTrendingTags(sortedTags) {
        const trendingTagsContainer = document.getElementById('trendingTags');
        if (trendingTagsContainer) {
          if (sortedTags.length > 0) {
            trendingTagsContainer.innerHTML = sortedTags.map(([tag, count]) => {
              const safeTag = tag.replace(/'/g, "\\'"); // Escape quotes for onclick
              return `<button class="tag-chip trending-tag" type="button" data-tag="${tag.toLowerCase()}" title="Used ${count} time${count > 1 ? 's' : ''}" onclick="selectTrendingTag('${safeTag.toLowerCase()}', this)">
                #${tag} <span class="tag-count">(${count})</span>
              </button>`;
            }).join('');
          } else {
            trendingTagsContainer.innerHTML = '<p class="text-muted small">No trending tags yet. Be the first to use tags!</p>';
          }
        }
      }
      
      // Refresh trending tags when new posts are created
      function refreshTrendingTags() {
        trendingTagsCache = null; // Clear cache
        loadTrendingTags(true); // Force refresh
        loadPopularTags(true); // Also refresh popular tags
      }
      
      // Load popular tags from trending data
      async function loadPopularTags(forceRefresh = false) {
        console.log(' Loading popular tags...');
        try {
          const popularTagsElement = document.getElementById('popularTags');
          if (!popularTagsElement) {
            console.error(' popularTags element not found');
            return;
          }

          // Get trending tags data (top 8 for popular section)
          const trendingTags = await window.firebaseArtHubClient.getTrendingTags(8);
          
          if (trendingTags && trendingTags.length > 0) {
            console.log(' Found', trendingTags.length, 'popular tags from trending data');
            
            const popularTagsHTML = trendingTags.map(tagData => {
              const safeTag = tagData.tag.replace(/'/g, "\'"); // Escape quotes
              return `<button
                class="btn btn-sm btn-outline-primary me-1 mb-1 tag-chip"
                data-tag="${tagData.tag.toLowerCase()}"
                onclick="toggleSearchTag('${safeTag.toLowerCase()}', this)"
                title="Used ${tagData.count} time${tagData.count > 1 ? 's' : ''}"
              >
                #${tagData.tag}
              </button>`;
            }).join('');
            
            popularTagsElement.innerHTML = popularTagsHTML;
          } else {
            console.log(' No trending tags found for popular section');
            // Fallback to default tags if no trending data available
            popularTagsElement.innerHTML = `
              <button class="btn btn-sm btn-outline-primary me-1 mb-1 tag-chip" data-tag="art" onclick="toggleSearchTag('art', this)">#art</button>
              <button class="btn btn-sm btn-outline-primary me-1 mb-1 tag-chip" data-tag="digital" onclick="toggleSearchTag('digital', this)">#digital</button>
              <button class="btn btn-sm btn-outline-primary me-1 mb-1 tag-chip" data-tag="painting" onclick="toggleSearchTag('painting', this)">#painting</button>
              <button class="btn btn-sm btn-outline-primary me-1 mb-1 tag-chip" data-tag="sketch" onclick="toggleSearchTag('sketch', this)">#sketch</button>
            `;
          }
        } catch (error) {
          console.error(' Error loading popular tags:', error);
          // Fallback to default tags on error
          const popularTagsElement = document.getElementById('popularTags');
          if (popularTagsElement) {
            popularTagsElement.innerHTML = `
              <button class="btn btn-sm btn-outline-primary me-1 mb-1 tag-chip" data-tag="art" onclick="toggleSearchTag('art', this)">#art</button>
              <button class="btn btn-sm btn-outline-primary me-1 mb-1 tag-chip" data-tag="digital" onclick="toggleSearchTag('digital', this)">#digital</button>
              <button class="btn btn-sm btn-outline-primary me-1 mb-1 tag-chip" data-tag="painting" onclick="toggleSearchTag('painting', this)">#painting</button>
            `;
          }
        }
      }
      
      // Handle search section tag toggle (multi-selection)
      function toggleSearchTag(tag, element) {
        console.log(' Toggling search tag:', tag);
        
        // Clear any trending tag selection when using search tags
        currentTrendingTag = null;
        document.querySelectorAll('.trending-tag').forEach(btn => {
          btn.classList.remove('selected');
        });
        
        const tagLower = tag.toLowerCase();
        
        if (selectedTags.has(tagLower)) {
          // Remove tag if already selected
          selectedTags.delete(tagLower);
          element.classList.remove('selected');
          console.log(' Removed tag:', tag);
        } else {
          // Add tag to selection
          selectedTags.add(tagLower);
          element.classList.add('selected');
          console.log(' Added tag:', tag);
        }
        
        console.log(' Currently selected tags:', Array.from(selectedTags));
        
        // Check if all tags are now deselected
        if (selectedTags.size === 0) {
          console.log(' No tags selected - reverting to default home page');
          loadFeed(true); // Fresh load to show all posts from database
        } else {
          updateTagVisualState();
          filterPostsByTags();
        }
      }
      
      // Handle search input tag filtering
      function initializeSearchInput() {
        const input = document.getElementById('tagFilterInput');
        const filterBtn = document.getElementById('filterByTagBtn');
        
        if (!input || !filterBtn) return;
        
        // Add tag on button click
        filterBtn.addEventListener('click', () => {
          const tagValue = input.value.trim().toLowerCase();
          if (tagValue) {
            // Remove # if user typed it
            const cleanTag = tagValue.replace(/^#/, '');
            
            if (!selectedTags.has(cleanTag)) {
              selectedTags.add(cleanTag);
              updateTagVisualState();
              filterPostsByTags();
              console.log(' Added tag from search:', cleanTag);
            }
            
            input.value = ''; // Clear input
          }
        });
        
        // Add tag on Enter key
        input.addEventListener('keydown', (e) => {
          if (e.key === 'Enter') {
            e.preventDefault();
            filterBtn.click();
          }
        });
      }

      // Handle post tag selection (when clicking on tags in posts)
      function selectPostTag(tag, element) {
        // Clear any existing trending tag selection
        document.querySelectorAll('.trending-tag').forEach(btn => {
          btn.classList.remove('selected');
        });
        currentTrendingTag = null;
        
        // Add this tag to selected tags for multiple tag filtering
        const tagLower = tag.toLowerCase();
        if (selectedTags.has(tagLower)) {
          selectedTags.delete(tagLower);
        } else {
          selectedTags.add(tagLower);
        }
        
        // Check if all tags are now deselected
        if (selectedTags.size === 0) {
          console.log(' No tags selected - reverting to default home page');
          loadFeed(true); // Fresh load to show all posts from database
        } else {
          filterPostsByTags();
          updateTagVisualState();
        }
      }
      
      // Handle trending tag selection (works with multiple selection system)
      function selectTrendingTag(tag, element) {
        console.log(' Selecting trending tag:', tag);
        
        const tagLower = tag.toLowerCase();
        
        if (selectedTags.has(tagLower)) {
          // Remove tag if already selected
          selectedTags.delete(tagLower);
          element.classList.remove('selected');
          console.log(' Removed trending tag:', tag);
        } else {
          // Add tag to selection
          selectedTags.add(tagLower);
          element.classList.add('selected');
          console.log(' Added trending tag:', tag);
        }
        
        console.log(' Currently selected tags:', Array.from(selectedTags));
        
        // Check if all tags are now deselected
        if (selectedTags.size === 0) {
          console.log(' No tags selected - reverting to default home page');
          currentTrendingTag = null;
          loadFeed(true); // Fresh load to show all posts from database
        } else {
          updateTagVisualState();
          filterPostsByTags();
        }
      }
      
      // Load user settings into the modal
      async function loadUserSettings() {
        if (!auth.user) return;

        try {
          const user = await artHubClient.getUserById(auth.user.id);
          document.getElementById("settingsUsername").value =
            user.username || "";
          document.getElementById("settingsEmail").value = user.email || "";
          const aboutMeEl = document.getElementById("aboutMe");
          if (aboutMeEl) aboutMeEl.value = user.aboutMe || "";
          document.getElementById("settingPrivacy").value =
            user.privacy || "public";
          document.getElementById("settingNotifications").checked =
            user.notifications !== false;
          document.getElementById("settingAutoplay").checked =
            user.autoplay === true;

          // Update alias display
          updateAliasDisplay(user.previousUsernames || []);
          checkUsernameCooldown();

          // Load profile stats
          loadProfileStats();
        } catch (error) {
          console.error("Error loading user settings:", error);
        }
      }

      // Check username change cooldown
      function checkUsernameCooldown() {
        if (!auth.user) return;

        const lastUsernameChange = auth.user.lastUsernameChange;
        if (lastUsernameChange) {
          const weekAgo = new Date();
          weekAgo.setDate(weekAgo.getDate() - 7);
          const lastChange = new Date(lastUsernameChange);

          if (lastChange > weekAgo) {
            const timeLeft = new Date(
              lastChange.getTime() + 7 * 24 * 60 * 60 * 1000
            );
            const now = new Date();
            const diff = timeLeft - now;
            const daysLeft = Math.ceil(diff / (1000 * 60 * 60 * 24));

            const cooldownDiv = document.getElementById("usernameCooldown");
            if (cooldownDiv) {
              cooldownDiv.style.display = "block";
              cooldownDiv.textContent = `You can change your username in ${daysLeft} day${
                daysLeft !== 1 ? "s" : ""
              }`;
            }
            const usernameInput = document.getElementById("settingsUsername");
            if (usernameInput) usernameInput.disabled = true;
            return false;
          }
        }

        const cooldownDiv = document.getElementById("usernameCooldown");
        if (cooldownDiv) cooldownDiv.style.display = "none";
        const usernameInput = document.getElementById("settingsUsername");
        if (usernameInput) usernameInput.disabled = false;
        return true;
      }

      // Update alias display
      function updateAliasDisplay(aliases) {
        const aliasList = document.getElementById("aliasList");
        if (!aliasList) return;

        if (!aliases || aliases.length === 0) {
          aliasList.innerHTML =
            '<div class="alias-item">No previous usernames</div>';
          return;
        }

        aliasList.innerHTML = aliases
          .map(
            (alias) =>
              `<div class="alias-item">${
                alias.username
              } <small class="text-muted">(${new Date(
                alias.changedAt
              ).toLocaleDateString()})</small></div>`
          )
          .join("");
      }

      // Load profile stats
      async function loadProfileStats() {
        if (!auth.user) return;

        try {
          const stats = await artHubClient.getUserStats(auth.user.id);
          const postCountEl = document.getElementById("userPostCount");
          const likesReceivedEl = document.getElementById("userLikesReceived");
          const followersEl = document.getElementById("userFollowers");
          const memberSinceEl = document.getElementById("memberSince");

          if (postCountEl) postCountEl.textContent = stats.postCount || 0;
          if (likesReceivedEl)
            likesReceivedEl.textContent = stats.likesReceived || 0;
          if (followersEl) followersEl.textContent = stats.followers || 0;

          if (memberSinceEl) {
            const memberSince = auth.user.created_at
              ? new Date(auth.user.created_at).toLocaleDateString()
              : "Unknown";
            memberSinceEl.textContent = memberSince;
          }
        } catch (error) {
          console.error("Error loading profile stats:", error);
        }
      }

      // Save settings
      async function saveSettings() {
        if (!auth.user) return;

        try {
          const username = document
            .getElementById("settingsUsername")
            .value.trim();
          const email = document.getElementById("settingsEmail").value.trim();
          const aboutMe = document.getElementById("aboutMe").value.trim();
          const privacy = document.getElementById("settingPrivacy").value;
          const notifications = document.getElementById(
            "settingNotifications"
          ).checked;
          const autoplay = document.getElementById("settingAutoplay").checked;

          // Update username if changed and cooldown allows
          if (username !== auth.user.username) {
            if (checkUsernameCooldown()) {
              await artHubClient.updateUsername(auth.user.id, username);
              auth.user.username = username;
              toast("Username updated successfully!", "success");
            } else {
              return; // Cooldown prevents change
            }
          }

          // Update about me
          if (aboutMe !== auth.user.aboutMe) {
            await artHubClient.updateAboutMe(auth.user.id, aboutMe);
            auth.user.aboutMe = aboutMe;
          }

          // Update other settings (would need additional Firebase methods)
          // For now, just store locally
          auth.user.privacy = privacy;
          auth.user.notifications = notifications;
          auth.user.autoplay = autoplay;

          localStorage.setItem("arthub_user", JSON.stringify(auth.user));

          toast("Settings saved successfully!", "success");
          settingsModal.hide();

          // Update UI elements
          const profileUsernameEl = document.getElementById("profileUsername");
          if (profileUsernameEl)
            profileUsernameEl.textContent = auth.user.username;
        } catch (error) {
          console.error("Error saving settings:", error);
          toast("Failed to save settings: " + error.message, "error");
        }
      }

      // --- Enhanced Toast helper with message types ---
      let toastInstance;
      function toast(msg, type = "default") {
        const el = document.getElementById("toastGeneric");
        const messageEl = document.getElementById("toastMessage");

        // Set message
        messageEl.textContent = msg;

        // Apply styling based on type
        el.className = "toast align-items-center border-0";
        switch (type) {
          case "success":
            el.classList.add("toast-success", "text-bg-success");
            break;
          case "error":
            el.classList.add("toast-error", "text-bg-danger");
            break;
          case "info":
            el.classList.add("toast-info", "text-bg-info");
            break;
          default:
            el.classList.add("toast-brand");
        }

        // Show toast with appropriate delay
        const delay =
          type === "success" ? 3000 : type === "error" ? 4000 : 2500;
        if (!toastInstance) toastInstance = new bootstrap.Toast(el, { delay });
        else toastInstance._config.delay = delay;

        toastInstance.show();
      }

      // --- Adapt existing publishing to show toast + enforce login for posts & reader context ---
      function enforceAuthBefore() {
        if (!auth.user) {
          toast("Login required");
          openAuth("login");
          return false;
        }
        return true;
      }

      // --- Section Management ---
      function showSection(sectionName) {
        // Hide all sections
        const sections = [
          "feed",
          "explore",
          "notifications",
          "messages",
          "saved",
          "admin",
          "settings",
        ];
        sections.forEach((section) => {
          const el = document.getElementById(section);
          if (el) el.style.display = "none";
        });

        // Update navigation active state
        document
          .querySelectorAll(".sidebar-card.nav-card [data-hub-nav]")
          .forEach((navItem) => {
            navItem.classList.remove("active");
          });

        const activeNavItem = document.querySelector(
          `[data-hub-nav="${sectionName}"]`
        );
        if (activeNavItem) {
          activeNavItem.classList.add("active");
        }

        // Store current section in localStorage for persistence
        localStorage.setItem("arthub_current_section", sectionName);

        // Show/hide upload UI based on section
        const uploadUI = document.getElementById("uploadUI");
        if (uploadUI) {
          uploadUI.style.display =
            sectionName === "feed" || sectionName === "explore"
              ? "block"
              : "none";
        }

        // Show target section
        const targetSection = document.getElementById(sectionName);
        if (targetSection) {
          targetSection.style.display = "block";

          // Load content based on section
          switch (sectionName) {
            case "feed":
              loadFeed();
              break;
            case "explore":
              loadExplore();
              break;
            case "notifications":
              loadNotifications();
              break;
            case "messages":
              loadMessages();
              break;
            case "saved":
              loadSaved();
              break;
            case "admin":
              loadAdmin();
              break;
            case "settings":
              loadSettings();
              break;
          }
        }
      }

      // --- Content Loading Functions ---

      async function loadExplore() {
        const exploreContent = document.getElementById("exploreContent");
        if (!exploreContent) return;

        // Always show empty state - no explore posts
        exploreContent.innerHTML =
          '<div class="text-center py-4 text-muted">No posts to explore yet</div>';
      }

      async function loadNotifications() {
        if (!auth.user) {
          const dropdownContent = document.getElementById(
            "notificationsDropdownContent"
          );
          if (dropdownContent) {
            dropdownContent.innerHTML =
              '<div class="dropdown-item-text text-center py-3">Please login to view notifications</div>';
          }
          return;
        }

        const dropdownContent = document.getElementById(
          "notificationsDropdownContent"
        );
        if (!dropdownContent) return;

        dropdownContent.innerHTML =
          '<div class="dropdown-item-text text-center py-3">Loading notifications...</div>';

        try {
          const notifications =
            await window.firebaseArtHubClient.getNotifications();
          notificationCount = notifications.filter(
            (n) => !n.read_status
          ).length;
          updateNotificationBadge();
          displayNotifications(notifications);
        } catch (err) {
          console.error("Failed to load notifications:", err);
          // Show some dummy notifications for demo
          const demoNotifications = [
            {
              id: 1,
              type: "like",
              message: "Someone liked your post",
              created_at: new Date(),
              read_status: false,
            },
            {
              id: 2,
              type: "comment",
              message: "New comment on your artwork",
              created_at: new Date(Date.now() - 3600000),
              read_status: true,
            },
          ];
          displayNotifications(demoNotifications);
        }
      }

      function getNotificationIcon(type) {
        switch (type) {
          case "like":
            return "bi-heart-fill";
          case "comment":
            return "bi-chat-fill";
          case "follow":
            return "bi-person-plus-fill";
          default:
            return "bi-bell-fill";
        }
      }

      function updateNotificationBadge() {
        const badge = document.getElementById("notificationsBadge");
        const counterBadge = document.getElementById("notificationCounter");

        if (badge) {
          if (notificationCount > 0) {
            badge.textContent = notificationCount;
            badge.style.display = "inline";
          } else {
            badge.style.display = "none";
          }
        }

        // Update the counter badge in header if it exists
        if (counterBadge) {
          if (notificationCount > 0) {
            counterBadge.textContent =
              notificationCount > 99 ? "99+" : notificationCount;
            counterBadge.style.display = "inline";
          } else {
            counterBadge.style.display = "none";
          }
        }
      }

      async function loadMessages() {
        const messagesContent = document.getElementById("messagesContent");
        if (!messagesContent) return;

        messagesContent.innerHTML =
          '<div class="text-center py-4">Loading messages...</div>';

        try {
          const conversations = await artHubClient.getMessages();
          messagesContent.innerHTML = "";

          if (conversations.length === 0) {
            messagesContent.innerHTML = `
            <div class="text-center py-4 text-muted">
              <i class="bi bi-envelope display-4 mb-3"></i>
              <p>No messages yet</p>
              <p class="small">Start conversations with other artists!</p>
            </div>
          `;
            return;
          }

          conversations.forEach((conversation) => {
            const convCard = document.createElement("div");
            convCard.className = "post-card";
            convCard.innerHTML = `
            <div class="d-flex align-items-center">
              <img src="${
                conversation.partner?.profile_picture ||
                "https://placehold.co/50x50"
              }" 
                   class="avatar me-3" alt="${escapeHtml(
                     conversation.partner?.username || "User"
                   )}">
              <div class="flex-grow-1">
                <h6 class="mb-1">${escapeHtml(
                  conversation.partner?.username || "Unknown User"
                )}</h6>
                <p class="mb-1 small text-muted">${escapeHtml(
                  conversation.lastMessage.message
                )}</p>
                <small class="text-muted">${formatTimeAgo(
                  conversation.lastMessage.created_at
                )}</small>
              </div>
              ${
                conversation.unreadCount > 0
                  ? `<span class="badge bg-primary rounded-pill">${conversation.unreadCount}</span>`
                  : ""
              }
            </div>
          `;
            messagesContent.appendChild(convCard);
          });
        } catch (err) {
          messagesContent.innerHTML =
            '<div class="text-danger text-center py-4">No messages.</div>';
        }
      }

      async function loadSaved() {
        const savedContent = document.getElementById("savedContent");
        if (!savedContent) return;

        savedContent.innerHTML =
          '<div class="text-center py-4">Loading saved posts...</div>';

        try {
          // Check if user is authenticated
          if (
            !window.firebaseArtHubClient ||
            !window.firebaseArtHubClient.getCurrentUser()
          ) {
            savedContent.innerHTML = `<div class="text-warning text-center py-4">
            <i class="bi bi-person-x display-4 mb-3"></i>
            <p>Please sign in to view saved posts</p>
          </div>`;
            return;
          }

          let savedPosts = [];
          try {
            // Try Firebase first
            savedPosts = await window.firebaseArtHubClient.getSavedPosts();
          } catch (firebaseErr) {
            console.warn(
              "Firebase getSavedPosts failed, using localStorage fallback:",
              firebaseErr
            );
            // Fallback to localStorage approach
            const savedPostIds = JSON.parse(
              localStorage.getItem("saved_posts") || "[]"
            );
            if (savedPostIds.length > 0) {
              // Try to get posts from Firebase feed data
              try {
                const allPosts = await window.firebaseArtHubClient.getPosts();
                savedPosts = allPosts
                  .filter((post) => savedPostIds.includes(post.id))
                  .map((post) => ({ ...post, user_saved: true }));
              } catch {
                // Ultimate fallback - empty array
                savedPosts = [];
              }
            }
          }

          savedContent.innerHTML = "";

          if (savedPosts.length === 0) {
            savedContent.innerHTML = `
            <div class="text-center py-4 text-muted">
              <i class="bi bi-bookmark display-4 mb-3"></i>
              <p>No saved posts yet</p>
              <p class="small">Save posts you want to revisit later!</p>
            </div>
          `;
            return;
          }

          savedPosts.forEach((post) =>
            savedContent.appendChild(postCard(post))
          );
        } catch (err) {
          console.error("Error loading saved posts:", err);
          savedContent.innerHTML = `<div class="text-danger text-center py-4">
          Failed to load saved posts<br>
          <small class="text-muted">${err.message}</small>
        </div>`;
        }
      }

      // Admin Panel Functions
      async function loadAdmin() {
        if (!isAdmin()) {
          document.getElementById("admin").innerHTML = `
          <div class="text-center py-4 text-danger">
            <i class="bi bi-shield-x display-4 mb-3"></i>
            <p>Access Denied</p>
            <p class="small">You need admin permissions to access this panel</p>
          </div>
        `;
          return;
        }

        try {
          await loadReports();
          await loadContextReviews();
          setupUserSearch();
        } catch (err) {
          console.error("Error loading admin panel:", err);
        }
      }

      async function loadReports() {
        const reportsList = document.getElementById("reportsList");
        if (!reportsList) return;

        try {
          const reports = await window.firebaseArtHubClient.getReports();

          if (reports.length === 0) {
            reportsList.innerHTML =
              '<div class="text-muted text-center py-3">No reports yet</div>';
            return;
          }

          reportsList.innerHTML = reports
            .map(
              (report) => `
          <div class="report-item">
            <div class="d-flex justify-content-between align-items-start mb-2">
              <strong>Post by ${escapeHtml(report.reported_username)}</strong>
              <small class="text-muted">${formatTimeAgo(
                report.created_at
              )}</small>
            </div>
            <div class="mb-2">
              <span class="badge bg-warning text-dark">${report.reason}</span>
              <small class="text-muted ms-2">Reported by ${escapeHtml(
                report.reporter_username
              )}</small>
            </div>
            ${
              report.details
                ? `<p class="small mb-2">${escapeHtml(report.details)}</p>`
                : ""
            }
            <div class="d-flex gap-2">
              <button class="btn btn-sm btn-outline-primary view-post-btn" data-post-id="${
                report.post_id
              }">View Post</button>
              <button class="btn btn-sm btn-outline-danger delete-post-btn" data-post-id="${
                report.post_id
              }" data-report-id="${report.id}">Delete Post</button>
              <button class="btn btn-sm btn-outline-secondary dismiss-report-btn" data-report-id="${
                report.id
              }">Dismiss</button>
            </div>
          </div>
        `
            )
            .join("");
        } catch (err) {
          reportsList.innerHTML =
            '<div class="text-danger text-center py-3">Error loading reports</div>';
        }
      }

      function setupUserSearch() {
        const searchInput = document.getElementById("searchUserInput");
        const usersList = document.getElementById("usersList");

        let searchTimeout;
        searchInput.addEventListener("input", (e) => {
          clearTimeout(searchTimeout);
          const query = e.target.value.trim();

          if (!query) {
            usersList.innerHTML =
              '<div class="text-muted text-center py-3">Search for users to manage</div>';
            return;
          }

          searchTimeout = setTimeout(async () => {
            try {
              const users = await window.firebaseArtHubClient.searchUsers(
                query
              );

              if (users.length === 0) {
                usersList.innerHTML =
                  '<div class="text-muted text-center py-3">No users found</div>';
                return;
              }

              usersList.innerHTML = users
                .map(
                  (user) => `
              <div class="user-item">
                <div class="d-flex align-items-center">
                  <img src="${
                    user.avatar || "https://placehold.co/40x40"
                  }" alt="${
                    user.displayName
                  }" class="rounded-circle me-2" style="width: 40px; height: 40px; object-fit: cover;">
                  <div>
                    <div class="fw-bold">${escapeHtml(user.displayName)}</div>
                    <small class="text-muted">${escapeHtml(user.email)}</small>
                    ${
                      user.is_banned
                        ? '<span class="badge bg-danger ms-2">BANNED</span>'
                        : ""
                    }
                  </div>
                </div>
                <div class="d-flex gap-2">
                  ${
                    user.is_banned
                      ? `<button class="btn btn-sm btn-outline-success unban-user-btn" data-user-id="${user.id}">Unban</button>`
                      : `<button class="btn btn-sm btn-outline-danger ban-user-btn" data-user-id="${user.id}">Ban</button>`
                  }
                </div>
              </div>
            `
                )
                .join("");
            } catch (err) {
              usersList.innerHTML =
                '<div class="text-danger text-center py-3">Error searching users</div>';
            }
          }, 300);
        });
      }

      function isAdmin() {
        // Check if user is loaded and has admin privileges
        if (!auth || !auth.user) {
          return false;
        }
        
        // Check for admin flag or specific admin username
        return auth.user.is_admin === true || 
               auth.user.username === "Kiyoshi" || 
               auth.user.username === "kiyoshi";
      }

      // Load pending context reviews for admin
      async function loadContextReviews() {
        const container = document.getElementById("contextReviewsContainer");
        if (!container) {
          console.error("contextReviewsContainer element not found");
          return;
        }

        console.log("Loading context reviews...");
        console.log("Current user:", auth.user);
        console.log("Is admin:", isAdmin());
        console.log("Client type:", window.firebaseArtHubClient.constructor.name);

        try {
          // Get pending contexts (those without 90% approval but not yet admin-approved)
          console.log("Calling getPendingContexts...");
          const pendingContexts =
            await window.firebaseArtHubClient.getPendingContexts();
          
          console.log("Pending contexts received:", pendingContexts);
          console.log("Number of pending contexts:", pendingContexts?.length || 0);

          if (pendingContexts.length === 0) {
            container.innerHTML =
              '<div class="text-muted text-center py-3">No pending contexts to review</div>';
            return;
          }

          container.innerHTML = pendingContexts
            .map(
              (context) => `
          <div class="context-review-item" data-context-id="${context.id}">
            <div class="d-flex justify-content-between align-items-start mb-2">
              <div>
                <strong>Context by ${escapeHtml(context.username)}</strong>
                <small class="text-muted ms-2">${formatTimeAgo(
                  context.created_at
                )}</small>
              </div>
              <div class="text-end">
                <div class="small text-muted">
                  Votes: ${context.upvotes || 0} up, ${
                context.downvotes || 0
              } down
                </div>
                <div class="small text-muted">
                  Approval: ${Math.round(
                    ((context.upvotes || 0) /
                      Math.max(
                        (context.upvotes || 0) + (context.downvotes || 0),
                        1
                      )) *
                      100
                  )}%
                </div>
              </div>
            </div>
            <div class="context-text">
              ${escapeHtml(context.content || context.text || "No content")}
            </div>
            <div class="mt-2">
              <small class="text-muted">Related to post: </small>
              <span class="badge bg-light text-dark">${context.post_id}</span>
            </div>
            <div class="d-flex gap-2 mt-3">
              <button class="btn btn-sm btn-success admin-action-btn" onclick="approveContext('${
                context.id
              }')">
                <i class="bi bi-check-lg me-1"></i>Approve
              </button>
              <button class="btn btn-sm btn-danger admin-action-btn" onclick="rejectContext('${
                context.id
              }')">
                <i class="bi bi-x-lg me-1"></i>Reject
              </button>
              <button class="btn btn-sm btn-outline-secondary admin-action-btn" onclick="viewContextPost('${
                context.post_id
              }')">
                <i class="bi bi-eye me-1"></i>View Post
              </button>
            </div>
          </div>
        `
            )
            .join("");
        } catch (err) {
          console.error("Error loading context reviews:", err);
          
          if (err.message && err.message.includes('Admin access required')) {
            container.innerHTML =
              '<div class="text-warning text-center py-3">Admin access required to view context reviews</div>';
          } else {
            container.innerHTML =
              `<div class="text-danger text-center py-3">Error loading context reviews: ${err.message || err}</div>`;
          }
        }
      }

      // Admin approve context
      async function approveContext(contextId) {
        if (!isAdmin()) {
          toast("Admin access required", "error");
          return;
        }

        try {
          await window.firebaseArtHubClient.adminApproveContext(contextId);
          toast("Context approved by admin", "success");
          await loadContextReviews(); // Refresh the list
          loadFeed(true); // Refresh feed to show approved context
        } catch (error) {
          toast("Failed to approve context: " + error.message, "error");
        }
      }

      // Admin reject context
      async function rejectContext(contextId) {
        if (!isAdmin()) {
          toast("Admin access required", "error");
          return;
        }

        if (
          !confirm(
            "Are you sure you want to reject this context? This action cannot be undone."
          )
        ) {
          return;
        }

        try {
          await window.firebaseArtHubClient.adminRejectContext(contextId);
          toast("Context rejected", "success");
          await loadContextReviews(); // Refresh the list
        } catch (error) {
          toast("Failed to reject context: " + error.message, "error");
        }
      }

      // View the post that the context is related to
      function viewContextPost(postId) {
        // Switch to feed and highlight the specific post
        showSection("feed");
        // In a real implementation, this would scroll to and highlight the specific post
        toast("Switched to feed view", "info");
      }

      // View post from notification
      function viewNotificationPost(postId) {
        // Close notifications dropdown
        const notificationsDropdown = document.getElementById(
          "notificationsDropdown"
        );
        if (notificationsDropdown) {
          const dropdown = bootstrap.Dropdown.getInstance(
            notificationsDropdown.querySelector('[data-bs-toggle="dropdown"]')
          );
          if (dropdown) dropdown.hide();
        }

        // Switch to feed and highlight the specific post
        showSection("feed");
        toast("Navigated to post", "info");

        // In a real implementation, this would scroll to and highlight the specific post
        setTimeout(() => {
          const postElement = document.querySelector(
            `[data-post-id="${postId}"]`
          );
          if (postElement) {
            postElement.scrollIntoView({ behavior: "smooth", block: "center" });
            postElement.style.boxShadow = "0 0 20px rgba(0, 123, 255, 0.5)";
            setTimeout(() => {
              postElement.style.boxShadow = "";
            }, 3000);
          }
        }, 500);
      }

      // View post from notification
      function viewNotificationPost(postId) {
        // Switch to feed and highlight the specific post
        showSection("feed");
        // In a real implementation, this would scroll to and highlight the specific post
        toast("Navigating to post...", "info");

        // Close notifications dropdown
        const dropdownToggle = document.getElementById("notificationsBtn");
        if (dropdownToggle) {
          const dropdown = bootstrap.Dropdown.getInstance(dropdownToggle);
          if (dropdown) dropdown.hide();
        }
      }
      
      // Delete post confirmation
      async function confirmDeletePost(postId, reportId = null) {
        if (!auth.user) {
          toast('Please login to delete posts', 'error');
          return;
        }
        
        const postCard = document.querySelector(`[data-post-id="${postId}"]`);
        const postAuthor = postCard?.querySelector('.post-header strong')?.textContent || 'Unknown';
        const isOwnPost = postCard?.classList.contains('own-post') || postCard?.dataset.userId === auth.user.id;
        
        if (!isOwnPost && !isAdmin()) {
          toast('You can only delete your own posts', 'error');
          return;
        }
        
        const confirmMessage = isOwnPost 
          ? 'Are you sure you want to delete this post? This action cannot be undone.'
          : `Are you sure you want to delete this post by ${postAuthor}? This action cannot be undone.`;
          
        if (confirm(confirmMessage)) {
          try {
            if (isAdmin() && !isOwnPost) {
              await adminRemovePost(postId);
            } else {
              await window.firebaseArtHubClient.deletePost(postId);
              toast('Post deleted successfully', 'success');
            }
            
            // Remove from UI
            if (postCard) {
              postCard.remove();
            }
            
            // Refresh feed
            loadFeed(true);
            
          } catch (error) {
            console.error('Error deleting post:', error);
            toast('Failed to delete post: ' + error.message, 'error');
          }
        }
      }
      
      // Admin Functions
      async function adminRemovePost(postId) {
        if (!isAdmin()) {
          toast('Admin access required', 'error');
          return;
        }
        
        if (!confirm('Are you sure you want to remove this post? This action cannot be undone.')) {
          return;
        }
        
        try {
          await window.firebaseArtHubClient.adminRemovePost(postId);
          toast('Post removed successfully', 'success');
          
          // Remove post from UI
          const postElement = document.querySelector(`[data-post-id="${postId}"]`);
          if (postElement) {
            postElement.remove();
          }
          
          // Refresh feed to ensure consistency
          loadFeed(true);
        } catch (error) {
          toast('Failed to remove post: ' + error.message, 'error');
        }
      }
      
      async function adminBanUser(userId, username) {
        if (!isAdmin()) {
          toast('Admin access required', 'error');
          return;
        }
        
        const reason = prompt(`Enter reason for banning user "${username}":`);
        if (!reason || !reason.trim()) {
          return;
        }
        
        if (!confirm(`Are you sure you want to ban user "${username}"? This will prevent them from accessing the platform.`)) {
          return;
        }
        
        try {
          await window.firebaseArtHubClient.adminBanUser(userId, reason.trim());
          toast(`User "${username}" has been banned`, 'success');
          
          // Remove all posts by this user from UI
          const userPosts = document.querySelectorAll(`[data-post-id]`);
          userPosts.forEach(post => {
            const usernameEl = post.querySelector('.post-meta strong');
            if (usernameEl && usernameEl.textContent === username) {
              post.remove();
            }
          });
          
          // Refresh feed to ensure consistency
          loadFeed(true);
        } catch (error) {
          toast('Failed to ban user: ' + error.message, 'error');
        }
      }
      
      let currentPostContextReview = null;
      
      async function showPostContextReview(postId) {
        if (!isAdmin()) {
          toast('Admin access required', 'error');
          return;
        }
        
        currentPostContextReview = postId;
        
        try {
          // Get all context submissions for this post
          const contexts = await window.firebaseArtHubClient.getPostContextSubmissions(postId);
          
          let modalHtml = `
            <div class="modal fade" id="postContextModal" tabindex="-1">
              <div class="modal-dialog modal-lg">
                <div class="modal-content">
                  <div class="modal-header">
                    <h5 class="modal-title">Context Submissions for Post</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                  </div>
                  <div class="modal-body">
                    ${contexts.length === 0 ? 
                      '<div class="text-center text-muted py-4">No context submissions for this post</div>' :
                      contexts.map(context => `
                        <div class="context-review-item mb-3 p-3 border rounded" data-context-id="${context.id}">
                          <div class="d-flex justify-content-between align-items-start mb-2">
                            <div>
                              <strong>By: ${escapeHtml(context.username)}</strong>
                              <small class="text-muted ms-2">${formatTimeAgo(context.created_at)}</small>
                            </div>
                            <div class="text-end">
                              <div class="small text-muted">
                                Votes: ${context.upvotes || 0} up, ${context.downvotes || 0} down
                              </div>
                              <div class="small text-muted">
                                Approval: ${Math.round(((context.upvotes || 0) / Math.max((context.upvotes || 0) + (context.downvotes || 0), 1)) * 100)}%
                              </div>
                              <div class="small ${
                                context.admin_approved === true ? 'text-success' :
                                context.admin_approved === false ? 'text-danger' : 'text-warning'
                              }">
                                ${context.admin_approved === true ? 'Admin Approved' :
                                  context.admin_approved === false ? 'Admin Rejected' : 'Pending Review'}
                              </div>
                            </div>
                          </div>
                          <div class="context-text bg-light p-2 rounded mb-2">
                            ${escapeHtml(context.content)}
                          </div>
                          <div class="d-flex gap-2">
                            ${context.admin_approved !== true ? 
                              `<button class="btn btn-sm btn-success" onclick="adminApprovePostContext('${context.id}')">
                                <i class="bi bi-check-lg me-1"></i>Approve
                              </button>` : ''}
                            ${context.admin_approved !== false ? 
                              `<button class="btn btn-sm btn-danger" onclick="adminRejectPostContext('${context.id}')">
                                <i class="bi bi-x-lg me-1"></i>Reject
                              </button>` : ''}
                          </div>
                        </div>
                      `).join('')
                    }
                  </div>
                  <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                  </div>
                </div>
              </div>
            </div>
          `;
          
          // Remove existing modal if present
          const existingModal = document.getElementById('postContextModal');
          if (existingModal) {
            existingModal.remove();
          }
          
          // Add modal to page
          document.body.insertAdjacentHTML('beforeend', modalHtml);
          
          // Show modal
          const modal = new bootstrap.Modal(document.getElementById('postContextModal'));
          modal.show();
          
          // Clean up when modal is hidden
          document.getElementById('postContextModal').addEventListener('hidden.bs.modal', function() {
            this.remove();
            currentPostContextReview = null;
          });
        } catch (error) {
          toast('Failed to load context submissions: ' + error.message, 'error');
        }
      }
      
      async function adminApprovePostContext(contextId) {
        if (!isAdmin()) {
          toast('Admin access required', 'error');
          return;
        }
        
        try {
          await window.firebaseArtHubClient.adminApproveContext(contextId);
          toast('Context approved', 'success');
          
          // Update UI
          const contextItem = document.querySelector(`[data-context-id="${contextId}"]`);
          if (contextItem) {
            const statusEl = contextItem.querySelector('.text-end .small:last-child');
            if (statusEl) {
              statusEl.className = 'small text-success';
              statusEl.textContent = 'Admin Approved';
            }
            
            // Hide action buttons
            const buttons = contextItem.querySelectorAll('.btn');
            buttons.forEach(btn => btn.style.display = 'none');
          }
          
          // Refresh feed to show approved context
          loadFeed(true);
        } catch (error) {
          toast('Failed to approve context: ' + error.message, 'error');
        }
      }
      
      async function adminRejectPostContext(contextId) {
        if (!isAdmin()) {
          toast('Admin access required', 'error');
          return;
        }
        
        if (!confirm('Are you sure you want to reject this context? This action cannot be undone.')) {
          return;
        }
        
        try {
          await window.firebaseArtHubClient.adminRejectContext(contextId);
          toast('Context rejected', 'success');
          
          // Update UI
          const contextItem = document.querySelector(`[data-context-id="${contextId}"]`);
          if (contextItem) {
            const statusEl = contextItem.querySelector('.text-end .small:last-child');
            if (statusEl) {
              statusEl.className = 'small text-danger';
              statusEl.textContent = 'Admin Rejected';
            }
            
            // Hide action buttons
            const buttons = contextItem.querySelectorAll('.btn');
            buttons.forEach(btn => btn.style.display = 'none');
          }
        } catch (error) {
          toast('Failed to reject context: ' + error.message, 'error');
        }
      }
      
      async function quickApproveContext(contextId) {
        if (!isAdmin()) {
          toast('Admin access required', 'error');
          return;
        }
        
        try {
          await window.firebaseArtHubClient.adminApproveContext(contextId);
          toast('Context approved', 'success');
          
          // Refresh feed to show updated approval status
          loadFeed(true);
        } catch (error) {
          toast('Failed to approve context: ' + error.message, 'error');
        }
      }
      
      async function loadContextReviews() {
        const contextReviewList = document.getElementById("contextReviewList");
        if (!contextReviewList) return;

        try {
          const pendingContexts =
            await window.firebaseArtHubClient.getPendingContexts();

          if (pendingContexts.length === 0) {
            contextReviewList.innerHTML = `
            <div class="text-center text-muted py-4">
              <i class="bi bi-check-circle me-2"></i>No pending contexts to review
            </div>
          `;
            return;
          }

          contextReviewList.innerHTML = pendingContexts
            .map(
              (context) => `
          <div class="context-review-card" data-context-id="${context.id}">
            <div class="d-flex justify-content-between align-items-start mb-2">
              <div>
                <strong>Context for Post #${context.post_id}</strong>
                <div class="small text-muted">Submitted by ${
                  context.author_username || "Unknown"
                }  ${formatTimeAgo(context.created_at)}</div>
              </div>
              <span class="badge bg-warning">Pending Review</span>
            </div>
            
            <div class="context-content p-3 mb-3" style="background: rgba(0,0,0,0.05); border-radius: 6px; font-style: italic;">
              "${escapeHtml(context.text)}"
            </div>
            
            <div class="context-stats">
              <div class="context-stat">
                <span class="stat-number text-success">${
                  context.upvotes || 0
                }</span>
                <span class="stat-label">Upvotes</span>
              </div>
              <div class="context-stat">
                <span class="stat-number text-danger">${
                  context.downvotes || 0
                }</span>
                <span class="stat-label">Downvotes</span>
              </div>
              <div class="context-stat">
                <span class="stat-number text-info">${Math.round(
                  context.approval_rate || 0
                )}%</span>
                <span class="stat-label">Approval</span>
              </div>
              <div class="context-stat">
                <span class="stat-number">${
                  (context.upvotes || 0) + (context.downvotes || 0)
                }</span>
                <span class="stat-label">Total Votes</span>
              </div>
            </div>
            
            <div class="d-flex gap-2 mt-3">
              <button class="btn btn-success btn-sm approve-context-btn" data-context-id="${
                context.id
              }">
                <i class="bi bi-check-circle me-1"></i>Approve Context
              </button>
              <button class="btn btn-danger btn-sm reject-context-btn" data-context-id="${
                context.id
              }">
                <i class="bi bi-x-circle me-1"></i>Reject Context
              </button>
              <button class="btn btn-outline-secondary btn-sm view-post-btn" data-post-id="${
                context.post_id
              }">
                <i class="bi bi-eye me-1"></i>View Original Post
              </button>
            </div>
          </div>
        `
            )
            .join("");
        } catch (err) {
          console.error("Error loading context reviews:", err);
          console.error("Error details:", err.message, err.stack);
          contextReviewList.innerHTML =
            `<div class="text-danger text-center py-3">Error loading context reviews: ${err.message || err}</div>`;
        }
      }

      // Avatar upload handler with cropping integration
      document
        .getElementById("avatarUpload")
        .addEventListener("change", function (e) {
          const file = e.target.files[0];
          if (!file) return;

          // Validate file size (allow up to 5MB initially for cropping, will compress after)
          if (file.size > 5 * 1024 * 1024) {
            toast("Image too large. Please choose a file under 5MB for cropping.");
            return;
          }

          // Validate file type
          if (!file.type.startsWith("image/")) {
            toast("Please select a valid image file.");
            return;
          }

          const reader = new FileReader();
          reader.onload = function (event) {
            // Open cropping modal instead of direct upload
            openCropModal(event.target.result);
          };

          reader.readAsDataURL(file);
        });

      // Settings form handler
      document
        .getElementById("settingsForm")
        .addEventListener("submit", async (e) => {
          e.preventDefault();

          const newSettings = {
            privacy: document.getElementById("settingPrivacy").value,
            notifications: document.getElementById("settingNotifications")
              .checked,
            autoplay: document.getElementById("settingAutoplay").checked,
          };

          try {
            await artHubClient.updateSettings(newSettings);
            toast("Settings saved successfully!");
          } catch (err) {
            toast("Failed to save settings");
          }
        });

      // Function to update all avatar instances in the UI
      function updateAvatarsInUI(newAvatarUrl) {
        // Update profile avatar in sidebar
        const profileAvatar = document.getElementById("profileAvatar");
        if (profileAvatar) profileAvatar.src = newAvatarUrl;

        // Update create post avatar
        const createPostAvatar = document.getElementById("createPostAvatar");
        if (createPostAvatar) createPostAvatar.src = newAvatarUrl;

        // Update any other avatar instances
        document.querySelectorAll(".user-avatar").forEach((avatar) => {
          if (avatar.dataset.userId === auth.user?.id.toString()) {
            avatar.src = newAvatarUrl;
          }
        });
      }

      // --- Feed Logic ---
      const feedEl = document.getElementById("feed");
      const publishBtn = document.getElementById("publishBtn");
      const postText = document.getElementById("postText");
      const imageInput = document.getElementById("imageInput");
      let tempImageData = null;

      // Security and spam prevention
      let lastPostTime = 0;
      let postCount = 0;
      let activityScore = 0;
      let lastActivityReset = Date.now();
      const POST_COOLDOWN = 30000; // 30 seconds between posts
      const ACTIVITY_THRESHOLD = 10; // Trigger security check after 10 rapid actions
      const ACTIVITY_RESET_TIME = 300000; // Reset activity score every 5 minutes

      // Cooldown check function
      function checkCooldown() {
        return Date.now() - lastPostTime >= POST_COOLDOWN;
      }

      // Track activity for spam prevention
      function trackActivity() {
        activityScore++;
        
        // Reset activity score periodically
        if (Date.now() - lastActivityReset > ACTIVITY_RESET_TIME) {
          activityScore = 0;
          lastActivityReset = Date.now();
        }
      }

      // Check if security verification is needed
      function needsSecurityCheck() {
        return activityScore >= ACTIVITY_THRESHOLD;
      }

      // Show reCAPTCHA verification
      async function showRecaptcha() {
        return new Promise((resolve) => {
          // For demo purposes, always return true
          // In production, implement actual reCAPTCHA
          setTimeout(() => {
            toast('Security check passed', 'success');
            activityScore = 0; // Reset activity score after successful verification
            resolve(true);
          }, 1000);
        });
      }

      // Enhanced image upload handling with compression and cropping
      const addImageBtn = document.getElementById("addImageBtn");
      const imagePreview = document.getElementById("imagePreview");
      const imagePreviewArea = document.getElementById("imagePreviewArea");
      const removeImageBtn = document.getElementById("removeImageBtn");
      const imageButtonText = document.getElementById("imageButtonText");
      const imageHint = document.getElementById("imageHint");
      let currentImageFile = null;
      let compressedImageData = null;

      // Image compression function (Enhanced for 1MB Firestore limit)
      function compressImage(file, maxSizeMB = 0.9, quality = 0.8) {
        return new Promise((resolve) => {
          const canvas = document.createElement("canvas");
          const ctx = canvas.getContext("2d");
          const img = new Image();

          img.onload = function () {
            // Calculate new dimensions to reduce file size
            let { width, height } = img;
            const maxDimension = 1920; // Max width or height

            if (width > height && width > maxDimension) {
              height = (height * maxDimension) / width;
              width = maxDimension;
            } else if (height > maxDimension) {
              width = (width * maxDimension) / height;
              height = maxDimension;
            }

            canvas.width = width;
            canvas.height = height;

            // Draw and compress
            ctx.drawImage(img, 0, 0, width, height);

            // Try different quality levels until under maxSizeMB
            let currentQuality = quality;
            let compressedDataUrl;

            const tryCompress = () => {
              compressedDataUrl = canvas.toDataURL(
                "image/jpeg",
                currentQuality
              );
              const compressedSize =
                (compressedDataUrl.length * 3) / 4 / (1024 * 1024); // Approximate size in MB

              if (compressedSize > maxSizeMB && currentQuality > 0.1) {
                currentQuality -= 0.1;
                tryCompress();
              } else {
                resolve({
                  dataUrl: compressedDataUrl,
                  originalSize: file.size,
                  compressedSize: compressedSize,
                  quality: currentQuality,
                  dimensions: { width, height },
                });
              }
            };

            tryCompress();
          };

          img.src = URL.createObjectURL(file);
        });
      }

      // Cropping functionality
      function openImageEditor(imageData, file) {
        const modal = document.createElement("div");
        modal.className = "modal fade";
        modal.innerHTML = `
        <div class="modal-dialog modal-xl modal-dialog-centered">
          <div class="image-editor-modal modal-content">
            <div class="modal-header">
              <h5 class="modal-title">Edit Image</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body text-center">
              <div class="row">
                <div class="col-md-8">
                  <div id="cropperContainer" class="border rounded p-3 image-editor-container">
                    <img id="cropperImage" src="${imageData}" style="max-width: 100%; max-height: 400px; border: 2px dashed #3498db; border-radius: 8px;">
                  </div>
                </div>
                <div class="col-md-4">
                  <div class="card image-editor-controls">
                    <div class="card-header">
                      <h6 class="mb-0">Image Controls</h6>
                    </div>
                    <div class="card-body">
                      <div class="mb-3">
                        <label class="form-label">Crop Preset</label>
                        <div class="btn-group-vertical w-100">
                          <button type="button" class="btn btn-outline-secondary btn-sm crop-preset" data-ratio="free">Free Crop</button>
                          <button type="button" class="btn btn-outline-secondary btn-sm crop-preset" data-ratio="1:1">Square (1:1)</button>
                          <button type="button" class="btn btn-outline-secondary btn-sm crop-preset" data-ratio="4:3">Landscape (4:3)</button>
                          <button type="button" class="btn btn-outline-secondary btn-sm crop-preset" data-ratio="16:9">Widescreen (16:9)</button>
                        </div>
                      </div>
                      <div class="mb-3">
                        <label class="form-label">Rotate</label>
                        <div class="btn-group w-100">
                          <button type="button" class="btn btn-outline-secondary btn-sm" id="rotateLeft">
                            <i class="bi bi-arrow-counterclockwise"></i>
                          </button>
                          <button type="button" class="btn btn-outline-secondary btn-sm" id="rotateRight">
                            <i class="bi bi-arrow-clockwise"></i>
                          </button>
                        </div>
                      </div>
                      <div class="mb-3">
                        <small class="text-muted">
                          Original: ${(file.size / 1024 / 1024).toFixed(
                            1
                          )}MB<br>
                          <span id="newSize">Estimated: Calculating...</span>
                        </small>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
              <button type="button" class="btn btn-primary" id="applyEdit">Apply & Use Image</button>
            </div>
          </div>
        </div>
      `;

        document.body.appendChild(modal);
        const modalInstance = new bootstrap.Modal(modal);

        // Initialize cropper simulation variables
        let currentRotation = 0;
        const cropperImage = modal.querySelector("#cropperImage");
        const newSizeSpan = modal.querySelector("#newSize");

        // Rotation handlers
        modal.querySelector("#rotateLeft").addEventListener("click", () => {
          currentRotation -= 90;
          cropperImage.style.transform = `rotate(${currentRotation}deg)`;
        });

        modal.querySelector("#rotateRight").addEventListener("click", () => {
          currentRotation += 90;
          cropperImage.style.transform = `rotate(${currentRotation}deg)`;
        });

        // Crop preset handlers
        modal.querySelectorAll(".crop-preset").forEach((btn) => {
          btn.addEventListener("click", (e) => {
            modal
              .querySelectorAll(".crop-preset")
              .forEach((b) => b.classList.remove("active"));
            e.target.classList.add("active");
            const ratio = e.target.dataset.ratio;
            cropperImage.style.border = "2px dashed #007bff";
            toast(`Crop ratio set to ${ratio}`);
          });
        });

        function updateSizeEstimate() {
          // Show original size estimate
          const estimatedSize = file.size / (1024 * 1024);
          newSizeSpan.textContent = `Estimated: ${estimatedSize.toFixed(1)}MB (will be auto-compressed)`;
        }

        // Apply edit handler
        modal
          .querySelector("#applyEdit")
          .addEventListener("click", async () => {
            const loadingBtn = modal.querySelector("#applyEdit");
            loadingBtn.disabled = true;
            loadingBtn.innerHTML =
              '<span class="spinner-border spinner-border-sm me-2"></span>Processing...';

            try {
              // Create canvas for final processing
              const canvas = document.createElement("canvas");
              const ctx = canvas.getContext("2d");
              const img = new Image();

              img.onload = async function () {
                // Apply rotation and compression
                canvas.width = img.width;
                canvas.height = img.height;

                if (currentRotation !== 0) {
                  ctx.translate(canvas.width / 2, canvas.height / 2);
                  ctx.rotate((currentRotation * Math.PI) / 180);
                  ctx.drawImage(img, -img.width / 2, -img.height / 2);
                } else {
                  ctx.drawImage(img, 0, 0);
                }

                // Use automatic compression with compressImage function
                const tempDataUrl = canvas.toDataURL("image/jpeg", 0.8);
                
                // Convert dataURL to File for compression
                function dataURLtoFile(dataurl, filename) {
                  const arr = dataurl.split(',');
                  const mime = arr[0].match(/:(.*?);/)[1];
                  const bstr = atob(arr[1]);
                  let n = bstr.length;
                  const u8arr = new Uint8Array(n);
                  while(n--){
                    u8arr[n] = bstr.charCodeAt(n);
                  }
                  return new File([u8arr], filename, {type:mime});
                }
                
                const processedResult = await compressImage(
                  dataURLtoFile(tempDataUrl, 'processed-image.jpg'), 
                  0.9, 
                  0.8
                );
                const processedDataUrl = processedResult.dataUrl;
                const finalSize =
                  (processedDataUrl.length * 3) / 4 / (1024 * 1024);

                // Set the processed image
                tempImageData = processedDataUrl;
                imagePreview.src = processedDataUrl;
                imagePreviewArea.style.display = "block";
                imageButtonText.textContent = "Change Image";
                imageHint.textContent = `Processed - ${finalSize.toFixed(1)}MB`;

                modalInstance.hide();
                toast("Image processed successfully!");
              };

              img.src = imageData;
            } catch (error) {
              toast("Failed to process image: " + error.message);
            }
          });

        // Clean up modal when closed
        modal.addEventListener("hidden.bs.modal", () => {
          document.body.removeChild(modal);
        });

        modalInstance.show();
        updateSizeEstimate();
      }

      // Add image button click handler
      addImageBtn.addEventListener("click", () => {
        imageInput.click();
      });

      // File input change handler with compression and cropping workflow
      imageInput.addEventListener("change", async (e) => {
        const file = e.target.files[0];
        if (!file) return;

        // Validate file type
        if (!file.type.startsWith("image/")) {
          toast("Please select a valid image file.");
          return;
        }

        currentImageFile = file;
        const fileSizeMB = file.size / 1024 / 1024;

        // Show loading state
        imageButtonText.textContent = "Processing...";
        imageHint.innerHTML =
          '<span class="spinner-border spinner-border-sm me-2"></span>Analyzing image...';

        const progress = showUploadProgress();

        const reader = new FileReader();
        reader.onload = async (ev) => {
          const originalDataUrl = ev.target.result;

          try {
            progress.update(30, "Analyzing image...");

            if (fileSizeMB > 1) {
              // Auto-compress large files for Firestore compatibility
              progress.update(50, "Compressing image for Firestore...");
              toast(
                `Image is ${fileSizeMB.toFixed(
                  1
                )}MB. Auto-compressing to meet 1MB Firestore limit...`,
                "info"
              );

              const compressed = await compressImage(file, 5, 0.8);
              const savings = (
                ((compressed.originalSize -
                  compressed.compressedSize * 1024 * 1024) /
                  compressed.originalSize) *
                100
              ).toFixed(1);

              progress.update(80, "Compression complete!");
              toast(
                `Image compressed! Reduced by ${savings}% (${(
                  compressed.originalSize /
                  1024 /
                  1024
                ).toFixed(1)}MB  ${compressed.compressedSize.toFixed(1)}MB)`,
                "success"
              );

              progress.update(100, "Ready for editing!");
              setTimeout(() => progress.hide(), 1000);

              // Open editor with compressed image
              openImageEditor(compressed.dataUrl, file);
            } else {
              progress.update(80, "Processing complete!");
              // File is under 5MB, open editor directly
              progress.update(100, "Ready for editing!");
              setTimeout(() => progress.hide(), 1000);
              openImageEditor(originalDataUrl, file);
            }
          } catch (error) {
            progress.hide();
            toast("Failed to process image: " + error.message);
            // Reset UI on error
            imageButtonText.textContent = "Add Image";
            imageHint.textContent = "PNG, JPG below or = 1MB";
          }
        };

        reader.readAsDataURL(file);
      });

      // Remove image handler
      removeImageBtn.addEventListener("click", () => {
        tempImageData = null;
        imageInput.value = "";
        imagePreviewArea.style.display = "none";
        imageButtonText.textContent = "Add Image";
        imageHint.textContent = "PNG, JPG up to 5MB";
        toast("Image removed");
      });

      // Click on preview to change image
      imagePreview.addEventListener("click", () => {
        imageInput.click();
      });

      // Add drag-and-drop functionality to the create post area
      const createCard = document.querySelector(".create-card");

      createCard.addEventListener("dragover", (e) => {
        e.preventDefault();
        e.stopPropagation();
        createCard.style.backgroundColor = "#f0f8ff";
        createCard.style.borderColor = "#007bff";
        createCard.style.transform = "scale(1.02)";
      });

      createCard.addEventListener("dragleave", (e) => {
        e.preventDefault();
        e.stopPropagation();
        createCard.style.backgroundColor = "";
        createCard.style.borderColor = "";
        createCard.style.transform = "";
      });

      createCard.addEventListener("drop", async (e) => {
        e.preventDefault();
        e.stopPropagation();
        createCard.style.backgroundColor = "";
        createCard.style.borderColor = "";
        createCard.style.transform = "";

        const files = Array.from(e.dataTransfer.files).filter((file) =>
          file.type.startsWith("image/")
        );
        if (files.length > 0) {
          const file = files[0]; // Take first image
          currentImageFile = file;
          const fileSizeMB = file.size / 1024 / 1024;

          // Show processing state
          imageButtonText.textContent = "Processing...";
          imageHint.innerHTML =
            '<span class="spinner-border spinner-border-sm me-2"></span>Processing dropped image...';

          const reader = new FileReader();
          reader.onload = async (ev) => {
            const originalDataUrl = ev.target.result;

            try {
              if (fileSizeMB > 1) {
                // Auto-compress large files for Firestore compatibility
                toast(
                  `Dropped image is ${fileSizeMB.toFixed(
                    1
                  )}MB. Auto-compressing for 1MB Firestore limit...`,
                  "info"
                );

                const compressed = await compressImage(file, 0.9, 0.8);
                const savings = (
                  ((compressed.originalSize -
                    compressed.compressedSize * 1024 * 1024) /
                    compressed.originalSize) *
                  100
                ).toFixed(1);

                toast(
                  `Image compressed! Reduced by ${savings}% (${(
                    compressed.originalSize /
                    1024 /
                    1024
                  ).toFixed(1)}MB  ${compressed.compressedSize.toFixed(1)}MB)`,
                  "success"
                );

                // Open editor with compressed image
                openImageEditor(compressed.dataUrl, file);
              } else {
                // File is under 5MB, open editor directly
                openImageEditor(originalDataUrl, file);
              }
            } catch (error) {
              toast("Failed to process dropped image: " + error.message);
              // Reset UI on error
              imageButtonText.textContent = "Add Image";
              imageHint.textContent = "PNG, JPG up to 5MB";
            }
          };

          reader.readAsDataURL(file);
        } else {
          toast("Please drop an image file");
        }
      });

      function escapeHtml(str) {
        if (!str || typeof str !== "string") return "";
        return str.replace(
          /[&<>"']/g,
          (c) =>
            ({
              "&": "&amp;",
              "<": "&lt;",
              ">": "&gt;",
              '"': "&quot;",
              "'": "&#39;",
            }[c])
        );
      }
      
      function getDefaultAvatar() {
        // Return a data URL with a person silhouette SVG similar to Facebook's default
        return 'data:image/svg+xml;base64,' + btoa(`
          <svg width="100" height="100" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg">
            <circle cx="50" cy="50" r="50" fill="#e4e6ea"/>
            <circle cx="50" cy="35" r="15" fill="#bcc0c4"/>
            <path d="M20 85 C20 65, 30 55, 50 55 C70 55, 80 65, 80 85" fill="#bcc0c4"/>
          </svg>
        `);
      }

      function formatTimeAgo(dateString) {
        return window.firebaseArtHubClient.formatTimeAgo(dateString);
      }

      function postCard(p) {
        const mine = auth.user && p.user_id === auth.user.id;
        const li = document.createElement("div");
        li.className = "post-card";
        
        // Debug post data
        console.log("Creating post card for:", p.id, "Type:", typeof p.id, "Context:", p.context);
        
        li.dataset.postId = p.id;
        const profilePic = p.profile_picture || getDefaultAvatar();
        const likedClass = p.user_liked ? "text-danger" : "";

        // Check if post is saved from localStorage
        const savedPosts = JSON.parse(
          localStorage.getItem("saved_posts") || "[]"
        );
        const isSaved = p.user_saved || savedPosts.includes(p.id);
        li.innerHTML = `
        <div class="post-header">
          <img src="${profilePic}" class="avatar" alt="User Avatar">
          <div class="post-meta">
            <strong>${escapeHtml(p.username)}</strong>
            ${
              p.is_admin || p.username === "Kiyoshi"
                ? `<span class="admin-badge ms-2">ADMIN</span>`
                : ""
            }
            <small>${formatTimeAgo(p.created_at)}</small>
            ${
              p.edited_at
                ? `<small class="text-muted ms-2 edit-indicator" data-post-id="${p.id}" style="cursor: pointer; text-decoration: underline;">(edited)</small>`
                : ""
            }
          </div>
          <div class="post-actions d-flex gap-1">
            ${
              mine
                ? `<button class="btn btn-sm btn-outline-light edit-post-btn" data-post-id="${p.id}" style="color: white; border-color: rgba(255,255,255,0.3);">
              <i class="bi bi-pencil" style="color: white;"></i>
            </button>`
                : ""
            }
            ${
              mine || isAdmin()
                ? `<button class="btn btn-sm btn-outline-light delete-post-btn" data-post-id="${p.id}" data-post-author="${escapeHtml(p.username)}" style="color: white; border-color: rgba(255,255,255,0.3);">
              <i class="bi bi-trash" style="color: white;"></i>
            </button>`
                : ""
            }
            ${
              auth.token && !mine
                ? `<button class="btn btn-sm btn-outline-light report-post-btn" data-post-id="${
                    p.id
                  }" data-post-author="${escapeHtml(
                    p.username
                  )}" style="color: white; border-color: rgba(255,255,255,0.3);">
              <i class="bi bi-flag" style="color: white;"></i>
            </button>`
                : ""
            }
            ${
              isAdmin() && !mine
                ? `<div class="admin-post-controls d-flex gap-1">
                  <button class="btn btn-sm admin-btn" data-post-id="${p.id}" onclick="showPostContextReview('${p.id}')" title="Review Context Submissions">
                    <i class="bi bi-chat-square-text"></i>
                  </button>
                  <button class="btn btn-sm admin-btn danger" data-post-id="${p.id}" data-post-author="${escapeHtml(p.username)}" onclick="adminBanUser('${p.user_id}', '${escapeHtml(p.username)}')" title="Ban User">
                    <i class="bi bi-hammer"></i>
                  </button>
                  <button class="btn btn-sm admin-btn danger" data-post-id="${p.id}" onclick="adminRemovePost('${p.id}')" title="Remove Post">
                    <i class="bi bi-x-lg"></i>
                  </button>
                </div>`
                : ""
            }
          </div>
          ${p.context ? '<span class="context-indicator">Context</span>' : ""}
        </div>
        <div class="post-body">
          <div class="post-content">
            ${(() => {
              const linkData = extractLinksFromText(p.body);
              return `
                <p style="white-space:pre-wrap;">${escapeHtml(linkData.cleanText)}</p>
                ${renderReferences(linkData.links)}
              `;
            })()}
            ${
              p.original_body && p.edited_at
                ? `<div class="original-content" style="display: none;">
              <div class="alert alert-light border small mb-2">
                <strong>Original post:</strong>
              </div>
              <p style="white-space:pre-wrap;">${escapeHtml(
                p.original_body
              )}</p>
            </div>`
                : ""
            }
          </div>
          ${
            p.image_url
              ? `<div class="post-image-wrapper" data-caption="${encodeURIComponent(
                  p.body || ""
                )}">
                  <img src="${p.image_url}" 
                       class="post-image ${p.is_nsfw && !checkNSFWVerification() ? 'nsfw-blur' : ''}" 
                       alt="Artwork" 
                       style="cursor: zoom-in;">
                  ${p.is_nsfw && !checkNSFWVerification() ? `
                    <div class="nsfw-overlay">
                      <div class="text-center">
                        <i class="bi bi-exclamation-triangle" style="font-size: 2rem; margin-bottom: 0.5rem;"></i>
                        <div><strong>NSFW Content</strong></div>
                        <div class="small mb-3">This content may not be suitable for work</div>
                        <button class="btn btn-outline-light btn-sm" onclick="verifyAge(this)">
                          I am 18+ years old
                        </button>
                      </div>
                    </div>
                  ` : ''}
                </div>`
              : ""
          }
          ${
            Array.isArray(p.tags) && p.tags.length > 0
              ? `<div class="post-tags mt-2">
            ${p.tags
              .map(
                (tag) => {
                  const safeTag = tag.replace(/'/g, "\\'"); // Escape quotes for onclick
                  if (tag.toLowerCase() === 'nsfw') {
                    return `<button class="tag-chip me-1 mb-1" type="button" data-tag="${tag}" onclick="selectPostTag('${safeTag}', this)" style="font-size: 0.75rem; padding: 0.2rem 0.5rem; background: #3498db; border: 1px solid #3498db; border-radius: 1rem; color: white; cursor: pointer;">#${tag}</button>`;
                  }
                  return `<button class="tag-chip me-1 mb-1" type="button" data-tag="${tag}" onclick="selectPostTag('${safeTag}', this)" style="font-size: 0.75rem; padding: 0.2rem 0.5rem; background: #e9ecef; border: 1px solid #dee2e6; border-radius: 1rem; color: #495057; cursor: pointer;">#${tag}</button>`;
                }
              )
              .join("")}
          </div>`
              : ""
          }
          ${p.is_nsfw || (Array.isArray(p.tags) && p.tags.some(tag => tag.toLowerCase() === 'nsfw')) ? `
            <div class="nsfw-warning mt-2">
              <i class="bi bi-exclamation-triangle text-warning me-1"></i>
              <small class="text-warning"><strong>NSFW:</strong> This post contains content that may not be suitable for work</small>
            </div>
          ` : ''}
          <div class="context-panel">
            ${
              p.context
                ? `
              <div class="context-section">
                <div class="d-flex justify-content-between align-items-start mb-2">
                  <h6 class="mb-0">Community Context <small class="text-info">(${Math.round(
                    p.context.approval_rate || 0
                  )}% approval)</small></h6>
                  ${
                    isAdmin() && p.context.admin_approved !== true
                      ? `<button class="btn btn-sm btn-success admin-action-btn" onclick="quickApproveContext('${p.context.id}')" title="Quick Approve Context">
                          <i class="bi bi-check-lg"></i>
                        </button>`
                      : isAdmin() && p.context.admin_approved === true
                      ? `<span class="badge bg-success"><i class="bi bi-check-lg me-1"></i>Approved</span>`
                      : ""
                  }
                </div>
                <p class="mb-2">${escapeHtml(p.context.text || "")}</p>
                <div class="context-votes mt-2">
                  <button class="btn btn-sm btn-outline-success me-1" onclick="voteContext('${
                    p.context.id
                  }', 'up')" ${
                    auth.user &&
                    p.context.voters &&
                    p.context.voters.includes(auth.user.id)
                      ? "disabled"
                      : ""
                  }>
                    <i class="bi bi-hand-thumbs-up"></i> ${
                      p.context.upvotes || 0
                    }
                  </button>
                  <button class="btn btn-sm btn-outline-danger" onclick="voteContext('${
                    p.context.id
                  }', 'down')" ${
                    auth.user &&
                    p.context.voters &&
                    p.context.voters.includes(auth.user.id)
                      ? "disabled"
                      : ""
                  }>
                    <i class="bi bi-hand-thumbs-down"></i> ${
                      p.context.downvotes || 0
                    }
                  </button>
                  <small class="text-muted ms-2">${
                    p.context.admin_approved === true
                      ? '<span class="text-success">Admin Approved</span>'
                      : p.context.admin_approved === false
                      ? '<span class="text-danger">Admin Rejected</span>'
                      : (p.context.approval_rate || 0) >= 90
                      ? "Approved by community"
                      : "Needs 90% approval to show"
                  }</small>
                </div>
                ${
                  (p.context.approval_rate || 0) < 90
                    ? '<div class="alert alert-info mt-2 py-1 px-2 small">This context is being reviewed by the community. Vote to help decide if it should be displayed.</div>'
                    : ""
                }
              </div>
            `
                : ""
            }
          </div>
          ${
            p.context && (p.context.approval_rate || 0) >= 90
              ? '<div class="toggle-context mt-2">Hide context</div>'
              : !mine
              ? '<div class="open-context-editor mt-2 toggle-context">Add community context</div>'
              : ""
          }
        </div>
        <div class="post-footer">
          <button class="icon-btn like-btn ${likedClass}" type="button" data-post-id="${
          p.id
        }">
            <i class="bi bi-hand-thumbs-up"></i> 
            <span class="like-text">${p.user_liked ? "Liked" : "Like"}</span>
            ${
              (p.likes_count || 0) > 0
                ? `<span class="count-badge">${p.likes_count}</span>`
                : ""
            }
          </button>
          <button class="icon-btn comment-btn" type="button" data-post-id="${
            p.id
          }">
            <i class="bi bi-chat"></i> Comment
            ${
              (p.comments_count || 0) > 0
                ? `<span class="count-badge">${p.comments_count}</span>`
                : ""
            }
          </button>
          <button class="icon-btn quick-comment-btn" type="button" data-post-id="${p.id}" title="Quick comment">
            <i class="bi bi-plus-circle"></i>
          </button>
          <button class="icon-btn save-btn ${
            isSaved ? "text-warning" : ""
          }" type="button" data-post-id="${p.id}">
            <i class="bi ${isSaved ? "bi-bookmark-fill" : "bi-bookmark"}"></i> 
            <span class="save-text">${isSaved ? "Saved" : "Save"}</span>
            ${
              (p.saves_count || 0) > 0
                ? `<span class="count-badge">${p.saves_count}</span>`
                : ""
            }
          </button>
          <button class="icon-btn share-btn" type="button" data-post-id="${
            p.id
          }">
            <i class="bi bi-share"></i> Share
          </button>
        </div>
        
        <!-- Comment Preview Panel - Always visible below actions -->
        ${
          p.recent_comments && p.recent_comments.length > 0
            ? `<div class="comment-preview-panel mt-3 pt-3 border-top" style="border-top: 1px solid rgba(0,0,0,0.1);">
          ${p.recent_comments
            .slice(0, 3)
            .map(
              (comment) => `
            <div class="comment-preview-item mb-3 d-flex align-items-start gap-3">
              <img src="${comment.profile_picture || getDefaultAvatar()}" class="rounded-circle flex-shrink-0" width="32" height="32" alt="${escapeHtml(comment.username)}">
              <div class="flex-grow-1">
                <div class="mb-1">
                  <strong class="small">${escapeHtml(comment.username)}</strong>
                  ${
                    comment.is_admin || comment.username === "Kiyoshi"
                      ? `<span class="admin-badge ms-1">ADMIN</span>`
                      : ""
                  }
                  <span class="small text-muted ms-2">${formatTimeAgo(comment.created_at)}</span>
                </div>
                <div class="comment-text small mb-2">${escapeHtml(comment.text)}</div>
                <div class="comment-actions d-flex align-items-center gap-3">
                  <button class="like-comment-btn ${comment.user_liked ? 'liked' : ''}" data-comment-id="${comment.id}">
                    <i class="bi bi-heart${comment.user_liked ? '-fill' : ''} me-1"></i>
                    <span class="small">${comment.likes_count || 0}</span>
                  </button>
                  <button class="reply-comment-btn" data-comment-id="${comment.id}" data-username="${escapeHtml(comment.username)}">
                    <i class="bi bi-reply me-1"></i>
                    <span class="small">Reply</span>
                  </button>
                  ${(() => {
                    const userIsAdmin = auth.user && (auth.user.is_admin === true || auth.user.username === 'Kiyoshi' || auth.user.username === 'kiyoshi');
                    return userIsAdmin ? `
                      <button class="admin-delete-comment-btn" data-comment-id="${comment.id}" title="Delete Comment (Admin)">
                        <i class="bi bi-trash me-1"></i>
                        <span class="small">Delete</span>
                      </button>
                    ` : `
                      <button class="report-comment-btn" data-comment-id="${comment.id}" title="Report Comment">
                        <i class="bi bi-flag me-1"></i>
                        <span class="small">Report</span>
                      </button>
                    `;
                  })()}
                </div>
              </div>
            </div>
          `
            )
            .join("")}
          ${p.comments_count > 3 ? `
            <div class="mt-2">
              <button class="view-more-comments-btn text-muted" data-post-id="${p.id}">
                <small>View ${p.comments_count - 3} more comment${p.comments_count - 3 > 1 ? 's' : ''}...</small>
              </button>
            </div>
          ` : ''}
          
          <!-- Enhanced Quick Comment Input - Always visible -->
          <div class="quick-comment-input mt-3 pt-2" style="border-top: 1px solid rgba(0,0,0,0.05);" data-post-id="${p.id}">
            <div class="d-flex align-items-center gap-2">
              <img src="${(auth.user?.profile_picture) || getDefaultAvatar()}" class="rounded-circle flex-shrink-0 user-avatar-comment" width="28" height="28" alt="${escapeHtml(auth.user?.username || 'You')}">
              <div class="flex-grow-1 position-relative">
                <input type="text" class="form-control form-control-sm comment-input enhanced-comment-input" placeholder="Add a comment..." data-post-id="${p.id}" style="border-radius: 20px; border: 1px solid rgba(0,123,255,0.2); background: rgba(248,249,250,0.9); transition: all 0.3s ease;">
                <div class="comment-actions d-none position-absolute" style="right: 8px; top: 50%; transform: translateY(-50%);">
                  <button class="btn btn-sm btn-primary post-comment-btn" type="button" data-post-id="${p.id}" style="border-radius: 15px; padding: 2px 8px; font-size: 11px;">
                    <i class="bi bi-send"></i>
                  </button>
                </div>
              </div>
            </div>
            <div class="auth-prompt d-none text-center mt-2">
              <small class="text-muted">Please <a href="#" class="text-primary login-link">login</a> to comment</small>
            </div>
          </div>
        </div>`
            : ""
        }
        
        <!-- Community Context Panel -->
        ${p.context && p.context.approved ? `
          <div class="community-context-panel mt-3 p-3" style="background: rgba(220,53,69,0.05); border-left: 3px solid #3498db; border-radius: 0.5rem;">
            <div class="d-flex align-items-start justify-content-between mb-2">
              <div class="d-flex align-items-center gap-2">
                <i class="bi bi-info-circle-fill text-primary"></i>
                <strong class="small text-primary">Community Context</strong>
              </div>
              <div class="context-votes small text-muted">
                <i class="bi bi-arrow-up-circle"></i> ${p.context.upvotes || 0}
                <i class="bi bi-arrow-down-circle ms-1"></i> ${p.context.downvotes || 0}
                <span class="ms-1">(${p.context.approval_rate || 0}% approval)</span>
              </div>
            </div>
            <div class="context-text small mb-2">${escapeHtml(p.context.text)}</div>
            ${p.context.source_links ? `
              <div class="context-sources small">
                <strong>Sources:</strong>
                ${p.context.source_links.split(',').map(link => 
                  `<a href="#" class="external-link text-decoration-none" data-url="${escapeHtml(link.trim())}" 
                     onclick="confirmExternalLink(event, '${escapeHtml(link.trim())}')"> ${escapeHtml(link.trim())}</a>`
                ).join(' ')}
              </div>
            ` : ''}
            <div class="context-meta small text-muted mt-2">
              <i class="bi bi-person-circle"></i> Submitted by ${escapeHtml(p.context.submitted_by || 'Community')}
              ${p.context.created_at ? ` ${formatTimeAgo(p.context.created_at)}` : ''}
            </div>
          </div>
        ` : ''}`;
        const wrap = li.querySelector(".post-image-wrapper");
        if (wrap) {
          wrap.addEventListener("click", () =>
            openImageZoom(p.image_url, p.body)
          );
        }
        const toggle = li.querySelector(".toggle-context");
        if (toggle && p.context && (p.context.approval_rate || 0) >= 90) {
          const panel = li.querySelector(".context-panel");
          toggle.addEventListener("click", () => {
            const showing = panel.style.display === "block";
            panel.style.display = showing ? "none" : "block";
            toggle.textContent = showing ? "Show context" : "Hide context";
          });
        }
        // Initialize any dropdowns in the post card
        const dropdownToggle = li.querySelector('[data-bs-toggle="dropdown"]');
        if (dropdownToggle) {
          // Ensure Bootstrap dropdown is properly initialized
          setTimeout(() => {
            if (window.bootstrap && window.bootstrap.Dropdown) {
              new bootstrap.Dropdown(dropdownToggle);
            }
          }, 100);
        }

        return li;
      }

      // Image zoom functionality (Facebook-style)
      function openImageZoom(imageUrl, caption) {
        const modal = document.createElement("div");
        modal.className = "image-zoom-modal";
        modal.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.9);
        z-index: 9999;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: zoom-out;
      `;

        const container = document.createElement("div");
        container.style.cssText = `
        max-width: 90vw;
        max-height: 90vh;
        text-align: center;
        position: relative;
      `;

        const img = document.createElement("img");
        img.src = imageUrl;
        img.style.cssText = `
        max-width: 100%;
        max-height: 100%;
        object-fit: contain;
        border-radius: 8px;
        box-shadow: 0 4px 20px rgba(0,0,0,0.5);
      `;

        const closeBtn = document.createElement("button");
        closeBtn.innerHTML = '<i class="bi bi-x"></i>';
        closeBtn.style.cssText = `
        position: absolute;
        top: -40px;
        right: 0;
        background: rgba(255,255,255,0.2);
        border: none;
        color: white;
        font-size: 24px;
        width: 35px;
        height: 35px;
        border-radius: 50%;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
      `;

        if (caption) {
          const captionEl = document.createElement("div");
          captionEl.textContent = caption;
          captionEl.style.cssText = `
          color: white;
          margin-top: 15px;
          font-size: 14px;
          max-width: 500px;
          margin-left: auto;
          margin-right: auto;
        `;
          container.appendChild(captionEl);
        }

        container.appendChild(img);
        container.appendChild(closeBtn);
        modal.appendChild(container);
        document.body.appendChild(modal);

        // Close handlers
        const closeModal = () => {
          modal.style.opacity = "0";
          setTimeout(() => document.body.removeChild(modal), 200);
        };

        modal.addEventListener("click", (e) => {
          if (e.target === modal) closeModal();
        });
        closeBtn.addEventListener("click", closeModal);

        // Smooth fade in
        modal.style.opacity = "0";
        setTimeout(() => (modal.style.opacity = "1"), 10);
        modal.style.transition = "opacity 0.2s ease";
      }

      // Upload progress functionality
      function showUploadProgress() {
        const progressDiv = document.getElementById("uploadProgress");
        const progressBar = document.getElementById("uploadProgressBar");
        const percentage = document.getElementById("uploadPercentage");
        const status = document.getElementById("uploadStatus");

        progressDiv.style.display = "block";

        return {
          update: (percent, statusText) => {
            progressBar.style.width = percent + "%";
            percentage.textContent = percent;
            status.textContent = statusText;
          },
          hide: () => {
            progressDiv.style.display = "none";
            progressBar.style.width = "0%";
            percentage.textContent = "0";
            status.textContent = "Processing...";
          },
        };
      }

      async function loadFeed(fresh) {
        if (fresh) feedEl.innerHTML = "";

        // Show loading
        feedEl.innerHTML =
          '<div class="text-center py-5"><div class="loading-progress-container"><div class="loading-progress-bar"><div class="loading-progress-fill"></div></div><p class="mt-3 mb-1">Loading feed...</p><small class="text-muted loading-percentage">0%</small></div></div>';
      
      // Start the loading animation
      setTimeout(() => {
        const fillElement = document.querySelector('.loading-progress-fill');
        const percentageElement = document.querySelector('.loading-percentage');
        if (fillElement && percentageElement) {
          let progress = 0;
          const interval = setInterval(() => {
            progress += Math.random() * 15 + 5; // Random increment between 5-20%
            if (progress > 95) progress = 95; // Cap at 95% until actual loading completes
            
            fillElement.style.width = progress + '%';
            percentageElement.textContent = Math.round(progress) + '%';
            
            if (progress >= 95) {
              clearInterval(interval);
            }
          }, 200);
          
          // Store interval reference for cleanup
          window.feedLoadingInterval = interval;
        }
      }, 100);

        try {
          // Subscribe to real-time feed updates
          window.firebaseArtHubClient.subscribeToFeed((posts) => {
            // Complete loading animation
            const fillElement = document.querySelector('.loading-progress-fill');
            const percentageElement = document.querySelector('.loading-percentage');
            if (fillElement && percentageElement) {
              fillElement.style.width = '100%';
              percentageElement.textContent = '100%';
              
              // Clear any existing interval
              if (window.feedLoadingInterval) {
                clearInterval(window.feedLoadingInterval);
              }
            }
            
            feedEl.innerHTML = "";
            if (posts.length === 0) {
              feedEl.innerHTML =
                '<div class="text-center text-muted py-4">No posts yet. Be the first to share something!</div>';
              return;
            }
            
            posts.forEach((post, index) => {
              try {
                const postElement = postCard(post);
                feedEl.appendChild(postElement);
              } catch (error) {
                console.error(`Error rendering post ${post.id}:`, error);
                // Create a simple error card instead of crashing
                const errorCard = document.createElement('div');
                errorCard.className = 'post-card bg-danger text-white p-3 mb-3';
                errorCard.innerHTML = `<p>Error loading post by ${post.username || 'Unknown'}</p><small>Error: ${error.message}</small>`;
                feedEl.appendChild(errorCard);
              }
            });
          });
          updateStats();
        } catch (err) {
          feedEl.innerHTML =
            '<div class="text-danger small">Failed to load feed: ' +
            err.message +
            "</div>";
        }
      }

      publishBtn.addEventListener("click", async () => {
        if (!enforceAuthBefore()) return;
        const text = postText.value.trim();
        if (!text && !tempImageData) {
          toast("Please write something or add an image to publish");
          return;
        }

        // Check cooldown
        if (!checkCooldown()) {
          const remainingTime = Math.ceil(
            (POST_COOLDOWN - (Date.now() - lastPostTime)) / 1000
          );
          toast(
            `Please wait ${remainingTime} seconds before posting again`,
            "warning"
          );
          return;
        }

        // Track activity and check for security verification
        trackActivity();
        if (needsSecurityCheck()) {
          toast("Security check required due to high activity", "warning");
          const verified = await showRecaptcha();
          if (!verified) {
            toast("Security verification failed. Please try again.", "error");
            return;
          }
        }

        publishBtn.disabled = true;
        publishBtn.innerHTML =
          '<span class="spinner-border spinner-border-sm me-2"></span>Publishing...';

        try {
          // Parse tags from the tags input
          const tagsInputValue = document
            .getElementById("tagsInput")
            .value.trim();
          let tags = [];
          if (tagsInputValue) {
            tags = tagsInputValue
              .split(/\s+/)
              .map((tag) => tag.replace("#", "").trim())
              .filter((tag) => tag.length > 0);
          }
          
          // Check NSFW status
          const isNSFW = document.getElementById("nsfwCheck").checked;
          if (isNSFW && !tags.includes('nsfw')) {
            tags.push('nsfw');
          }

          await window.firebaseArtHubClient.createPost(
            text,
            tempImageData,
            null, // context
            tags,
            isNSFW
          );

          // Update last post time for cooldown
          lastPostTime = Date.now();

          // Clear form and reset UI
          postText.value = "";
          document.getElementById("tagsInput").value = "";
          document.getElementById("nsfwCheck").checked = false;
          tempImageData = null;
          imageInput.value = "";

          // Reset image preview area
          imagePreviewArea.style.display = "none";
          imageButtonText.textContent = "Add Image";
          imageHint.textContent = "PNG, JPG up to 5MB";

          toast("Post published successfully!");
          updateStats();
          loadFeed(); // Refresh feed to show new post
          
          // Refresh trending tags if the post had tags
          if (tags && tags.length > 0) {
            refreshTrendingTags();
          }
        } catch (err) {
          toast("Failed to publish: " + err.message);
        } finally {
          publishBtn.disabled = false;
          publishBtn.innerHTML = '<i class="bi bi-send me-1"></i> Publish';
        }
      });

      // Readers context add (delegated)
      document.addEventListener("click", (e) => {
        if (e.target.classList.contains("open-context-editor")) {
          if (!enforceAuthBefore()) return;
          const card = e.target.closest(".post-card");
          if (card.querySelector(".context-add-box")) return;
          const box = document.createElement("div");
          box.className = "context-add-box";
          box.innerHTML = `<textarea class="form-control form-control-sm context-input" rows="2" placeholder="Add community context..."></textarea><div class="text-end mt-2"><button type="button" class="btn btn-sm cancel-context-add me-2">Cancel</button><button type="button" class="btn btn-sm btn-brand submit-context-add">Submit for Review</button></div><div class="small text-muted mt-1">Context will be reviewed by the community and needs 90% approval to be displayed.</div>`;
          e.target.insertAdjacentElement("afterend", box);
        }
        if (e.target.classList.contains("cancel-context-add")) {
          e.target.closest(".context-add-box")?.remove();
        }
        if (e.target.classList.contains("submit-context-add")) {
          (async () => {
            if (!enforceAuthBefore()) return;
            const card = e.target.closest(".post-card");
            const val = card.querySelector(".context-input").value.trim();
            if (!val) return;
            try {
              const id = card.dataset.postId;
              console.log("Post ID from dataset:", id, "Type:", typeof id);
              
              if (!id || id === 'undefined') {
                throw new Error('Post ID not found. Please refresh the page and try again.');
              }
              
              // Convert to string for Firebase (Firebase uses string IDs)
              const postId = String(id);
              console.log("Submitting context for post:", postId);
              
              const ctx = await window.firebaseArtHubClient.addContext(
                postId,
                val
              );
              const body = card.querySelector(".post-body");
              card.querySelector(".context-add-box")?.remove();
              body.querySelector(".open-context-editor")?.remove();

              // Add pending context indicator
              const pendingIndicator = document.createElement("div");
              pendingIndicator.className =
                "alert alert-info mt-2 py-2 px-3 small";
              pendingIndicator.innerHTML = `<i class="bi bi-clock me-1"></i>Your context has been submitted and is awaiting community review (needs 90% approval).`;
              body.appendChild(pendingIndicator);

              toast("Context submitted for community review!");
            } catch (err) {
              toast(err.message);
            }
          })();
        }
      });

      // Suggestions (users)
      const suggestedList = document.getElementById("suggestedList");
      async function loadSuggestions() {
        const suggestedList = document.getElementById("suggestedList");
        if (!suggestedList) return;

        try {
          // Get suggested artists with their stats
          const suggestedArtists =
            await window.firebaseArtHubClient.getSuggestedArtists();

          if (suggestedArtists.length === 0) {
            suggestedList.innerHTML =
              '<div class="text-muted small text-center">No suggestions available</div>';
            return;
          }

          let html = "";
          for (const artist of suggestedArtists) {
            const isFollowing =
              await window.firebaseArtHubClient.getFollowStatus(artist.id);
            html += `
            <li class="suggestion-item d-flex align-items-center justify-content-between mb-3">
              <div class="d-flex align-items-center" style="min-width: 0; flex: 1;">
                <img src="${
                  artist.avatar || artist.profile_picture || getDefaultAvatar()
                }" alt="${
              artist.username
            }" class="rounded-circle me-2" style="width: 40px; height: 40px; object-fit: cover;">
                <div style="min-width: 0; flex: 1;">
                  <div class="fw-bold small text-truncate">${
                    artist.username
                  }</div>
                  <div class="text-muted text-truncate" style="font-size: 0.7rem;">
                    <i class="bi bi-people me-1"></i>${
                      artist.followersCount || 0
                    } followers
                    <span class="mx-1"></span>
                    <i class="bi bi-heart me-1"></i>${
                      artist.totalLikes || 0
                    } likes
                  </div>
                </div>
              </div>
              <button class="btn btn-sm ${
                isFollowing ? "btn-outline-secondary" : "btn-primary"
              } follow-btn" 
                      data-user-id="${artist.id}" 
                      style="font-size: 0.7rem; padding: 0.25rem 0.5rem;">
                ${isFollowing ? "Following" : "Follow"}
              </button>
            </li>
          `;
          }

          suggestedList.innerHTML = html;
        } catch (error) {
          console.error("Error loading suggestions:", error);
          suggestedList.innerHTML =
            '<div class="text-muted small text-center">Error loading suggestions</div>';
        }
      }

      // Follow/unfollow delegation
      document.addEventListener("click", async (e) => {
        if (e.target.classList.contains("follow-btn")) {
          if (!enforceAuthBefore()) return;
          const btn = e.target;
          const id = btn.getAttribute("data-user-id");
          if (!id) return;

          btn.disabled = true;
          const originalText = btn.textContent.trim();
          btn.innerHTML =
            '<span class="spinner-border spinner-border-sm"></span>';

          try {
            const following = originalText === "Following";

            if (following) {
              await window.firebaseArtHubClient.unfollowUser(id);
              btn.textContent = "Follow";
              btn.classList.remove("btn-outline-secondary");
              btn.classList.add("btn-primary");
              
              // Update follower count immediately
              const followerCountEl = btn.closest('.suggestion-item').querySelector('.text-muted');
              if (followerCountEl) {
                const text = followerCountEl.textContent;
                const match = text.match(/(\d+)\s+followers/);
                if (match) {
                  const newCount = Math.max(0, parseInt(match[1]) - 1);
                  followerCountEl.innerHTML = text.replace(match[0], `${newCount} followers`);
                }
              }
              
              toast("Unfollowed");
            } else {
              await window.firebaseArtHubClient.followUser(id);
              btn.textContent = "Following";
              btn.classList.remove("btn-primary");
              btn.classList.add("btn-outline-secondary");
              
              // Update follower count immediately
              const followerCountEl = btn.closest('.suggestion-item').querySelector('.text-muted');
              if (followerCountEl) {
                const text = followerCountEl.textContent;
                const match = text.match(/(\d+)\s+followers/);
                if (match) {
                  const newCount = parseInt(match[1]) + 1;
                  followerCountEl.innerHTML = text.replace(match[0], `${newCount} followers`);
                }
              }
              
              toast("Now following");
            }

            updateStats();
            // Don't reload entire suggestions, just update counts live
          } catch (err) {
            console.error("Follow error:", err);
            btn.textContent = originalText; // Restore original text
            toast("Error: " + err.message);
          } finally {
            btn.disabled = false;
          }
        }
      });

      // Search and Filter functionality
      const userSearchInput = document.getElementById("userSearchInput");
      const searchUsersBtn = document.getElementById("searchUsersBtn");
      const searchResults = document.getElementById("searchResults");
      const tagFilterInput = document.getElementById("tagFilterInput");
      const filterByTagBtn = document.getElementById("filterByTagBtn");
      const popularTags = document.getElementById("popularTags");
      const clearFiltersBtn = document.getElementById("clearFiltersBtn");
      const addTagsBtn = document.getElementById("addTagsBtn");

      let currentTagFilter = null;

      // User search functionality
      async function searchUsers(query) {
        if (!query.trim()) {
          searchResults.style.display = "none";
          return;
        }

        try {
          searchResults.innerHTML =
            '<div class="text-center py-2"><div class="spinner-border spinner-border-sm" role="status"></div></div>';
          searchResults.style.display = "block";

          const users = await window.firebaseArtHubClient.searchUsers(query);

          if (users.length === 0) {
            searchResults.innerHTML =
              '<div class="text-muted small py-2">No users found</div>';
            return;
          }

          let html = "";
          for (const user of users) {
            const isFollowing =
              await window.firebaseArtHubClient.getFollowStatus(user.id);
            html += `
            <div class="search-result-item d-flex align-items-center justify-content-between py-2 border-bottom">
              <div class="d-flex align-items-center">
                <img src="${
                  user.avatar || "https://placehold.co/32x32"
                }" alt="${
              user.displayName
            }" class="rounded-circle me-2" style="width: 32px; height: 32px; object-fit: cover;">
                <div>
                  <div class="fw-bold small">${user.displayName}</div>
                  <div class="text-muted" style="font-size: 0.7rem;">${
                    user.email
                  }</div>
                </div>
              </div>
              <button class="btn btn-sm ${
                isFollowing ? "btn-outline-secondary" : "btn-primary"
              } follow-btn" 
                      data-user-id="${user.id}" 
                      style="font-size: 0.7rem; padding: 0.2rem 0.4rem;">
                ${isFollowing ? "Following" : "Follow"}
              </button>
            </div>
          `;
          }

          searchResults.innerHTML = html;
        } catch (error) {
          console.error("Error searching users:", error);
          searchResults.innerHTML =
            '<div class="text-danger small py-2">Error searching users</div>';
        }
      }

      // Tag filtering functionality
      async function filterPostsByTag(tag) {
        if (!tag) return;

        currentTagFilter = tag;

        try {
          feedEl.innerHTML =
            '<div class="text-center py-4"><div class="spinner-border text-primary" role="status"></div><p class="mt-2">Loading tagged posts...</p></div>';

          const posts = await window.firebaseArtHubClient.getPostsByTag(tag);

          feedEl.innerHTML = "";
          if (posts.length === 0) {
            feedEl.innerHTML = `<div class="text-center text-muted py-4">No posts found with tag #${tag}</div>`;
          } else {
            posts.forEach((post) => feedEl.appendChild(postCard(post)));
          }

          // Update UI to show filter is active
          document.querySelectorAll("#popularTags .btn").forEach((btn) => {
            btn.classList.remove("btn-primary");
            btn.classList.add("btn-outline-primary");
          });

          const activeBtn = document.querySelector(`[data-tag="${tag}"]`);
          if (activeBtn) {
            activeBtn.classList.remove("btn-outline-primary");
            activeBtn.classList.add("btn-primary");
          }

          toast(`Showing posts tagged with #${tag}`);
        } catch (error) {
          console.error("Error filtering by tag:", error);
          feedEl.innerHTML =
            '<div class="text-danger small text-center py-4">Error filtering posts</div>';
          toast("Error filtering posts");
        }
      }

      // Clear filters
      function clearFilters() {
        currentTagFilter = null;
        tagFilterInput.value = "";

        // Reset tag buttons
        document.querySelectorAll("#popularTags .btn").forEach((btn) => {
          btn.classList.remove("btn-primary");
          btn.classList.add("btn-outline-primary");
        });

        // Reload all posts
        loadFeed();
        toast("Filters cleared");
      }

      // Event listeners
      searchUsersBtn.addEventListener("click", () => {
        const query = userSearchInput.value.trim();
        searchUsers(query);
      });

      userSearchInput.addEventListener("keypress", (e) => {
        if (e.key === "Enter") {
          const query = userSearchInput.value.trim();
          searchUsers(query);
        }
      });

      // Clear search results when input is cleared
      userSearchInput.addEventListener("input", (e) => {
        if (!e.target.value.trim()) {
          searchResults.style.display = "none";
        }
      });

      filterByTagBtn.addEventListener("click", () => {
        const tag = tagFilterInput.value.trim().replace("#", "");
        if (tag) {
          filterPostsByTag(tag);
        }
      });

      tagFilterInput.addEventListener("keypress", (e) => {
        if (e.key === "Enter") {
          const tag = tagFilterInput.value.trim().replace("#", "");
          if (tag) {
            filterPostsByTag(tag);
          }
        }
      });

      // Popular tags click handlers
      popularTags.addEventListener("click", (e) => {
        if (e.target.hasAttribute("data-tag")) {
          const tag = e.target.getAttribute("data-tag");
          filterPostsByTag(tag);
        }
      });



      // Alias dropdown functionality
      const aliasDropdownBtn = document.getElementById("aliasDropdownBtn");
      if (aliasDropdownBtn) {
        aliasDropdownBtn.addEventListener("click", function (e) {
          e.preventDefault();
          const aliasList = document.getElementById("aliasList");
          aliasList.style.display =
            aliasList.style.display === "block" ? "none" : "block";
        });
      }

      // Clear alias history
      const clearAliasBtn = document.getElementById("clearAliasBtn");
      if (clearAliasBtn) {
        clearAliasBtn.addEventListener("click", async function (e) {
          e.preventDefault();
          if (
            confirm("Are you sure you want to clear your username history?")
          ) {
            try {
              await artHubClient.clearAliasHistory(auth.user.id);
              updateAliasDisplay([]);
              toast("Alias history cleared", "success");
            } catch (error) {
              console.error("Error clearing alias history:", error);
              toast("Failed to clear alias history", "error");
            }
          }
        });
      }

      // Username change with cooldown check
      const settingsUsername = document.getElementById("settingsUsername");
      if (settingsUsername) {
        settingsUsername.addEventListener("blur", function () {
          checkUsernameCooldown();
        });
      }

      // Save settings button
      const saveSettingsBtn = document.getElementById("saveSettings");
      if (saveSettingsBtn) {
        saveSettingsBtn.addEventListener("click", saveSettings);
      }

      // Close alias dropdown when clicking outside
      document.addEventListener("click", function (e) {
        const aliasList = document.getElementById("aliasList");
        const aliasDropdownBtn = document.getElementById("aliasDropdownBtn");
        if (
          aliasList &&
          aliasDropdownBtn &&
          !aliasDropdownBtn.contains(e.target) &&
          !aliasList.contains(e.target)
        ) {
          aliasList.style.display = "none";
        }
      });

      // Tags input is always visible, no button needed

      // Tag chip click delegation (for tags in posts)
      document.addEventListener("click", (e) => {
        if (e.target.classList.contains("tag-chip")) {
          const tag = e.target.getAttribute("data-tag");
          if (tag) {
            filterPostsByTag(tag);
          }
        }

        // Edit post functionality
        if (e.target.classList.contains("edit-post-btn")) {
          e.preventDefault();
          const postId = e.target.getAttribute("data-post-id");
          openEditModal(postId);
        }

        // Report post functionality
        if (e.target.classList.contains("report-post-btn")) {
          e.preventDefault();
          const postId = e.target.getAttribute("data-post-id");
          const postAuthor = e.target.getAttribute("data-post-author");
          openReportModal(postId, postAuthor);
        }

        // Admin actions
        if (e.target.classList.contains("delete-post-btn")) {
          e.preventDefault();
          const postId = e.target.getAttribute("data-post-id");
          const reportId = e.target.getAttribute("data-report-id");
          confirmDeletePost(postId, reportId);
        }

        // Comment interactions
        if (e.target.classList.contains("like-comment-btn")) {
          e.preventDefault();
          const commentId = e.target.getAttribute("data-comment-id");
          toggleCommentLike(commentId, e.target);
        }
        
        if (e.target.classList.contains("reply-comment-btn")) {
          e.preventDefault();
          const commentId = e.target.getAttribute("data-comment-id");
          const username = e.target.getAttribute("data-username");
          showReplyInput(commentId, username, e.target);
        }
        
        if (e.target.classList.contains("quick-comment-btn")) {
          e.preventDefault();
          const postId = e.target.getAttribute("data-post-id");
          toggleQuickComment(postId, e.target);
        }
        
        if (e.target.classList.contains("post-comment-inline-btn")) {
          e.preventDefault();
          const input = e.target.closest('.input-group').querySelector('.comment-input');
          const postId = input.getAttribute('data-post-id');
          postQuickComment(postId, input);
        }
        
        if (e.target.classList.contains("view-all-comments-btn") || e.target.classList.contains("view-more-comments-btn")) {
          e.preventDefault();
          const postId = e.target.getAttribute("data-post-id");
          openCommentsModal(postId);
        }
        
        // Admin delete comment
        if (e.target.classList.contains("admin-delete-comment-btn") || e.target.closest(".admin-delete-comment-btn")) {
          e.preventDefault();
          e.stopPropagation();
          
          const deleteBtn = e.target.classList.contains("admin-delete-comment-btn") ? e.target : e.target.closest(".admin-delete-comment-btn");
          const commentId = deleteBtn.getAttribute("data-comment-id");
          
          if (!commentId) {
            toast('Comment ID not found', 'error');
            return;
          }
          
          if (!isAdmin()) {
            toast('Admin access required to delete comments', 'error');
            return;
          }
          
          if (confirm("Are you sure you want to delete this comment? This action cannot be undone.")) {
            deleteComment(commentId);
          }
        }
        
        // User report comment
        if (e.target.classList.contains("report-comment-btn")) {
          e.preventDefault();
          const commentId = e.target.getAttribute("data-comment-id");
          showReportCommentModal(commentId);
        }

        // Admin context review actions
        if (e.target.classList.contains("approve-context-btn")) {
          e.preventDefault();
          const contextId = e.target.getAttribute("data-context-id");
          approveContext(contextId);
        }

        if (e.target.classList.contains("reject-context-btn")) {
          e.preventDefault();
          const contextId = e.target.getAttribute("data-context-id");
          rejectContext(contextId);
        }

        if (e.target.classList.contains("view-post-btn")) {
          e.preventDefault();
          const postId = e.target.getAttribute("data-post-id");
          // Scroll to post in feed or open in modal
          showSection("feed");
          setTimeout(() => {
            const postElement = document.querySelector(
              `[data-post-id="${postId}"]`
            );
            if (postElement) {
              postElement.scrollIntoView({
                behavior: "smooth",
                block: "center",
              });
              postElement.style.border = "2px solid #667eea";
              setTimeout(() => {
                postElement.style.border = "";
              }, 3000);
            }
          }, 500);
        }

        if (e.target.classList.contains("dismiss-report-btn")) {
          e.preventDefault();
          const reportId = e.target.getAttribute("data-report-id");
          dismissReport(reportId);
        }

        if (e.target.classList.contains("ban-user-btn")) {
          e.preventDefault();
          const userId = e.target.getAttribute("data-user-id");
          confirmBanUser(userId);
        }

        if (e.target.classList.contains("unban-user-btn")) {
          e.preventDefault();
          const userId = e.target.getAttribute("data-user-id");
          unbanUser(userId);
        }

        // Show/hide original content when clicking (edited) indicator
        if (e.target.classList.contains("edit-indicator")) {
          const postId = e.target.getAttribute("data-post-id");
          const postCard = document.querySelector(
            `.post-card[data-post-id="${postId}"]`
          );
          const originalContent = postCard.querySelector(".original-content");
          if (originalContent) {
            const isShowing = originalContent.style.display === "block";
            originalContent.style.display = isShowing ? "none" : "block";
            e.target.textContent = isShowing ? "(edited)" : "(hide original)";
          }
        }
      });

      // Edit post modal functionality
      function openEditModal(postId) {
        const postCard = document.querySelector(
          `.post-card[data-post-id="${postId}"]`
        );
        if (!postCard) return;

        const currentText =
          postCard.querySelector(".post-content p").textContent;

        // Get current tags
        const tagElements = postCard.querySelectorAll(".tag-chip");
        const currentTags = Array.from(tagElements)
          .map((tag) => tag.getAttribute("data-tag"))
          .join(" ");

        const modal = document.createElement("div");
        modal.className = "modal fade";
        modal.innerHTML = `
        <div class="modal-dialog modal-dialog-centered">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title">Edit Post</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
              <div class="mb-3">
                <label for="editPostText" class="form-label">Post Content</label>
                <textarea class="form-control" rows="4" placeholder="What's on your mind?" id="editPostText">${currentText}</textarea>
              </div>
              <div class="mb-3">
                <label for="editTagsInput" class="form-label">Tags</label>
                <input type="text" id="editTagsInput" class="form-control" placeholder="Add tags (e.g., #art #digital #painting)" value="${currentTags}">
                <div class="small text-muted mt-1">
                  <i class="bi bi-hash me-1"></i>Separate tags with spaces. Tags help others discover your work!
                </div>
              </div>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
              <button type="button" class="btn btn-primary" id="savePostEdit">Save Changes</button>
            </div>
          </div>
        </div>
      `;

        document.body.appendChild(modal);
        const modalInstance = new bootstrap.Modal(modal);
        modalInstance.show();

        // Save edit handler
        modal
          .querySelector("#savePostEdit")
          .addEventListener("click", async () => {
            const newText = modal.querySelector("#editPostText").value.trim();
            if (!newText) {
              toast("Post content cannot be empty");
              return;
            }

            // Parse tags from the tags input
            const tagsInputValue = modal
              .querySelector("#editTagsInput")
              .value.trim();
            let tags = [];
            if (tagsInputValue) {
              tags = tagsInputValue
                .split(/\s+/)
                .map((tag) => tag.replace("#", "").trim())
                .filter((tag) => tag.length > 0);
            }

            try {
              await window.firebaseArtHubClient.editPost(postId, newText, tags);
              modalInstance.hide();
              loadFeed(true); // Refresh feed to show edited post
              toast("Post updated successfully!");
            } catch (error) {
              toast("Failed to update post: " + error.message);
            }
          });

        // Clean up modal when closed
        modal.addEventListener("hidden.bs.modal", () => {
          document.body.removeChild(modal);
        });
      }

      // Report modal functionality
      function openReportModal(postId, postAuthor) {
        if (!enforceAuthBefore()) return;

        const reportModal = new bootstrap.Modal(
          document.getElementById("reportModal")
        );
        reportModal.show();

        // Store post info for submission
        document.getElementById("reportModal").dataset.postId = postId;
        document.getElementById("reportModal").dataset.postAuthor = postAuthor;

        // Reset form
        document.getElementById("reportReason").value = "";
        document.getElementById("reportDetails").value = "";
      }

      // Submit report handler
      document
        .getElementById("submitReport")
        .addEventListener("click", async () => {
          const modal = document.getElementById("reportModal");
          const postId = modal.dataset.postId;
          const postAuthor = modal.dataset.postAuthor;
          const reason = document.getElementById("reportReason").value;
          const details = document.getElementById("reportDetails").value.trim();

          if (!reason) {
            toast("Please select a reason for reporting", "error");
            return;
          }

          try {
            await window.firebaseArtHubClient.reportPost(
              postId,
              postAuthor,
              reason,
              details
            );
            bootstrap.Modal.getInstance(modal).hide();
            toast(
              "Report submitted successfully. Thank you for helping keep our community safe.",
              "success"
            );
          } catch (error) {
            toast("Failed to submit report: " + error.message, "error");
          }
        });

      // Admin functions
      async function confirmDeletePost(postId, reportId) {
        if (
          !confirm(
            "Are you sure you want to delete this post? This action cannot be undone."
          )
        )
          return;

        try {
          await window.firebaseArtHubClient.deletePost(postId);
          if (reportId) {
            await window.firebaseArtHubClient.dismissReport(reportId);
          }
          toast("Post deleted successfully", "success");
          loadReports(); // Refresh reports
          loadFeed(true); // Refresh feed
        } catch (error) {
          toast("Failed to delete post: " + error.message, "error");
        }
      }

      async function dismissReport(reportId) {
        try {
          await window.firebaseArtHubClient.dismissReport(reportId);
          toast("Report dismissed", "success");
          loadReports(); // Refresh reports
        } catch (error) {
          toast("Failed to dismiss report: " + error.message, "error");
        }
      }

      async function confirmBanUser(userId) {
        if (
          !confirm(
            "Are you sure you want to ban this user? They will no longer be able to post or comment."
          )
        )
          return;

        try {
          await window.firebaseArtHubClient.banUser(userId);
          toast("User banned successfully", "success");
          setupUserSearch(); // Refresh user list
        } catch (error) {
          toast("Failed to ban user: " + error.message, "error");
        }
      }

      async function unbanUser(userId) {
        try {
          await window.firebaseArtHubClient.unbanUser(userId);
          toast("User unbanned successfully", "success");
          setupUserSearch(); // Refresh user list
        } catch (error) {
          toast("Failed to unban user: " + error.message, "error");
        }
      }

      // Admin context review functions
      async function approveContext(contextId) {
        if (
          !confirm(
            "Are you sure you want to approve this context? It will be immediately visible on the post."
          )
        )
          return;

        try {
          await window.firebaseArtHubClient.adminApproveContext(contextId);
          toast("Context approved successfully", "success");
          loadContextReviews(); // Refresh context reviews
          loadFeed(true); // Refresh feed to show approved context
        } catch (error) {
          toast("Failed to approve context: " + error.message, "error");
        }
      }

      async function rejectContext(contextId) {
        if (
          !confirm(
            "Are you sure you want to reject this context? This action cannot be undone."
          )
        )
          return;

        try {
          await window.firebaseArtHubClient.adminRejectContext(contextId);
          toast("Context rejected successfully", "success");
          loadContextReviews(); // Refresh context reviews
        } catch (error) {
          toast("Failed to reject context: " + error.message, "error");
        }
      }

      // Stats
      async function updateStats() {
        if (!auth.user) {
          document.getElementById("statPosts").textContent = "0";
          document.getElementById("statFollowers").textContent = "0";
          document.getElementById("statFollowing").textContent = "0";
          return;
        }
        try {
          // Get posts count for current user
          const posts = await window.firebaseArtHubClient.getPosts();
          const userPosts = posts.filter((p) => p.user_id === auth.user?.id);
          document.getElementById("statPosts").textContent = userPosts.length;

          // Get follower counts from user profile
          const user = window.firebaseArtHubClient.getCurrentUser();
          if (user) {
            document.getElementById("statFollowers").textContent =
              user.followers ? user.followers.length : "0";
            document.getElementById("statFollowing").textContent =
              user.following ? user.following.length : "0";
          }

          // Update profile avatars
          const profileAvatar = document.getElementById("profileAvatar");
          const createPostAvatar = document.getElementById("createPostAvatar");
          if (auth.user?.profile_picture) {
            if (profileAvatar) profileAvatar.src = auth.user.profile_picture;
            if (createPostAvatar)
              createPostAvatar.src = auth.user.profile_picture;
          }
        } catch (err) {
          console.error("Failed to update stats:", err);
        }
      }

      // --- New Functionality: Notifications, Settings, Like/Comment/Share ---

      // Notifications
      let notificationCount = 0;
      const notificationBadge = document.querySelector(
        '[data-hub-nav="notifications"] .badge'
      );

      async function loadNotifications() {
        if (!auth.user) return;
        try {
          const notifications =
            await window.firebaseArtHubClient.getNotifications();

          notificationCount = notifications.filter((n) => !n.read).length;
          updateNotificationBadge();
          displayNotifications(notifications);
        } catch (err) {
          console.error("Failed to load notifications:", err);
        }
      }

      function updateNotificationBadge() {
        if (notificationBadge) {
          if (notificationCount > 0) {
            notificationBadge.textContent = notificationCount;
            notificationBadge.style.display = "inline";
          } else {
            notificationBadge.style.display = "none";
          }
        }
      }

      function displayNotifications(notifications) {
        const dropdownContent = document.getElementById(
          "notificationsDropdownContent"
        );
        if (notifications.length === 0) {
          dropdownContent.innerHTML = `
          <div class="dropdown-item-text text-muted text-center py-3">
            <i class="bi bi-bell me-2"></i>No notifications yet
          </div>`;
          return;
        }

        dropdownContent.innerHTML = notifications
          .map(
            (n) => `
        <div class="dropdown-item ${
          !n.read_status ? "bg-light" : ""
        }" data-id="${n.id}">
          <div class="d-flex align-items-start">
            <div class="me-2">
              <i class="bi ${
                n.type === "like"
                  ? "bi-heart-fill text-danger"
                  : "bi-chat-fill text-primary"
              } "></i>
            </div>
            <div class="flex-grow-1">
              <div class="fw-bold" style="font-size: 0.9rem;">${escapeHtml(
                n.title || n.message
              )}</div>
              <div style="font-size: 0.85rem;">${escapeHtml(n.message)}</div>
              <div class="d-flex justify-content-between align-items-center mt-1">
                <small class="text-muted">${new Date(
                  n.created_at
                ).toLocaleString()}</small>
                ${
                  n.post_id
                    ? `<button class="btn btn-sm btn-outline-primary" onclick="viewNotificationPost('${n.post_id}')">View Post</button>`
                    : ""
                }
              </div>
            </div>
            ${
              !n.read_status
                ? '<span class="badge bg-primary ms-2">New</span>'
                : ""
            }
          </div>
        </div>
      `
          )
          .join("");
      }

      async function markAllNotificationsRead() {
        try {
          await window.firebaseArtHubClient.markAllNotificationsRead();
          notificationCount = 0;
          updateNotificationBadge();
          loadNotifications(); // Refresh the dropdown
          toast("All notifications marked as read");
        } catch (err) {
          console.error("Failed to mark notifications as read:", err);
          toast("Failed to mark notifications as read");
        }
      }

      // Settings Modal
      let settingsModal, notificationsPanel, commentsModal;
      let pendingProfilePicture = null;
      let currentPostId = null;

      async function loadSettings() {
        if (!auth.user) {
          toast("Please login to access settings");
          return;
        }

        try {
          const user = window.firebaseArtHubClient.getCurrentUser();
          if (!user) {
            toast("User not found");
            return;
          }

          // Populate settings form with user data
          const usernameField = document.getElementById("settingsUsername");
          const emailField = document.getElementById("settingsEmail");
          const profilePic = document.getElementById("settingsProfilePic");

          if (usernameField) usernameField.value = user.username || "";
          if (emailField) emailField.value = user.email || "";
          if (profilePic) {
            profilePic.src =
              user.profile_picture || "https://placehold.co/80x80?text=Avatar";
          }

          // Load current avatar for avatar uploader
          const avatarImg = document.getElementById("currentAvatar");
          if (avatarImg) {
            avatarImg.src =
              user.profile_picture || "https://placehold.co/80x80?text=Avatar";
          }

          // Set default privacy and notification settings if elements exist
          const privacyField = document.getElementById("settingPrivacy");
          const notificationsField = document.getElementById(
            "settingNotifications"
          );
          const autoplayField = document.getElementById("settingAutoplay");

          if (privacyField) privacyField.value = user.privacy || "public";
          if (notificationsField)
            notificationsField.checked = user.notifications !== false;
          if (autoplayField) autoplayField.checked = user.autoplay === true;
        } catch (err) {
          console.error("Failed to load settings:", err);
          toast("Failed to load settings: " + err.message);
        }
      }

      async function loadComments(postId) {
        currentPostId = postId;
        const commentsList = document.getElementById("commentsList");

        try {
          commentsList.innerHTML =
            '<div class="text-center py-3"><div class="spinner-border spinner-border-sm"></div> Loading comments...</div>';

          const comments = await window.firebaseArtHubClient.getComments(
            postId
          );

          if (comments.length === 0) {
            commentsList.innerHTML =
              '<div class="text-center text-muted py-3"><i class="bi bi-chat-dots me-2"></i>No comments yet. Be the first to comment!</div>';
          } else {
            commentsList.innerHTML = comments
              .map(
                (comment) => `
            <div class="d-flex gap-3 mb-3 pb-3 border-bottom">
              <img src="${
                comment.profile_picture || "https://placehold.co/40x40"
              }" alt="${
                  comment.username
                }" class="avatar" style="width:40px;height:40px;">
              <div class="flex-grow-1">
                <div class="d-flex align-items-center gap-2 mb-1">
                  <strong class="small">${comment.username}</strong>
                  ${
                    comment.is_admin || comment.username === "Kiyoshi"
                      ? `<span class="admin-badge ms-1">ADMIN</span>`
                      : ""
                  }
                  <small class="text-muted">${formatTimeAgo(
                    comment.created_at
                  )}</small>
                </div>
                <p class="mb-0 small">${escapeHtml(comment.text)}</p>
              </div>
            </div>
          `
              )
              .join("");
          }

          commentsModal.show();
        } catch (err) {
          commentsList.innerHTML =
            '<div class="text-danger text-center py-3">Failed to load comments</div>';
          toast("Failed to load comments: " + err.message);
        }
      }

      async function handleLike(postId, btn) {
        if (!enforceAuthBefore()) return;

        const icon = btn.querySelector("i");
        const countEl = btn.querySelector(".like-count");
        const originalClass = icon.className;
        const originalText = btn.classList.contains("text-danger");

        // Prevent multiple rapid clicks
        if (btn.dataset.processing === 'true') return;
        btn.dataset.processing = 'true';

        // Optimistic UI update
        const wasLiked = btn.classList.contains("text-danger");
        const currentCount = parseInt(countEl?.textContent || '0');
        
        if (wasLiked) {
          icon.className = "bi bi-heart";
          btn.classList.remove("text-danger");
          if (countEl) countEl.textContent = Math.max(0, currentCount - 1);
        } else {
          icon.className = "bi bi-heart-fill";
          btn.classList.add("text-danger");
          if (countEl) countEl.textContent = currentCount + 1;
        }

        try {
          const result = await window.firebaseArtHubClient.likePost(postId);

          // Update UI based on server response
          if (result.liked) {
            icon.className = "bi bi-heart-fill";
            btn.classList.add("text-danger");
          } else {
            icon.className = "bi bi-heart";
            btn.classList.remove("text-danger");
          }

          if (countEl) countEl.textContent = result.count || 0;
          
          // Sync like counters across all instances of this post
          const allLikeBtns = document.querySelectorAll(`[data-post-id="${postId}"].like-btn`);
          allLikeBtns.forEach(otherBtn => {
            if (otherBtn !== btn) {
              const otherIcon = otherBtn.querySelector('i');
              const otherCountEl = otherBtn.querySelector('.like-count');
              
              if (result.liked) {
                otherIcon.className = 'bi bi-heart-fill';
                otherBtn.classList.add('text-danger');
              } else {
                otherIcon.className = 'bi bi-heart';
                otherBtn.classList.remove('text-danger');
              }
              
              if (otherCountEl) otherCountEl.textContent = result.count || 0;
            }
          });
          
          updateNotificationBadge();
          
        } catch (err) {
          // Revert optimistic update on error
          icon.className = originalClass;
          if (originalText) {
            btn.classList.add("text-danger");
          } else {
            btn.classList.remove("text-danger");
          }
          if (countEl) countEl.textContent = currentCount;
          toast("Failed to like post: " + err.message, 'error');
        } finally {
          btn.dataset.processing = 'false';
        }
      }

      async function handleSave(postId, btn) {
        if (!enforceAuthBefore()) return;

        const icon = btn.querySelector("i");
        const saveText = btn.querySelector(".save-text");
        const originalClass = icon.className;
        const originalText = saveText.textContent;

        btn.disabled = true;

        try {
          // Use Firebase for saving but with localStorage fallback for UI
          let result;
          try {
            result = await window.firebaseArtHubClient.savePost(postId);
          } catch (firebaseErr) {
            console.warn(
              "Firebase save failed, using localStorage fallback:",
              firebaseErr
            );
            // Fallback to localStorage
            const savedPosts = JSON.parse(
              localStorage.getItem("saved_posts") || "[]"
            );
            const isCurrentlySaved = savedPosts.includes(postId);

            if (isCurrentlySaved) {
              const updatedSaved = savedPosts.filter((id) => id !== postId);
              localStorage.setItem("saved_posts", JSON.stringify(updatedSaved));
              result = { saved: false };
            } else {
              savedPosts.push(postId);
              localStorage.setItem("saved_posts", JSON.stringify(savedPosts));
              result = { saved: true };
            }
          }

          // Update all save buttons for this post across the page
          const allSaveBtns = document.querySelectorAll(`[data-post-id="${postId}"].save-btn`);
          allSaveBtns.forEach(saveBtn => {
            const btnIcon = saveBtn.querySelector('i');
            const btnText = saveBtn.querySelector('.save-text');
            
            if (result.saved) {
              btnIcon.className = "bi bi-bookmark-fill";
              saveBtn.classList.add("text-warning");
              if (btnText) btnText.textContent = "Saved";
              
              // Add subtle animation
              saveBtn.style.transform = 'scale(1.1)';
              setTimeout(() => saveBtn.style.transform = 'scale(1)', 200);
            } else {
              btnIcon.className = "bi bi-bookmark";
              saveBtn.classList.remove("text-warning");
              if (btnText) btnText.textContent = "Save";
            }
          });
          
          toast(result.saved ? "Post saved! " : "Post unsaved", result.saved ? 'success' : 'info');

          // Save state updated locally - no need to refresh entire feed
          updateNotificationBadge();
        } catch (err) {
          icon.className = originalClass;
          saveText.textContent = originalText;
          toast("Failed to save post: " + err.message);
        } finally {
          btn.disabled = false;
        }
      }

      function handleShare(postId) {
        const postUrl = `${window.location.origin}${window.location.pathname}#post-${postId}`;

        if (navigator.share) {
          navigator
            .share({
              title: "Check out this artwork on ArtHub",
              url: postUrl,
            })
            .then(() => {
              toast("Shared successfully!");
            })
            .catch(() => {
              fallbackShare(postUrl);
            });
        } else {
          fallbackShare(postUrl);
        }
      }

      function fallbackShare(url) {
        navigator.clipboard
          .writeText(url)
          .then(() => {
            toast("Link copied to clipboard!");
          })
          .catch(() => {
            toast("Share link: " + url);
          });
      }

      // Hook after DOM ready
      document.addEventListener("DOMContentLoaded", async () => {
        // Clear any demo mode data to ensure Firebase is used
        localStorage.removeItem("firebase_demo_mode");
        localStorage.removeItem("firebase_demo_config");
        [
          "demo_users",
          "demo_posts",
          "demo_comments",
          "demo_notifications",
        ].forEach((key) => {
          localStorage.removeItem(key);
        });

        // Wait for Firebase client to be ready
        let retries = 0;
        while (!initializeClient() && retries < 50) {
          await new Promise((resolve) => setTimeout(resolve, 100));
          retries++;
        }

        if (!artHubClient) {
          console.error(
            "Firebase client failed to initialize after",
            retries,
            "attempts"
          );
          toast("Application failed to initialize. Please refresh the page.");
          return;
        }

        loadAuth();
        authUI();
        updateStats();
        loadFeed();
        loadSuggestions();
        
        // Initialize enhanced comment system
        setTimeout(() => {
          initializeCommentInputs();
        }, 1000);
        loadTrendingTags(); // Load trending tags after client is ready
        loadPopularTags(); // Load popular tags after client is ready
        initializeSearchInput(); // Initialize search tag input functionality
        updateNotificationBadge(); // Update notification count on load

        // Restore last visited section or default to feed
        const lastSection =
          localStorage.getItem("arthub_current_section") || "feed";
        showSection(lastSection);

        // Initialize modals
        settingsModal = new bootstrap.Modal(
          document.getElementById("settingsModal")
        );
        notificationsPanel = new bootstrap.Offcanvas(
          document.getElementById("notificationsPanel")
        );
        commentsModal = new bootstrap.Modal(
          document.getElementById("commentsModal")
        );

        // Settings modal show/hide handlers
        document
          .getElementById("settingsModal")
          .addEventListener("show.bs.modal", function () {
            document.body.classList.add("settings-in-view");
            loadUserSettings();
          });

        document
          .getElementById("settingsModal")
          .addEventListener("hide.bs.modal", function () {
            document.body.classList.remove("settings-in-view");
          });

        // Navigation handlers
        document.addEventListener("click", function (e) {
          // Navigation clicks
          const navTarget = e.target.closest("[data-hub-nav]");
          if (navTarget) {
            e.preventDefault();
            const section = navTarget.getAttribute("data-hub-nav");

            // Check if user needs to be logged in for this section
            const restrictedSections = ["messages", "saved", "settings"];
            if (restrictedSections.includes(section) && !auth.user) {
              toast(
                "Please login or register to access " +
                  section.charAt(0).toUpperCase() +
                  section.slice(1)
              );
              openAuth("login");
              return;
            }

            // Update active nav state
            document
              .querySelectorAll("[data-hub-nav]")
              .forEach((nav) => nav.classList.remove("active"));
            navTarget.classList.add("active");

            // Show corresponding section
            showSection(section);
          }

          // Like button
          if (e.target.closest(".like-btn")) {
            e.preventDefault();
            if (!enforceAuthBefore()) return;

            const btn = e.target.closest(".like-btn");
            const postId = btn.getAttribute("data-post-id");
            handleLike(postId, btn);
          }

          // Comment button
          if (e.target.closest(".comment-btn")) {
            e.preventDefault();
            if (!enforceAuthBefore()) return;

            const btn = e.target.closest(".comment-btn");
            const postId = btn.getAttribute("data-post-id");
            loadComments(postId);
          }

          // Save button
          if (e.target.closest(".save-btn")) {
            e.preventDefault();
            if (!enforceAuthBefore()) return;

            const btn = e.target.closest(".save-btn");
            const postId = btn.getAttribute("data-post-id");
            handleSave(postId, btn);
          }

          // Notifications dropdown button
          if (e.target.closest("#notificationsBtn")) {
            if (!auth.user) {
              e.preventDefault();
              e.stopPropagation();
              toast("Please login or register to view notifications");
              openAuth("login");
              return;
            }
            // Load notifications when dropdown is opened
            loadNotifications();
          }

          // Mark all notifications as read
          if (e.target.closest("#markAllReadBtn")) {
            e.preventDefault();
            markAllNotificationsRead();
          }

          // Notifications dropdown button
          if (e.target.closest("#notificationsBtn")) {
            if (!auth.user) {
              e.preventDefault();
              e.stopPropagation();
              toast("Please login or register to view notifications");
              openAuth("login");
              return;
            }
            // Load notifications when dropdown is opened
            loadNotifications();
          }

          // Mark all notifications as read
          if (e.target.closest("#markAllReadBtn")) {
            e.preventDefault();
            markAllNotificationsRead();
          }

          // Share button
          if (e.target.closest(".share-btn")) {
            e.preventDefault();
            const btn = e.target.closest(".share-btn");
            const postId = btn.getAttribute("data-post-id");
            handleShare(postId);
          }
        });

        // Image upload and cropping system
        let selectedImages = [];
        let currentCropIndex = -1;
        let cropModal, imageCropModal;

        // Initialize modals
        imageCropModal = new bootstrap.Modal(
          document.getElementById("imageCropModal")
        );

        // Add drag and drop functionality to profile picture area
        const profilePicArea =
          document.getElementById("settingsProfilePic").parentElement;

        profilePicArea.addEventListener("dragover", function (e) {
          e.preventDefault();
          e.stopPropagation();
          this.style.backgroundColor = "#e3f2fd";
          this.style.transform = "scale(1.05)";
          this.style.transition = "all 0.3s ease";
        });

        profilePicArea.addEventListener("dragleave", function (e) {
          e.preventDefault();
          e.stopPropagation();
          this.style.backgroundColor = "";
          this.style.transform = "";
        });

        profilePicArea.addEventListener("drop", function (e) {
          e.preventDefault();
          e.stopPropagation();
          this.style.backgroundColor = "";
          this.style.transform = "";

          const files = Array.from(e.dataTransfer.files).filter((file) =>
            file.type.startsWith("image/")
          );
          if (files.length > 0) {
            handleImageFiles(files);
          } else {
            toast("Please drop only image files");
          }
        });

        // Helper function to handle image files
        function handleImageFiles(files) {
          // Validate file sizes
          const oversizedFiles = files.filter(
            (file) => file.size > 1024 * 1024
          );
          if (oversizedFiles.length > 0) {
            toast(
              `${oversizedFiles.length} image(s) too large. Please choose files under 5MB.`
            );
            return;
          }

          // Process each file
          files.forEach((file, index) => {
            const reader = new FileReader();
            reader.onload = function (e) {
              const imageData = {
                file: file,
                dataUrl: e.target.result,
                croppedDataUrl: null,
                name: file.name,
              };

              selectedImages.push(imageData);

              // If it's the first image, set as profile picture and open cropper
              if (selectedImages.length === 1) {
                openCropModal(e.target.result);
              } else {
                updateImagePreview();
              }
            };
            reader.readAsDataURL(file);
          });
        }

        // Enhanced profile picture upload with compression and cropping
        document
          .getElementById("profilePicInput")
          .addEventListener("change", function (e) {
            const files = Array.from(e.target.files);
            if (files.length === 0) return;

            handleProfilePictureUpload(files[0]); // Only handle first file for profile

            // Clear the input so same file can be selected again
            e.target.value = "";
          });
        
        async function handleProfilePictureUpload(file) {
          if (!file.type.startsWith('image/')) {
            toast('Please select an image file', 'error');
            return;
          }
          
          const maxSize = 1024 * 1024; // 1MB max for Firestore compatibility
          if (file.size > maxSize) {
            toast('Image is too large. Maximum size is 1MB due to Firestore limits', 'error');
            return;
          }
          
          const reader = new FileReader();
          reader.onload = async (e) => {
            const imageData = e.target.result;
            
            // Show cropping modal
            showProfileCropModal(imageData, file.name);
          };
          reader.readAsDataURL(file);
        }
        
        function showProfileCropModal(imageData, fileName) {
          // Create profile crop modal if not exists
          let modal = document.getElementById('profileCropModal');
          if (!modal) {
            modal = createProfileCropModal();
            document.body.appendChild(modal);
          }
          
          const img = modal.querySelector('#profileCropImage');
          const saveBtn = modal.querySelector('#saveProfileCrop');
          
          img.src = imageData;
          img.onload = () => initializeProfileCropper(img);
          
          saveBtn.onclick = () => saveProfilePicture(imageData);
          
          const modalInstance = new bootstrap.Modal(modal);
          modalInstance.show();
        }
        
        function createProfileCropModal() {
          const modalHTML = `
            <div class="modal fade" id="profileCropModal" tabindex="-1">
              <div class="modal-dialog modal-lg">
                <div class="modal-content">
                  <div class="modal-header">
                    <h5 class="modal-title">Crop Profile Picture</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                  </div>
                  <div class="modal-body text-center">
                    <div class="crop-container" style="max-height: 400px; overflow: hidden; position: relative; border: 2px dashed #007bff; border-radius: 10px; margin: 20px 0;">
                      <img id="profileCropImage" style="max-width: 100%; height: auto; border-radius: 8px;" />
                      <div class="crop-overlay" style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 200px; height: 200px; border: 3px solid #fff; border-radius: 50%; box-shadow: 0 0 0 9999px rgba(0,0,0,0.5); pointer-events: none;"></div>
                    </div>
                    <div class="crop-controls mt-3">
                      <div class="row">
                        <div class="col-md-6">
                          <label class="form-label">Size</label>
                          <input type="range" class="form-range" id="cropSize" min="100" max="300" value="200">
                        </div>
                        <div class="col-md-6">
                          <label class="form-label">Quality</label>
                          <select class="form-select" id="cropQuality">
                            <option value="0.9">High</option>
                            <option value="0.7" selected>Medium</option>
                            <option value="0.5">Low (Smaller file)</option>
                          </select>
                        </div>
                      </div>
                    </div>
                  </div>
                  <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="saveProfileCrop">Save & Upload</button>
                  </div>
                </div>
              </div>
            </div>
          `;
          const div = document.createElement('div');
          div.innerHTML = modalHTML;
          return div.firstElementChild;
        }
        
        function initializeProfileCropper(img) {
          const sizeSlider = document.getElementById('cropSize');
          const overlay = document.querySelector('.crop-overlay');
          
          sizeSlider.addEventListener('input', (e) => {
            const size = e.target.value;
            overlay.style.width = size + 'px';
            overlay.style.height = size + 'px';
          });
        }
        
        async function saveProfilePicture(originalImageData) {
          const modal = bootstrap.Modal.getInstance(document.getElementById('profileCropModal'));
          const saveBtn = document.getElementById('saveProfileCrop');
          const quality = parseFloat(document.getElementById('cropQuality').value);
          
          saveBtn.disabled = true;
          saveBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Processing...';
          
          try {
            // Compress the image aggressively to prevent size errors
            console.log(' Starting aggressive compression for profile picture...');
            const compressedImage = await window.firebaseArtHubClient.smartCompressImage(originalImageData, 400000); // Target 400KB max
            
            // Final size verification before upload
            const finalSize = window.firebaseArtHubClient.getDataUrlSize(compressedImage);
            console.log(' Final compressed size:', (finalSize / 1024).toFixed(1), 'KB');
            
            if (finalSize > 800000) { // 800KB safety limit for Firestore 1MB constraint
              console.log(' Image still too large, applying nuclear compression...');
              const nuclearCompressed = await window.firebaseArtHubClient.smartCompressImage(compressedImage, 300000);
              const nuclearSize = window.firebaseArtHubClient.getDataUrlSize(nuclearCompressed);
              console.log(' Nuclear compressed size:', (nuclearSize / 1024).toFixed(1), 'KB');
              
              // Update profile picture with nuclear compressed version
              await window.firebaseArtHubClient.updateUserProfile({ 
                profile_picture: nuclearCompressed 
              });
            } else {
              // Update profile picture with regular compressed version
              await window.firebaseArtHubClient.updateUserProfile({ 
                profile_picture: compressedImage 
              });
            }
            
            // Update UI
            const profileAvatar = document.getElementById('profileAvatar');
            const createPostAvatar = document.getElementById('createPostAvatar');
            const settingsProfilePic = document.getElementById('settingsProfilePic');
            
            if (profileAvatar) profileAvatar.src = compressedImage;
            if (createPostAvatar) createPostAvatar.src = compressedImage;
            if (settingsProfilePic) settingsProfilePic.src = compressedImage;
            
            toast('Profile picture updated successfully!', 'success');
            modal.hide();
            
          } catch (error) {
            console.error('Profile picture update error:', error);
            toast('Failed to update profile picture: ' + error.message, 'error');
          } finally {
            saveBtn.disabled = false;
            saveBtn.innerHTML = 'Save & Upload';
          }
        }

        function openImageCropper(imageIndex) {
          if (imageIndex < 0 || imageIndex >= selectedImages.length) return;

          currentCropIndex = imageIndex;
          const imageData = selectedImages[imageIndex];

          const cropImage = document.getElementById("cropImage");
          cropImage.src = imageData.dataUrl;

          imageCropModal.show();

          // Initialize simple crop area simulation
          setTimeout(() => {
            initializeCropper(cropImage);
          }, 300);
        }

        function initializeCropper(img) {
          // Enhanced cropper simulation with visual feedback
          img.style.cursor = "crosshair";
          img.style.maxWidth = "100%";
          img.style.height = "auto";
          img.style.border = "2px dashed #007bff";
          img.style.borderRadius = "8px";
          img.style.padding = "10px";
          img.title = "Use the controls below to adjust your image";

          // Add crop overlay simulation
          const container = img.parentElement;
          container.style.position = "relative";

          // Create crop info overlay
          let cropInfo = container.querySelector(".crop-info");
          if (!cropInfo) {
            cropInfo = document.createElement("div");
            cropInfo.className = "crop-info";
            cropInfo.style.cssText = `
            position: absolute;
            top: 10px;
            left: 10px;
            background: rgba(0,0,0,0.7);
            color: white;
            padding: 5px 10px;
            border-radius: 4px;
            font-size: 12px;
            pointer-events: none;
          `;
            cropInfo.textContent = "Use controls below to adjust image";
            container.appendChild(cropInfo);
          }
        }

        function updateImagePreview() {
          const container = document.getElementById("imagePreviewContainer");
          const section = document.getElementById("imagePreviewSection");

          if (selectedImages.length === 0) {
            section.style.display = "none";
            return;
          }

          section.style.display = "block";

          container.innerHTML = selectedImages
            .map(
              (img, index) => `
          <div class="col-md-3 col-sm-4 col-6">
            <div class="image-preview-item">
              <img src="${img.croppedDataUrl || img.dataUrl}" alt="Preview ${
                index + 1
              }">
              <div class="image-preview-overlay">
                <div class="btn-group-vertical">
                  <button type="button" class="btn btn-sm btn-light" onclick="openImageCropper(${index})">
                    <i class="bi bi-crop"></i>
                  </button>
                  <button type="button" class="btn btn-sm btn-danger" onclick="removeImage(${index})">
                    <i class="bi bi-trash"></i>
                  </button>
                </div>
              </div>
            </div>
          </div>
        `
            )
            .join("");

          // Update profile picture with first image
          if (selectedImages.length > 0) {
            const firstImage = selectedImages[0];
            document.getElementById("settingsProfilePic").src =
              firstImage.croppedDataUrl || firstImage.dataUrl;
            pendingProfilePicture =
              firstImage.croppedDataUrl || firstImage.dataUrl;
          }
        }

        function removeImage(index) {
          selectedImages.splice(index, 1);
          updateImagePreview();

          if (selectedImages.length === 0) {
            pendingProfilePicture = null;
            document.getElementById("settingsProfilePic").src =
              "https://placehold.co/120x120";
          }
        }

        // Clear all images
        document
          .getElementById("clearAllImages")
          .addEventListener("click", function () {
            selectedImages = [];
            pendingProfilePicture = null;
            document.getElementById("settingsProfilePic").src =
              "https://placehold.co/120x120";
            updateImagePreview();
            toast("All images cleared");
          });

        // Crop modal controls
        document
          .getElementById("cropSave")
          .addEventListener("click", function () {
            if (
              currentCropIndex >= 0 &&
              currentCropIndex < selectedImages.length
            ) {
              // In a real implementation, you'd get the cropped image data here
              // For now, we'll just use the original image
              const imageData = selectedImages[currentCropIndex];
              imageData.croppedDataUrl = imageData.dataUrl; // Simplified - would be actual cropped data

              updateImagePreview();
              imageCropModal.hide();
              toast("Image cropped successfully!");
            }
          });

        document
          .getElementById("cropReset")
          .addEventListener("click", function () {
            const cropImage = document.getElementById("cropImage");
            if (currentCropIndex >= 0) {
              cropImage.src = selectedImages[currentCropIndex].dataUrl;
              toast("Crop reset");
            }
          });

        document
          .getElementById("cropRotateLeft")
          .addEventListener("click", function () {
            const cropImage = document.getElementById("cropImage");
            cropImage.style.transform =
              (cropImage.style.transform || "") + " rotate(-90deg)";
          });

        document
          .getElementById("cropRotateRight")
          .addEventListener("click", function () {
            const cropImage = document.getElementById("cropImage");
            cropImage.style.transform =
              (cropImage.style.transform || "") + " rotate(90deg)";
          });

        // Make functions globally available
        window.openImageCropper = openImageCropper;
        window.removeImage = removeImage;

        // Save settings
        document
          .getElementById("saveSettings")
          .addEventListener("click", async function () {
            if (!auth.user) {
              toast("Please login to save settings");
              return;
            }

            const saveButton = this;
            const originalText = saveButton.innerHTML;

            try {
              // Show loading state
              saveButton.disabled = true;
              saveButton.innerHTML =
                '<span class="spinner-border spinner-border-sm me-2"></span>Saving...';

              const updates = {};
              let hasUpdates = false;

              // Form validation
              const usernameField = document.getElementById("settingsUsername");
              const emailField = document.getElementById("settingsEmail");

              // Validate username
              if (usernameField && usernameField.value.trim()) {
                const username = usernameField.value.trim();
                if (username.length < 3) {
                  throw new Error(
                    "Username must be at least 3 characters long"
                  );
                }
                if (!/^[a-zA-Z0-9_]+$/.test(username)) {
                  throw new Error(
                    "Username can only contain letters, numbers, and underscores"
                  );
                }
                if (username !== auth.user.username) {
                  updates.username = username;
                  hasUpdates = true;
                }
              }

              // Validate email
              if (emailField && emailField.value.trim()) {
                const email = emailField.value.trim();
                const emailPattern = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                if (!emailPattern.test(email)) {
                  throw new Error("Please enter a valid email address");
                }
                if (email !== auth.user.email) {
                  updates.email = email;
                  hasUpdates = true;
                }
              }

              // Check for profile picture update
              if (pendingProfilePicture) {
                updates.profile_picture = pendingProfilePicture;
                hasUpdates = true;
              }

              // Check for other settings updates
              const privacyField = document.getElementById("settingPrivacy");
              const notificationsField = document.getElementById(
                "settingNotifications"
              );
              const autoplayField = document.getElementById("settingAutoplay");

              if (
                privacyField &&
                privacyField.value !== (auth.user.privacy || "public")
              ) {
                updates.privacy = privacyField.value;
                hasUpdates = true;
              }
              if (
                notificationsField &&
                notificationsField.checked !==
                  (auth.user.notifications !== false)
              ) {
                updates.notifications = notificationsField.checked;
                hasUpdates = true;
              }
              if (
                autoplayField &&
                autoplayField.checked !== (auth.user.autoplay === true)
              ) {
                updates.autoplay = autoplayField.checked;
                hasUpdates = true;
              }

              if (!hasUpdates) {
                toast("No changes to save", "info");
                return;
              }

              // Update profile via Firebase
              await window.firebaseArtHubClient.updateUserProfile(updates);

              // Update local auth
              auth.user = window.firebaseArtHubClient.getCurrentUser();
              saveAuth();

              // Clear selected images and reset profile picture reference
              selectedImages = [];
              pendingProfilePicture = null;
              updateImagePreview();

              toast("Settings updated successfully!", "success");
              settingsModal.hide();
              updateStats(); // Refresh profile avatar
            } catch (err) {
              console.error("Failed to save settings:", err);
              toast("Failed to save settings: " + err.message, "error");
            } finally {
              // Restore button state
              saveButton.disabled = false;
              saveButton.innerHTML = originalText;
            }
          });

        // Post comment
        document
          .getElementById("postCommentBtn")
          .addEventListener("click", async function () {
            if (!enforceAuthBefore()) return;

            const commentText = document.getElementById("commentText");
            const text = commentText.value.trim();

            if (!text) {
              toast("Please enter a comment");
              return;
            }

            const btn = this;
            btn.disabled = true;
            btn.innerHTML =
              '<span class="spinner-border spinner-border-sm me-2"></span>Posting...';

            try {
              await window.firebaseArtHubClient.addComment(currentPostId, text);
              commentText.value = "";
              toast("Comment posted!");

              // Update comment counters across all instances of this post
              const allCommentBtns = document.querySelectorAll(`[data-post-id="${currentPostId}"].comment-btn`);
              allCommentBtns.forEach(commentBtn => {
                const countEl = commentBtn.querySelector('.comment-count');
                if (countEl) {
                  const currentCount = parseInt(countEl.textContent || '0');
                  countEl.textContent = currentCount + 1;
                }
              });
              
              // Update "View all X comments" text
              const allViewCommentsBtns = document.querySelectorAll(`[data-post-id="${currentPostId}"].view-all-comments-btn, [data-post-id="${currentPostId}"].view-more-comments-btn`);
              allViewCommentsBtns.forEach(viewBtn => {
                const currentText = viewBtn.textContent;
                const match = currentText.match(/(\d+)/);
                if (match) {
                  const count = parseInt(match[1]) + 1;
                  viewBtn.textContent = currentText.replace(match[1], count);
                }
              });
              
              // Reload comments to show the new one
              setTimeout(() => loadComments(currentPostId), 500);
            } catch (err) {
              toast("Failed to post comment: " + err.message);
            } finally {
              btn.disabled = false;
              btn.innerHTML = '<i class="bi bi-send me-1"></i> Post';
            }
          });

        // Mark all notifications handler is already implemented above with Firebase

        // Handle notifications dropdown
        const notificationsDropdown = document.getElementById(
          "notificationsDropdown"
        );
        const notificationsBtn = document.getElementById("notificationsBtn");

        // Show/hide notifications dropdown based on auth state
        function updateNotificationsVisibility() {
          if (auth.user) {
            notificationsDropdown.style.display = "block";
            loadNotifications();
          } else {
            notificationsDropdown.style.display = "none";
          }
        }

        // Load notifications when dropdown is opened
        notificationsBtn.addEventListener("click", function () {
          if (auth.user) {
            loadNotifications();
          }
        });

        // Mark all notifications as read
        document
          .getElementById("markAllReadBtn")
          .addEventListener("click", async function () {
            if (!auth.user) return;

            try {
              // Mark all as read in Firebase (implement this method in firebase-config.js if needed)
              document
                .querySelectorAll(".notification-dropdown-item")
                .forEach((item) => {
                  item.classList.remove("unread");
                });
              updateNotificationBadge();
              toast("All notifications marked as read");
            } catch (err) {
              toast("Failed to mark notifications as read");
            }
          });

        // Initial notification visibility update
        updateNotificationsVisibility();

        // Poll for new notifications every 30 seconds if logged in
        setInterval(() => {
          if (auth.user) {
            loadNotifications();
          }
        }, 30000);

        document
          .getElementById("quickCreateBtn")
          ?.addEventListener("click", () => {
            window.scrollTo({ top: 0, behavior: "smart" });
            postText.focus();
          });
        document.getElementById("fabNew")?.addEventListener("click", () => {
          window.scrollTo({ top: 0, behavior: "smooth" });
          postText.focus();
        });

        // Initialize EmailJS with enhanced debugging
        if (typeof emailjs !== "undefined") {
          try {
            emailjs.init("ntVIBn827dqCczAkn"); // EmailJS public key
            console.log(" EmailJS initialized successfully");
            console.log(" EmailJS service details:", {
              serviceId: "service_7apbhjx",
              templateId: "template_nv9s6ro",
              publicKey: "ntVIBn827dqCczAkn",
              version: "Available"
            });
            
            // Test EmailJS connection (optional - for debugging)
            window.testEmailJSConnection = async function() {
              try {
                console.log(" Testing EmailJS connection...");
                // This is a minimal test - doesn't actually send an email
                const testResult = await emailjs.send("service_7apbhjx", "template_nv9s6ro", {
                  email: "test@example.com",
                  user_name: "Test User",
                  verification_code: "123456",
                  app_name: "ArtHub Test",
                });
                console.log(" EmailJS connection test successful:", testResult);
                return true;
              } catch (error) {
                console.error(" EmailJS connection test failed:", error);
                return false;
              }
            };
            
          } catch (error) {
            console.error(" EmailJS initialization failed:", error);
          }
        } else {
          console.error(" EmailJS script not loaded - check network connection");
          console.log(" Tip: Refresh the page to reload EmailJS service");
        }

        // Profile Picture Cropping System
        let cropImageData = null;
        let cropSelection = { x: 0, y: 0, width: 0, height: 0 };
        let isDragging = false;
        let dragStart = { x: 0, y: 0 };
        
        function initializeProfileCropping() {
          const cropCanvas = document.getElementById('cropCanvas');
          const applyCropBtn = document.getElementById('applyCropBtn');
          const cropModal = document.getElementById('cropModal');
          
          if (!cropCanvas) return;
          
          const ctx = cropCanvas.getContext('2d');
          
          // Canvas event listeners for crop selection
          cropCanvas.addEventListener('mousedown', (e) => {
            const rect = cropCanvas.getBoundingClientRect();
            dragStart.x = e.clientX - rect.left;
            dragStart.y = e.clientY - rect.top;
            isDragging = true;
            cropSelection.x = dragStart.x;
            cropSelection.y = dragStart.y;
            cropSelection.width = 0;
            cropSelection.height = 0;
          });
          
          cropCanvas.addEventListener('mousemove', (e) => {
            if (!isDragging) return;
            
            const rect = cropCanvas.getBoundingClientRect();
            const currentX = e.clientX - rect.left;
            const currentY = e.clientY - rect.top;
            
            cropSelection.width = currentX - dragStart.x;
            cropSelection.height = currentY - dragStart.y;
            
            // Redraw the image with crop overlay
            drawCropPreview();
          });
          
          cropCanvas.addEventListener('mouseup', () => {
            isDragging = false;
            // Ensure positive dimensions
            if (cropSelection.width < 0) {
              cropSelection.x += cropSelection.width;
              cropSelection.width = Math.abs(cropSelection.width);
            }
            if (cropSelection.height < 0) {
              cropSelection.y += cropSelection.height;
              cropSelection.height = Math.abs(cropSelection.height);
            }
          });
          
          // Apply crop button
          if (applyCropBtn) {
            applyCropBtn.addEventListener('click', async () => {
              if (!cropImageData || cropSelection.width === 0 || cropSelection.height === 0) {
                toast('Please select an area to crop', 'warning');
                return;
              }
              
              try {
                applyCropBtn.disabled = true;
                applyCropBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Cropping...';
                
                const croppedDataUrl = await applyCropToImage();
                
                // Update Firebase with the cropped profile picture
                try {
                  await window.firebaseArtHubClient.updateUserProfile({
                    profile_picture: croppedDataUrl,
                  });

                  // Update the current avatar preview in settings
                  const currentAvatar = document.getElementById('currentAvatar');
                  if (currentAvatar) {
                    currentAvatar.src = croppedDataUrl;
                  }

                  // Refresh auth state
                  auth.user = window.firebaseArtHubClient.getCurrentUser();

                  // Update all avatars in the UI
                  updateAvatarsInUI(croppedDataUrl);

                  // Close crop modal
                  const cropModalInstance = bootstrap.Modal.getInstance(cropModal);
                  cropModalInstance.hide();
                  
                  toast('Profile picture updated successfully!', 'success');
                  
                } catch (error) {
                  console.error('Failed to save cropped profile picture:', error);
                  toast('Failed to save profile picture: ' + error.message, 'error');
                }
                
              } catch (error) {
                console.error('Crop error:', error);
                toast('Failed to crop image: ' + error.message, 'error');
              } finally {
                applyCropBtn.disabled = false;
                applyCropBtn.innerHTML = 'Apply Crop';
              }
            });
          }
        }
        
        function openCropModal(imageDataUrl) {
          cropImageData = imageDataUrl;
          const cropCanvas = document.getElementById('cropCanvas');
          const cropModal = new bootstrap.Modal(document.getElementById('cropModal'));
          
          if (!cropCanvas) return;
          
          const ctx = cropCanvas.getContext('2d');
          const img = new Image();
          
          img.onload = () => {
            // Set canvas size to fit the image
            const maxWidth = 600;
            const maxHeight = 400;
            let { width, height } = img;
            
            if (width > maxWidth) {
              height = (height * maxWidth) / width;
              width = maxWidth;
            }
            if (height > maxHeight) {
              width = (width * maxHeight) / height;
              height = maxHeight;
            }
            
            cropCanvas.width = width;
            cropCanvas.height = height;
            
            // Draw the image
            ctx.drawImage(img, 0, 0, width, height);
            
            // Reset crop selection
            cropSelection = { x: 0, y: 0, width: 0, height: 0 };
            
            cropModal.show();
          };
          
          img.src = imageDataUrl;
        }
        
        function drawCropPreview() {
          const cropCanvas = document.getElementById('cropCanvas');
          const ctx = cropCanvas.getContext('2d');
          
          if (!cropImageData) return;
          
          const img = new Image();
          img.onload = () => {
            // Clear and redraw image
            ctx.clearRect(0, 0, cropCanvas.width, cropCanvas.height);
            ctx.drawImage(img, 0, 0, cropCanvas.width, cropCanvas.height);
            
            // Draw crop overlay
            if (cropSelection.width !== 0 && cropSelection.height !== 0) {
              // Darken everything except crop area
              ctx.fillStyle = 'rgba(0, 0, 0, 0.5)';
              ctx.fillRect(0, 0, cropCanvas.width, cropCanvas.height);
              
              // Clear the crop area
              ctx.globalCompositeOperation = 'destination-out';
              ctx.fillRect(cropSelection.x, cropSelection.y, cropSelection.width, cropSelection.height);
              
              // Draw crop border
              ctx.globalCompositeOperation = 'source-over';
              ctx.strokeStyle = '#007bff';
              ctx.lineWidth = 2;
              ctx.strokeRect(cropSelection.x, cropSelection.y, cropSelection.width, cropSelection.height);
            }
          };
          
          img.src = cropImageData;
        }
        
        async function applyCropToImage() {
          const cropCanvas = document.getElementById('cropCanvas');
          const ctx = cropCanvas.getContext('2d');
          
          return new Promise((resolve) => {
            const img = new Image();
            img.onload = async () => {
              // Create a new canvas for the cropped image
              const croppedCanvas = document.createElement('canvas');
              const croppedCtx = croppedCanvas.getContext('2d');
              
              // Calculate scale factors
              const scaleX = img.width / cropCanvas.width;
              const scaleY = img.height / cropCanvas.height;
              
              // Set cropped canvas size (square for profile picture)
              const cropSize = Math.min(cropSelection.width, cropSelection.height);
              croppedCanvas.width = 300; // Fixed size for profile pictures
              croppedCanvas.height = 300;
              
              // Calculate source coordinates
              const sourceX = cropSelection.x * scaleX;
              const sourceY = cropSelection.y * scaleY;
              const sourceSize = cropSize * Math.max(scaleX, scaleY);
              
              // Draw the cropped and resized image
              croppedCtx.drawImage(
                img,
                sourceX, sourceY, sourceSize, sourceSize,
                0, 0, 300, 300
              );
              
              // Get data URL and compress if needed
              let dataUrl = croppedCanvas.toDataURL('image/jpeg', 0.8);
              
              // Ensure it's under 800KB for Firestore safety
              let quality = 0.8;
              while (dataUrl.length > 800000 && quality > 0.1) {
                quality -= 0.1;
                dataUrl = croppedCanvas.toDataURL('image/jpeg', quality);
              }
              
              resolve(dataUrl);
            };
            
            img.src = cropImageData;
          });
        }
        
        // Initialize cropping when page loads
        document.addEventListener('DOMContentLoaded', () => {
          initializeProfileCropping();
        });
        
        // Add real-time validation to prevent EmailJS issues
        function initializeFormValidation() {
          // Username validation
          const usernameInput = document.getElementById('regUsername');
          const usernameError = document.getElementById('usernameError');
          
          if (usernameInput && usernameError) {
            usernameInput.addEventListener('input', function() {
              const username = this.value;
              const sanitized = sanitizeUsernameForEmail(username);
              
              // Check if username was modified during sanitization
              if (username !== sanitized && username.length > 0) {
                this.classList.add('is-invalid');
                usernameError.style.display = 'block';
                usernameError.textContent = `Username contains problematic characters. Suggested: "${sanitized}"`;
              } else {
                this.classList.remove('is-invalid');
                usernameError.style.display = 'none';
              }
            });
            
            usernameInput.addEventListener('blur', function() {
              const username = this.value;
              const sanitized = sanitizeUsernameForEmail(username);
              
              if (username !== sanitized && sanitized.length > 0) {
                this.value = sanitized;
                this.classList.remove('is-invalid');
                usernameError.style.display = 'none';
                toast('Username was automatically cleaned for compatibility', 'info');
              }
            });
          }
          
          // Email validation
          const emailInput = document.getElementById('regEmail');
          const emailError = document.getElementById('emailError');
          
          if (emailInput && emailError) {
            emailInput.addEventListener('input', function() {
              const email = this.value;
              const sanitized = sanitizeEmailForEmailJS(email);
              
              // Check if email is valid and matches sanitized version
              const emailRegex = /^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$/;
              
              if (email.length > 0 && (!emailRegex.test(email) || email !== sanitized)) {
                this.classList.add('is-invalid');
                emailError.style.display = 'block';
                if (email !== sanitized) {
                  emailError.textContent = `Email contains problematic characters. Suggested: "${sanitized}"`;
                } else {
                  emailError.textContent = 'Please enter a valid email address (e.g., user@example.com)';
                }
              } else {
                this.classList.remove('is-invalid');
                emailError.style.display = 'none';
              }
            });
            
            emailInput.addEventListener('blur', function() {
              const email = this.value;
              const sanitized = sanitizeEmailForEmailJS(email);
              
              // Auto-correct email if needed (be careful with this)
              if (email !== sanitized && sanitized !== 'user@example.com') {
                this.value = sanitized;
                this.classList.remove('is-invalid');
                emailError.style.display = 'none';
                toast('Email was automatically cleaned for compatibility', 'info');
              }
            });
          }
        }
        
        // Initialize form validation when page loads
        initializeFormValidation();

        // Initialize reCAPTCHA when auth modal is shown
        let recaptchaInitialized = false;
        
        // Get appropriate reCAPTCHA v3 site key based on environment
        function getRecaptchaSiteKey() {
          const hostname = window.location.hostname;
          
          // Production key for Firebase Hosting domain (reCAPTCHA v3)
          if (hostname === 'arthub-c46b2.web.app' || hostname === 'arthub-c46b2.firebaseapp.com') {
            console.log(' Using reCAPTCHA v3 production key for:', hostname);
            return "6LdvxdgrAAAAAIcCXPLCipQV819ARwiuwys2fiq2";
          }
          
          // For localhost, still use test key (reCAPTCHA v2 test key for development)
          console.log(' Using reCAPTCHA v2 test key for development:', hostname);
          return "6LeIxAcTAAAAAJcZVRqyHh71UMIEGNQ_MXjiZKhI"; // Google's test key
        }

        // Initialize reCAPTCHA v3 when page loads
        function initializeRecaptcha() {
          if (typeof grecaptcha !== 'undefined') {
            const hostname = window.location.hostname;
            
            // For production domains, use v3
            if (hostname === 'arthub-c46b2.web.app' || hostname === 'arthub-c46b2.firebaseapp.com') {
              console.log(' Initializing reCAPTCHA v3 for production');
              grecaptcha.ready(function() {
                console.log(' reCAPTCHA v3 ready');
                // Hide the container since v3 doesn't need visible element
                const container = document.getElementById('recaptcha-container');
                if (container) {
                  container.style.display = 'none';
                }
              });
            } else {
              // For localhost/development, use v2 test implementation
              console.log(' Setting up reCAPTCHA v2 test for development');
              document.getElementById("authModal").addEventListener("shown.bs.modal", function () {
                if (!recaptchaInitialized && typeof grecaptcha !== "undefined") {
                  try {
                    grecaptcha.render("recaptcha-container", {
                      sitekey: "6LeIxAcTAAAAAJcZVRqyHh71UMIEGNQ_MXjiZKhI",
                      theme: "light",
                      size: "normal"
                    });
                    recaptchaInitialized = true;
                    console.log(' reCAPTCHA v2 test initialized');
                  } catch (error) {
                    console.error(' reCAPTCHA v2 test initialization failed:', error);
                  }
                }
              });
            }
          } else {
            console.warn(' reCAPTCHA script not loaded yet, retrying...');
            setTimeout(initializeRecaptcha, 1000);
          }
        }
        
        // Initialize when DOM is ready
        if (document.readyState === 'loading') {
          document.addEventListener('DOMContentLoaded', initializeRecaptcha);
        } else {
          initializeRecaptcha();
        }

        // Resend verification code with countdown
        let resendCountdown = 0;
        let countdownInterval;

        // Using main startResendCountdown() function defined above

        // Duplicate resend handler removed - using main resendVerificationCode() function

        // Username change handler
        document
          .getElementById("changeUsernameBtn")
          ?.addEventListener("click", async function () {
            const newUsername = document
              .getElementById("settingUsername")
              .value.trim();
            if (!newUsername) {
              toast("Please enter a new username", "error");
              return;
            }

            if (newUsername === auth.user.username) {
              toast("This is already your current username", "warning");
              return;
            }

            if (!checkUsernameCooldown()) {
              toast("Username change is on cooldown", "error");
              return;
            }

            try {
              await window.firebaseArtHubClient.changeUsername(newUsername);
              toast("Username changed successfully!", "success");
              auth.user.username = newUsername;
              auth.user.lastUsernameChange = new Date().toISOString();
              saveAuth();
              loadUserSettings(); // Refresh settings
            } catch (error) {
              toast("Failed to change username: " + error.message, "error");
            }
          });

        // Password change handler
        document
          .getElementById("changePasswordBtn")
          ?.addEventListener("click", async function () {
            const currentPassword = document
              .getElementById("currentPassword")
              .value.trim();
            const newPassword = document
              .getElementById("newPassword")
              .value.trim();
            const confirmPassword = document
              .getElementById("confirmNewPassword")
              .value.trim();

            if (!currentPassword || !newPassword || !confirmPassword) {
              toast("Please fill all password fields", "error");
              return;
            }

            if (newPassword !== confirmPassword) {
              toast("New passwords do not match", "error");
              return;
            }

            if (newPassword.length < 8) {
              toast("Password must be at least 8 characters long", "error");
              return;
            }

            if (!/\d/.test(newPassword)) {
              toast("Password must contain at least one number", "error");
              return;
            }

            try {
              await window.firebaseArtHubClient.changePassword(
                currentPassword,
                newPassword
              );
              toast("Password changed successfully!", "success");
              // Clear password fields
              document.getElementById("currentPassword").value = "";
              document.getElementById("newPassword").value = "";
              document.getElementById("confirmNewPassword").value = "";
            } catch (error) {
              toast("Failed to change password: " + error.message, "error");
            }
          });

        // Clear aliases handler
        document
          .getElementById("clearAliasesBtn")
          ?.addEventListener("click", async function () {
            if (
              !confirm(
                "Are you sure you want to clear all previous usernames? This action cannot be undone."
              )
            ) {
              return;
            }

            try {
              await window.firebaseArtHubClient.clearUserAliases();
              toast("Previous usernames cleared", "success");
              updateAliasDisplay([]);
            } catch (error) {
              toast("Failed to clear aliases: " + error.message, "error");
            }
          });
          
          // Initialize NSFW blur on page load
          setTimeout(() => {
            initializeNSFWBlur();
          }, 1000);
      });
      
      // Mobile-specific enhancements
      document.addEventListener('DOMContentLoaded', function() {
        // Detect mobile device
        const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
        
        if (isMobile) {
          // Add mobile class to body
          document.body.classList.add('mobile-device');
          
          // Prevent double-tap zoom on buttons
          const buttons = document.querySelectorAll('button, .btn, .icon-btn');
          buttons.forEach(button => {
            button.addEventListener('touchend', function(e) {
              e.preventDefault();
              this.click();
            });
          });
          
          // Improve scroll performance
          document.addEventListener('scroll', function() {
            // Throttle scroll events for better performance
          }, { passive: true });
          
          // Handle orientation change
          window.addEventListener('orientationchange', function() {
            setTimeout(function() {
              // Recalculate layouts after orientation change
              window.scrollTo(0, window.scrollY);
            }, 100);
          });
          
          // Improve touch feedback for post cards
          const postCards = document.querySelectorAll('.post-card');
          postCards.forEach(card => {
            card.addEventListener('touchstart', function() {
              this.style.transform = 'scale(0.98)';
            }, { passive: true });
            
            card.addEventListener('touchend', function() {
              this.style.transform = 'scale(1)';
            }, { passive: true });
          });
          
          // Mobile-optimized image loading
          const images = document.querySelectorAll('.post-image');
          images.forEach(img => {
            img.setAttribute('loading', 'lazy');
          });
          
          // Optimize modal display on mobile
          const modals = document.querySelectorAll('.modal');
          modals.forEach(modal => {
            modal.addEventListener('shown.bs.modal', function() {
              // Prevent body scroll when modal is open
              document.body.style.overflow = 'hidden';
            });
            
            modal.addEventListener('hidden.bs.modal', function() {
              // Restore body scroll when modal is closed
              document.body.style.overflow = 'auto';
            });
          });
        }
        
        // Add swipe gestures for mobile navigation
        let touchStartX = 0;
        let touchStartY = 0;
        
        document.addEventListener('touchstart', function(e) {
          touchStartX = e.touches[0].clientX;
          touchStartY = e.touches[0].clientY;
        }, { passive: true });
        
        document.addEventListener('touchmove', function(e) {
          if (!touchStartX || !touchStartY) return;
          
          const touchEndX = e.touches[0].clientX;
          const touchEndY = e.touches[0].clientY;
          
          const deltaX = touchStartX - touchEndX;
          const deltaY = touchStartY - touchEndY;
          
          // Horizontal swipe detection
          if (Math.abs(deltaX) > Math.abs(deltaY) && Math.abs(deltaX) > 50) {
            if (deltaX > 0) {
              // Swipe left - could trigger actions
            } else {
              // Swipe right - could trigger actions
            }
          }
        }, { passive: true });
        
        // NSFW toggle functionality
        const nsfwArrow = document.getElementById('nsfwToggleArrow');
        const nsfwContainer = document.getElementById('nsfwContainer');
        
        if (nsfwArrow && nsfwContainer) {
          nsfwArrow.addEventListener('click', function() {
            const isExpanded = nsfwContainer.classList.contains('show');
            
            if (isExpanded) {
              // Collapse
              nsfwContainer.classList.remove('show');
              nsfwArrow.classList.remove('expanded');
              nsfwArrow.innerHTML = '<i class="bi bi-chevron-right"></i>';
            } else {
              // Expand
              nsfwContainer.classList.add('show');
              nsfwArrow.classList.add('expanded');
              nsfwArrow.innerHTML = '<i class="bi bi-chevron-down"></i>';
            }
          });
        }
      });
    </script>

    <!-- Profile Picture Crop Modal -->
    <div class="modal fade" id="cropModal" tabindex="-1">
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Crop Profile Picture</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body text-center">
            <div class="crop-container" style="max-height: 400px; overflow: hidden; position: relative; background: #f8f9fa; border: 2px dashed #dee2e6; border-radius: 10px;">
              <canvas id="cropCanvas" style="max-width: 100%; max-height: 400px; cursor: crosshair;"></canvas>
            </div>
            <div class="mt-3">
              <small class="text-muted">Click and drag to select the area to crop. The image will be automatically compressed to under 1MB.</small>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
            <button type="button" class="btn btn-primary" id="applyCropBtn">Apply Crop</button>
          </div>
        </div>
      </div>
    </div>
  </body>
</html>
